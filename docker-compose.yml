services:
  app:
    build: .
    container_name: cos-app
    depends_on:
      mysql:
        condition: service_healthy
    env_file:
      - .env
    environment:
      SPRING_DATASOURCE_URL: ${SPRING_DATASOURCE_URL:-jdbc:mysql://mysql:3306/cos?useSSL=false&serverTimezone=UTC&allowPublicKeyRetrieval=true}
      SPRING_DATASOURCE_USERNAME: ${SPRING_DATASOURCE_USERNAME:-cos}
      SPRING_DATASOURCE_PASSWORD: ${SPRING_DATASOURCE_PASSWORD:-cos123}
      KAKAO_CLIENT_ID: ${KAKAO_CLIENT_ID:-}
      KAKAO_CLIENT_SECRET: ${KAKAO_CLIENT_SECRET:-}
      NAVER_CLIENT_ID: ${NAVER_CLIENT_ID:-}
      NAVER_CLIENT_SECRET: ${NAVER_CLIENT_SECRET:-}
      TOSS_CLIENT_KEY: ${TOSS_CLIENT_KEY:-}
      TOSS_SECRET_KEY: ${TOSS_SECRET_KEY:-}
      SPRING_DOCKER_COMPOSE_ENABLED: 'false'
    ports:
      - "8080:8080"
    restart: unless-stopped
    networks:
      - backend

  mysql:
    image: mysql:8.4
    container_name: cos-mysql
    ports:
      - "13306:3306"
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: cos
      MYSQL_USER: cos
      MYSQL_PASSWORD: cos123
    command: --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
    volumes:
      - mysql-data:/var/lib/mysql
    healthcheck:
      test: [ "CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-proot" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - backend

  prometheus:
    image: prom/prometheus:latest
    container_name: cos-prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: unless-stopped
    networks:
      - backend

  grafana:
    image: grafana/grafana:11.3.0
    container_name: cos-grafana
    ports:
      - "3000:3000"
    volumes:
      - grafana-data:/var/lib/grafana
      - ./grafana-snapshots:/var/lib/grafana/snapshots
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_SNAPSHOTS_ENABLED=true
      - GF_SNAPSHOTS_LOCAL_MODE=true
      - GF_SNAPSHOTS_PUBLIC_MODE=true
      # 렌더 설정 (Grafana -> Renderer)
      - GF_RENDERING_SERVER_URL=http://renderer:8081/render
      # Renderer가 완료 후 Grafana로 콜백할 주소 (도커 네트워크 내부 주소)
      - GF_RENDERING_CALLBACK_URL=http://grafana:3000/
      # (선택) 렌더 로그 보기 좋게
      - GF_LOG_FILTERS=rendering:debug
    depends_on:
      - prometheus
    restart: unless-stopped
    networks:
      - backend

  renderer:
    image: grafana/grafana-image-renderer:latest
    container_name: cos-grafana-renderer
    environment:
       - ENABLE_METRICS=true
    ports:
        - "8081:8081"

volumes:
  mysql-data:
  prometheus-data:
  grafana-data:

networks:
  backend:
