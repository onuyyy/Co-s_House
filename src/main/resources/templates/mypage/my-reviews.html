<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‚´ê°€ ì‘ì„±í•œ ë¦¬ë·° - ì½”ë”©ì˜ ì§‘</title>
    <link rel="stylesheet" th:href="@{/css/main/header.css}">
    <link rel="stylesheet" th:href="@{/css/app.css}">
    <link rel="stylesheet" th:href="@{/css/question/question-list.css}">
    <style>
        .review-image-preview {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }
        .review-image-preview img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 4px;
            border: 1px solid #e0e0e0;
        }
        .review-rating {
            color: #ffa500;
            font-size: 16px;
        }
        .review-content-preview {
            max-width: 400px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .product-name {
            font-size: 13px;
            color: #666;
            margin-top: 4px;
        }
    </style>
</head>
<body class="page font-body">
<div th:replace="fragments/layout :: header"></div>

<!-- ë©”ì¸ ì»¨í…ì¸  -->
<main class="main-content">
    <div class="container">
        <div class="question-list-header">
            <div class="question-list-header-title">
                <h1 class="question-list-title">ë‚´ê°€ ì‘ì„±í•œ ë¦¬ë·°</h1>
                <span class="question-total-count" th:text="'ì „ì²´ ' + ${totalReviewCount} + 'ê°œ'">ì „ì²´ 0ê°œ</span>
            </div>
            <div class="question-list-header-actions">
                <select class="form-select" onchange="changeSortOrder(this.value)">
                    <option value="latest" th:selected="${currentSort == 'latest'}">ìµœì‹ ìˆœ</option>
                    <option value="oldest" th:selected="${currentSort == 'oldest'}">ì˜¤ë˜ëœìˆœ</option>
                    <option value="rating-high" th:selected="${currentSort == 'rating-high'}">ë³„ì  ë†’ì€ìˆœ</option>
                    <option value="rating-low" th:selected="${currentSort == 'rating-low'}">ë³„ì  ë‚®ì€ìˆœ</option>
                </select>
            </div>
        </div>

        <!-- ë¦¬ë·° ëª©ë¡ í…Œì´ë¸” -->
        <div class="question-table-container">
            <table th:if="${reviews != null and !reviews.isEmpty()}" class="question-table">
                <thead>
                <tr>
                    <th>ë²ˆí˜¸</th>
                    <th>ìƒí’ˆì •ë³´</th>
                    <th>ì œëª©</th>
                    <th>ë³„ì </th>
                    <th>ë‚´ìš©</th>
                    <th>ì‘ì„±ì¼</th>
                    <th>ê´€ë¦¬</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="review, iterStat : ${reviews}">
                    <td th:text="${totalReviewCount - (currentPage - 1) * 10 - iterStat.index}">1</td>
                    <td>
                        <div th:if="${review.optionName != null}" th:text="${review.optionName}" class="product-name">ìƒí’ˆ ì˜µì…˜</div>
                        <div th:if="${review.isPhotoReview}" class="review-image-preview">
                            <img th:each="imageUrl, idx : ${review.imageUrls}"
                                 th:if="${idx.index < 3}"
                                 th:src="${imageUrl}"
                                 alt="ë¦¬ë·° ì´ë¯¸ì§€">
                        </div>
                    </td>
                    <td class="question-title-cell">
                        <span th:text="${review.title}">ë¦¬ë·° ì œëª©</span>
                    </td>
                    <td>
                        <span class="review-rating" th:text="${review.starRating}">â˜…â˜…â˜…â˜…â˜…</span>
                    </td>
                    <td>
                        <div class="review-content-preview" th:text="${review.content}">ë¦¬ë·° ë‚´ìš©</div>
                    </td>
                    <td th:text="${review.formattedCreatedAt}">2024-10-01</td>
                    <td>
                        <button class="btn-small" th:onclick="'viewProductDetail(' + ${review.productId} + ')'">ìƒí’ˆë³´ê¸°</button>
                        <button class="btn-small" th:onclick="'editReview(' + ${review.reviewId} + ')'">ìˆ˜ì •</button>
                        <button class="btn-small" th:onclick="'deleteReview(' + ${review.reviewId} + ', ' + ${review.productId} + ')'">ì‚­ì œ</button>
                    </td>
                </tr>
                </tbody>
            </table>

            <!-- ë¦¬ë·°ê°€ ì—†ì„ ë•Œ -->
            <div th:if="${reviews == null or reviews.isEmpty()}" class="empty-state">
                <div class="empty-content">
                    <div class="empty-icon">ğŸ“</div>
                    <h3>ì‘ì„±í•œ ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤</h3>
                    <p>êµ¬ë§¤í•˜ì‹  ìƒí’ˆì— ëŒ€í•œ ë¦¬ë·°ë¥¼ ì‘ì„±í•´ë³´ì„¸ìš”.</p>
                </div>
            </div>
        </div>

        <!-- í˜ì´ì§• -->
        <div th:if="${totalPages != null and totalPages > 1}" class="question-pagination">
            <nav class="question-pagination-nav">
                <ul class="question-pagination-list">
                    <!-- ë§¨ ì²˜ìŒìœ¼ë¡œ -->
                    <li class="question-page-item arrow">
                        <a th:href="@{/mypage/reviews(page=1, sort=${currentSort})}"
                           th:classappend="${currentPage == 1} ? 'disabled' : ''"
                           class="question-page-link">â‰ª</a>
                    </li>

                    <!-- ì´ì „ í˜ì´ì§€ -->
                    <li class="question-page-item arrow">
                        <a th:href="@{/mypage/reviews(page=${currentPage - 1}, sort=${currentSort})}"
                           th:classappend="${currentPage == 1} ? 'disabled' : ''"
                           class="question-page-link">â€¹</a>
                    </li>

                    <!-- í˜ì´ì§€ ë²ˆí˜¸ (í˜„ì¬ í˜ì´ì§€ ì£¼ë³€ 5ê°œë§Œ í‘œì‹œ) -->
                    <li th:each="pageNum : ${#numbers.sequence(
                        T(java.lang.Math).max(1, currentPage - 2),
                        T(java.lang.Math).min(totalPages, currentPage + 2)
                    )}"
                        th:classappend="${pageNum == currentPage} ? 'question-page-item active' : 'question-page-item'">
                        <a th:href="@{/mypage/reviews(page=${pageNum}, sort=${currentSort})}"
                           th:text="${pageNum}"
                           class="question-page-link">1</a>
                    </li>

                    <!-- ë‹¤ìŒ í˜ì´ì§€ -->
                    <li class="question-page-item arrow">
                        <a th:href="@{/mypage/reviews(page=${currentPage + 1}, sort=${currentSort})}"
                           th:classappend="${currentPage == totalPages} ? 'disabled' : ''"
                           class="question-page-link">â€º</a>
                    </li>

                    <!-- ë§¨ ë§ˆì§€ë§‰ìœ¼ë¡œ -->
                    <li class="question-page-item arrow">
                        <a th:href="@{/mypage/reviews(page=${totalPages}, sort=${currentSort})}"
                           th:classappend="${currentPage == totalPages} ? 'disabled' : ''"
                           class="question-page-link">â‰«</a>
                    </li>
                </ul>
            </nav>
        </div>
    </div>
</main>

<div th:replace="fragments/layout :: footer"></div>

<script>
    function changeSortOrder(sort) {
        location.href = '/mypage/reviews?page=1&sort=' + sort;
    }

    function viewProductDetail(productId) {
        location.href = '/product/' + productId;
    }

    function editReview(reviewId) {
        location.href = '/reviews/' + reviewId + '/edit';
    }

    function deleteReview(reviewId, productId) {
        if (confirm('ë¦¬ë·°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/reviews/' + reviewId + '/delete';

            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'productId';
            input.value = productId;
            form.appendChild(input);

            document.body.appendChild(form);
            form.submit();
        }
    }
</script>

</body>
</html>