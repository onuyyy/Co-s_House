<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>쿠폰 발급</title>
    <link rel="stylesheet" th:href="@{/css/app.css}">
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; background:#f8fafc; margin:0; }
        .container { max-width:960px; margin:40px auto; padding:0 24px; }
        h1 { font-size:24px; margin-bottom:24px; }
        .filter-box { background:white; border-radius:12px; padding:16px; box-shadow:0 10px 24px rgba(15,23,42,0.06); margin-bottom:24px; display:grid; gap:12px; }
        .filter-row { display:grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap:12px; }
        .filter-row label { font-size:13px; color:#475569; display:flex; flex-direction:column; gap:6px; }
        .filter-row select, .filter-row input { height:38px; border:1px solid #d1d5db; border-radius:8px; padding:0 10px; font-size:13px; }
        .filter-actions { display:flex; gap:10px; justify-content:flex-end; }
        .filter-actions button, .filter-actions a { border:none; border-radius:8px; padding:8px 16px; font-size:13px; cursor:pointer; text-decoration:none; display:inline-flex; align-items:center; }
        .btn-primary { background:#2563eb; color:white; border:none; border-radius:8px; padding:8px 16px; font-size:13px; cursor:pointer; text-decoration:none; display:inline-flex; align-items:center; }
        .btn-secondary { background:#e2e8f0; color:#1f2937; border:none; border-radius:8px; padding:8px 16px; font-size:13px; cursor:pointer; text-decoration:none; display:inline-flex; align-items:center; }
        .coupon-list { display:grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap:16px; }
        .coupon-card { background:white; border-radius:12px; padding:16px; box-shadow:0 12px 30px rgba(15,23,42,0.08); min-height:220px; display:flex; flex-direction:column; }
        .coupon-title { font-size:16px; font-weight:700; margin:8px 0; }
        .coupon-meta { color:#6b7280; font-size:12px; margin-bottom:4px; }
        .coupon-body { font-size:13px; color:#1f2937; margin-bottom:6px; flex:1; }
        .coupon-footer { display:flex; justify-content:space-between; align-items:center; font-size:12px; color:#475569; }
        .badge { display:inline-block; padding:4px 8px; border-radius:999px; font-size:11px; font-weight:600; }
        .badge-global { background:#e0f2fe; color:#0369a1; }
        .badge-brand { background:#fef3c7; color:#b45309; }
        .badge-product { background:#dcfce7; color:#047857; }
        .empty-state { text-align:center; padding:80px 0; color:#94a3b8; }
        .btn-claim { width:100%; height:38px; border:none; border-radius:8px; background:#16a34a; color:white; font-weight:600; cursor:pointer; transition:background 0.2s ease; }
        .btn-claim:hover { background:#15803d; }
        .alert { padding:12px 16px; border-radius:8px; margin-bottom:16px; font-size:13px; }
        .alert-success { background:#dcfce7; color:#166534; }
        .alert-error { background:#fee2e2; color:#b91c1c; }
        .pagination { display:flex; justify-content:center; gap:8px; margin-top:24px; }
        .pagination a, .pagination span { padding:6px 10px; border-radius:6px; border:1px solid #d1d5db; font-size:12px; color:#1f2937; text-decoration:none; }
        .pagination .active { background:#2563eb; color:white; border-color:#2563eb; }
        .pagination .disabled { border-style:dashed; color:#9ca3af; cursor:default; }
        @media (max-width: 640px) {
            .coupon-list { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
<div class="container">
    <h1>쿠폰 발급</h1>

    <div th:if="${success}" class="alert alert-success" th:text="${success}"></div>
    <div th:if="${error}" class="alert alert-error" th:text="${error}"></div>

    <div class="filter-actions" style="justify-content:flex-start; margin-bottom:12px; gap:12px;">
        <button type="button" class="btn-secondary" style="background:#2563eb; color:white; cursor:default;">쿠폰 발급</button>
        <a class="btn-secondary" th:href="@{/mypage/coupons/mine}">내 쿠폰함</a>
    </div>

    <form method="get" class="filter-box">
        <div class="filter-row">
            <label>
                쿠폰 범위
                <select name="scope">
                    <option value="">쿠폰전체보기</option>
                    <option value="GLOBAL" th:selected="${'GLOBAL' == selectedScope}">모든상품</option>
                    <option value="BRAND" th:selected="${'BRAND' == selectedScope}">브랜드전용</option>
                    <option value="PRODUCT" th:selected="${'PRODUCT' == selectedScope}">특정상품전용</option>
                </select>
            </label>
            <label>
                브랜드 ID
                <input type="number" name="brandId" min="1" th:value="${selectedBrandId}">
            </label>
            <label>
                상태
                <select name="status">
                    <option value="">전체</option>
                    <option value="active" th:selected="${'active' == selectedStatus}">사용 가능</option>
                    <option value="expired" th:selected="${'expired' == selectedStatus}">만료</option>
                </select>
            </label>
            <label>
                검색어
                <input type="text" name="keyword" th:value="${keyword}">
            </label>
        </div>
        <div class="filter-actions">
            <button type="submit" class="btn-primary">검색</button>
            <a class="btn-secondary" th:href="@{/mypage/coupons}">초기화</a>
        </div>
    </form>

    <div th:if="${#lists.isEmpty(coupons)}" class="empty-state">
        현재 발급 받을 수 있는 쿠폰이 없습니다.
    </div>

    <div th:if="${!#lists.isEmpty(coupons)}" class="coupon-list">
        <article class="coupon-card" th:each="coupon : ${coupons}">
            <div>
                <span class="badge"
                      th:classappend="${coupon.couponScope.name() == 'GLOBAL'} ? ' badge-global' :
                                       (${coupon.couponScope.name() == 'BRAND'} ? ' badge-brand' : ' badge-product')"
                      th:text="${coupon.couponScope.name() == 'GLOBAL' ? '모든상품' : (coupon.couponScope.name() == 'BRAND' ? '브랜드' : '상품')}">전체</span>
            </div>
            <div class="coupon-title" th:text="${coupon.couponTitle}">쿠폰 제목</div>
            <div class="coupon-meta" th:if="${coupon.brandName != null}" th:text="|브랜드: ${coupon.brandName}|">브랜드</div>
            <div class="coupon-meta" th:if="${coupon.productTitle != null}" th:text="|상품: ${coupon.productTitle}|">상품</div>
            <div class="coupon-body" th:text="${coupon.couponDescription}">설명</div>
            <div class="coupon-meta" th:if="${coupon.discountRate != null}" th:text="|할인율: ${coupon.discountRate}%|">할인율</div>
            <div class="coupon-meta" th:if="${coupon.discountAmount != null}" th:text="|할인금액: ${#numbers.formatDecimal(coupon.discountAmount, 0, 'COMMA', 0, 'POINT')}원|">할인금액</div>
            <div class="coupon-meta" th:if="${coupon.maxDiscountAmount != null}" th:text="|최대 ${#numbers.formatDecimal(coupon.maxDiscountAmount, 0, 'COMMA', 0, 'POINT')}원 할인|">최대 할인</div>
            <div class="coupon-meta" th:if="${coupon.minPurchaseAmount != null}" th:text="|최소 주문금액 ${#numbers.formatDecimal(coupon.minPurchaseAmount, 0, 'COMMA', 0, 'POINT')}원|">최소 금액</div>
            <div class="coupon-footer">
                <span th:text="|사용 가능 기간: ${#temporals.format(coupon.startDate, 'yyyy.MM.dd')} ~ ${#temporals.format(coupon.expiredAt, 'yyyy.MM.dd')}|">기간</span>
                <span th:text="${coupon.active} ? '사용 가능' : '만료'">상태</span>
            </div>
            <form th:action="@{/mypage/coupons/{id}/claim(id=${coupon.couponId})}" method="post" style="margin-top:12px;">
                <div th:if="${_csrf != null}">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                </div>
                <input type="hidden" name="page" th:value="${page != null ? page.number : 0}" />
                <input type="hidden" name="size" th:value="${page != null ? page.size : 8}" />
                <input type="hidden" name="scope" th:value="${selectedScope}" />
                <input type="hidden" name="brandId" th:value="${selectedBrandId != null ? selectedBrandId : ''}" />
                <input type="hidden" name="status" th:value="${selectedStatus}" />
                <input type="hidden" name="keyword" th:value="${keyword}" />
                <button type="submit" class="btn-claim">쿠폰 받기</button>
            </form>
        </article>
    </div>

    <div th:if="${page != null && page.totalPages > 1}" class="pagination">
        <span th:if="${page.first}" class="disabled">이전</span>
        <a th:if="${!page.first}" th:href="@{/mypage/coupons(page=${page.number - 1}, scope=${selectedScope}, brandId=${selectedBrandId}, status=${selectedStatus}, keyword=${keyword})}">이전</a>

        <span th:each="i : ${#numbers.sequence(0, page.totalPages - 1)}"
              th:if="${page.totalPages <= 7 || (i >= page.number - 2 && i <= page.number + 2)}">
            <span th:if="${i == page.number}" th:text="${i + 1}" class="active"></span>
            <a th:if="${i != page.number}"
               th:text="${i + 1}"
               th:href="@{/mypage/coupons(page=${i}, scope=${selectedScope}, brandId=${selectedBrandId}, status=${selectedStatus}, keyword=${keyword})}"></a>
        </span>

        <a th:if="${!page.last}" th:href="@{/mypage/coupons(page=${page.number + 1}, scope=${selectedScope}, brandId=${selectedBrandId}, status=${selectedStatus}, keyword=${keyword})}">다음</a>
        <span th:if="${page.last}" class="disabled">다음</span>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const storageKey = 'couponListScroll';
        const savedScroll = sessionStorage.getItem(storageKey);
        if (savedScroll !== null) {
            window.scrollTo({ top: parseInt(savedScroll, 10), behavior: 'auto' });
            sessionStorage.removeItem(storageKey);
        }

        document.querySelectorAll('.coupon-card form').forEach(function(form) {
            form.addEventListener('submit', function() {
                sessionStorage.setItem(storageKey, window.scrollY || window.pageYOffset);
            });
        });
    });
</script>
</body>
</html>
