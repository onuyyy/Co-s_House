<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/layout :: head('코딩의 집 | 쿠폰발급')}"></head>
<body class="page font-body">
<header th:replace="~{fragments/layout :: header}"></header>
<main class="page-main coupon-main">
<div class="coupon-main__inner container">
    <h1>쿠폰 발급</h1>

    <div th:if="${success}" class="alert alert-success" th:text="${success}"></div>
    <div th:if="${error}" class="alert alert-error" th:text="${error}"></div>

    <div class="filter-actions" style="justify-content:flex-start; margin-bottom:12px; gap:12px;">
        <button type="button" class="btn-secondary" style="background:#3c9dfc; color:white; cursor:default;">쿠폰 발급</button>
        <a class="btn-secondary" th:href="@{/mypage/coupons/mine}">내 쿠폰함</a>
    </div>

    <form method="get" class="filter-box">
        <div class="filter-row">
            <label>
                쿠폰 범위
                <select name="scope">
                    <option value="">쿠폰전체보기</option>
                    <option value="GLOBAL" th:selected="${'GLOBAL' == selectedScope}">모든상품</option>
                    <option value="BRAND" th:selected="${'BRAND' == selectedScope}">브랜드전용</option>
                    <option value="PRODUCT" th:selected="${'PRODUCT' == selectedScope}">특정상품전용</option>
                </select>
            </label>
            <label>
                브랜드 ID
                <input type="number" name="brandId" min="1" th:value="${selectedBrandId}">
            </label>
            <label>
                상태
                <select name="status">
                    <option value="">전체</option>
                    <option value="active" th:selected="${'active' == selectedStatus}">사용 가능</option>
                    <option value="expired" th:selected="${'expired' == selectedStatus}">만료</option>
                </select>
            </label>
            <label>
                검색어
                <input type="text" name="keyword" th:value="${keyword}">
            </label>
        </div>
        <div class="filter-actions">
            <button type="submit" class="btn-primary">검색</button>
            <a class="btn-secondary" th:href="@{/mypage/coupons}">초기화</a>
        </div>
    </form>

    <div th:if="${#lists.isEmpty(coupons)}" class="empty-state">
        현재 발급 받을 수 있는 쿠폰이 없습니다.
    </div>

    <div th:if="${!#lists.isEmpty(coupons)}" class="coupon-list">
        <article class="coupon-card" th:each="coupon : ${coupons}">
            <div>
                <span class="badge"
                      th:classappend="${coupon.couponScope.name() == 'GLOBAL'} ? ' badge-global' :
                                       (${coupon.couponScope.name() == 'BRAND'} ? ' badge-brand' : ' badge-product')"
                      th:text="${coupon.couponScope.name() == 'GLOBAL' ? '모든상품' : (coupon.couponScope.name() == 'BRAND' ? '브랜드' : '상품')}">전체</span>
            </div>
            <div class="coupon-title" th:text="${coupon.couponTitle}">쿠폰 제목</div>
            <div class="coupon-meta" th:if="${coupon.brandName != null}" th:text="|브랜드: ${coupon.brandName}|">브랜드</div>
            <div class="coupon-meta" th:if="${coupon.productTitle != null}" th:text="|상품: ${coupon.productTitle}|">상품</div>
            <div class="coupon-body" th:text="${coupon.couponDescription}">설명</div>
            <div class="coupon-meta" th:if="${coupon.discountRate != null}" th:text="|할인율: ${coupon.discountRate}%|">할인율</div>
            <div class="coupon-meta" th:if="${coupon.discountAmount != null}" th:text="|할인금액: ${#numbers.formatDecimal(coupon.discountAmount, 0, 'COMMA', 0, 'POINT')}원|">할인금액</div>
            <div class="coupon-meta" th:if="${coupon.maxDiscountAmount != null}" th:text="|최대 ${#numbers.formatDecimal(coupon.maxDiscountAmount, 0, 'COMMA', 0, 'POINT')}원 할인|">최대 할인</div>
            <div class="coupon-meta" th:if="${coupon.minPurchaseAmount != null}" th:text="|최소 주문금액 ${#numbers.formatDecimal(coupon.minPurchaseAmount, 0, 'COMMA', 0, 'POINT')}원|">최소 금액</div>
            <div class="coupon-footer">
                <span th:text="|사용 가능 기간: ${#temporals.format(coupon.startDate, 'yyyy.MM.dd')} ~ ${#temporals.format(coupon.expiredAt, 'yyyy.MM.dd')}|">기간</span>
                <span th:text="${coupon.active} ? '사용 가능' : '만료'">상태</span>
            </div>
            <form th:action="@{/mypage/coupons/{id}/claim(id=${coupon.couponId})}" method="post" style="margin-top:12px;">
                <div th:if="${_csrf != null}">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                </div>
                <input type="hidden" name="page" th:value="${page != null ? page.number : 0}" />
                <input type="hidden" name="size" th:value="${page != null ? page.size : 8}" />
                <input type="hidden" name="scope" th:value="${selectedScope}" />
                <input type="hidden" name="brandId" th:value="${selectedBrandId != null ? selectedBrandId : ''}" />
                <input type="hidden" name="status" th:value="${selectedStatus}" />
                <input type="hidden" name="keyword" th:value="${keyword}" />
                <button type="submit" class="btn-claim">쿠폰 받기</button>
            </form>
        </article>
    </div>

    <div th:if="${page != null && page.totalPages > 1}" class="pagination">
        <span th:if="${page.first}" class="disabled">이전</span>
        <a th:if="${!page.first}" th:href="@{/mypage/coupons(page=${page.number - 1}, scope=${selectedScope}, brandId=${selectedBrandId}, status=${selectedStatus}, keyword=${keyword})}">이전</a>

        <span th:each="i : ${#numbers.sequence(0, page.totalPages - 1)}"
              th:if="${page.totalPages <= 7 || (i >= page.number - 2 && i <= page.number + 2)}">
            <span th:if="${i == page.number}" th:text="${i + 1}" class="active"></span>
            <a th:if="${i != page.number}"
               th:text="${i + 1}"
               th:href="@{/mypage/coupons(page=${i}, scope=${selectedScope}, brandId=${selectedBrandId}, status=${selectedStatus}, keyword=${keyword})}"></a>
        </span>

        <a th:if="${!page.last}" th:href="@{/mypage/coupons(page=${page.number + 1}, scope=${selectedScope}, brandId=${selectedBrandId}, status=${selectedStatus}, keyword=${keyword})}">다음</a>
        <span th:if="${page.last}" class="disabled">다음</span>
    </div>
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const storageKey = 'couponListScroll';
        const savedScroll = sessionStorage.getItem(storageKey);
        if (savedScroll !== null) {
          window.scrollTo({ top: parseInt(savedScroll, 10), behavior: 'auto' });
          sessionStorage.removeItem(storageKey);
        }

        document.querySelectorAll('.coupon-card form').forEach(function(form) {
          form.addEventListener('submit', function() {
            sessionStorage.setItem(storageKey, window.scrollY || window.pageYOffset);
          });
        });
      });
    </script>
</div>
</main>
<footer th:replace="~{fragments/layout :: footer}"></footer>
<link rel="stylesheet" th:href="@{/css/sections.css}">
<link rel="stylesheet" th:href="@{/css/mypage/coupon.css}">
</body>
</html>
