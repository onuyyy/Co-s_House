<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns="http://www.w3.org/1999/html">
<head th:replace="~{fragments/layout :: head('ì£¼ë¬¸/ê²°ì œ | ì½”ë”©ì˜ ì§‘')}"></head>
<link rel="stylesheet" th:href="@{/css/order.css}">
<body class="page font-body">
<header th:replace="fragments/layout :: header"></header>

<!-- Main Content -->
<main class="main-content">
    <div class="page-card">
<!--        <h1 class="page-title">ì£¼ë¬¸/ê²°ì œ</h1>-->

        <div class="order-layout">
            <!-- ì™¼ìª½ ì„¹ì…˜ -->
            <div class="left-section">

                <!-- ì£¼ë¬¸ì ì •ë³´ ì„¹ì…˜ -->
                <section class="section-card" aria-labelledby="orderer-info-title">
                    <div class="section-head">
                        <h2 id="orderer-info-title" class="section-title">ì£¼ë¬¸ì ì •ë³´</h2>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="orderer-name">ì£¼ë¬¸ìëª…</label>
                        <input type="text" id="orderer-name" class="input" th:value="${order.user.userName}" readonly>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="orderer-phone">ì—°ë½ì²˜</label>
                        <input type="text" id="orderer-phone" class="input" th:value="${order.user.phone}" readonly>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="orderer-email">ì´ë©”ì¼</label>
                        <input type="text" id="orderer-email" class="input" th:value="${order.user.userEmail}" readonly>
                    </div>
                </section>

                <!-- ë°°ì†¡ì§€ ì •ë³´ ì„¹ì…˜ -->
                <section class="section-card" aria-labelledby="delivery-info-title">
                    <div class="section-head">
                        <h2 id="delivery-info-title" class="section-title">
                            ë°°ì†¡ì§€ ì •ë³´
                            <button type="button" class="coupon-link" onclick="openAddressModal()">ì£¼ì†Œë¡ ë³´ê¸°</button>
                        </h2>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="recipient-name">ë°›ëŠ” ë¶„</label>
                        <input type="text" id="recipient-name" class="input" th:value="${order.user.userName}" placeholder="ì˜ˆ: í™ê¸¸ë™" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="recipient-phone">ì—°ë½ì²˜</label>
                        <input type="text" id="recipient-phone" class="input" th:value="${order.user.phone}" placeholder="ì˜ˆ: 010-1234-5678" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="recipient-postcode">ìš°í¸ë²ˆí˜¸</label>
                        <div class="form-row">
                            <input type="text" id="recipient-postcode" class="input" placeholder="ìš°í¸ë²ˆí˜¸" readonly required>
                            <button type="button" class="btn-address-search" onclick="openAddressSearch(false)">ì£¼ì†Œ ê²€ìƒ‰</button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="recipient-address">ì£¼ì†Œ</label>
                        <input type="text" id="recipient-address" class="input" placeholder="ì£¼ì†Œ" readonly required>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="recipient-detail-address">ìƒì„¸ì£¼ì†Œ</label>
                        <input type="text" id="recipient-detail-address" class="input" placeholder="ì˜ˆ: 101ë™ 1203í˜¸" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="delivery-request">ë°°ì†¡ ìš”ì²­ì‚¬í•­</label>
                        <select id="delivery-request" class="input">
                            <option>ë°°ì†¡ì‹œ ìš”ì²­ì‚¬í•­ì„ ì„ íƒí•´ì£¼ì„¸ìš”</option>
                            <option>ë¬¸ ì•ì— ë†“ì•„ì£¼ì„¸ìš”</option>
                            <option>ê²½ë¹„ì‹¤ì— ë§¡ê²¨ì£¼ì„¸ìš”</option>
                            <option>íƒë°°ë³´ê´€í•¨ì— ë„£ì–´ì£¼ì„¸ìš”</option>
                            <option>ì§ì ‘ ë°›ê² ìŠµë‹ˆë‹¤</option>
                        </select>
                    </div>
                </section>

                <!-- ì£¼ë¬¸ ìƒí’ˆ ì •ë³´ ì„¹ì…˜ -->
                <section class="section-card" aria-labelledby="order-items-title">
                    <div class="section-head">
                        <h2 id="order-items-title" class="section-title">
                            ì£¼ë¬¸ ìƒí’ˆ ì •ë³´
                            <span class="item-count" th:text="${#lists.size(order.items)} + 'ê±´'">1ê±´</span>
                        </h2>
                    </div>

                    <div class="order-items">
                        <div class="order-item" th:each="item : ${order.items}">
                            <div class="item-info">
                                <div class="item-image">
                                    <a class="product-img-link"
                                       th:href="@{'/product/' + ${item.productId}}"
                                       aria-label="${item.productName}">
                                        <img th:if="${item.imageUrl != null}" th:src="${item.imageUrl}" th:alt="${item.productName}" class="product-img" loading="lazy" />
                                        <div class="product-img-placeholder" th:unless="${item.imageUrl != null}">ğŸ“¦</div>
                                    </a>
                                </div>
                                <div class="item-details">
                                    <h3 class="item-name">
                                        <a class="item-name__link"
                                           th:href="@{'/product/' + ${item.productId}}"
                                           th:text="${item.productName}">ìƒí’ˆëª…</a>
                                    </h3>                                    <p class="item-option" th:if="${item.productOptionName != null}" th:text="${item.productOptionName}">ì˜µì…˜ëª…</p>
                                    <p class="item-quantity" th:text="'ìˆ˜ëŸ‰: ' + ${item.quantity} + 'ê°œ'">ìˆ˜ëŸ‰: 0ê°œ</p>
                                </div>
                            </div>
                            <div class="item-shipping">
                                <p class="item-price" th:text="${#numbers.formatDecimal(item.price, 0, 'COMMA', 0, 'POINT')} + 'ì›'">139,000ì›</p>
                                <span class="shipping-label">ë¬´ë£Œë°°ì†¡</span>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- í¬ì¸íŠ¸/ì¿ í° ì •ë³´ ì„¹ì…˜ -->
                <section class="section-card" aria-labelledby="discount-info-title">
                    <div class="section-head">
                        <h2 id="discount-info-title" class="section-title">í¬ì¸íŠ¸/ì¿ í° ì •ë³´</h2>
                    </div>

                    <!-- ì¿ í° ë¶€ë¶„ -->
                    <div class="coupon-section">
                        <h3 class="sub-section-title">ì¿ í°</h3>
                        <div class="coupon-selected" id="selectedCoupon" style="display: none;">
                            <div class="selected-coupon-info">
                                <span class="selected-coupon-name"></span>
                                <span class="selected-coupon-discount"></span>
                            </div>
                            <button type="button" class="coupon-cancel-btn" onclick="cancelCoupon()">ì·¨ì†Œ</button>
                        </div>
                        <p class="coupon-message" id="couponMessage">ì„ íƒëœ ì¿ í°ì´ ì—†ìŠµë‹ˆë‹¤</p>
                        <button type="button" class="coupon-link" onclick="openCouponModal()">ë‚´ ì¿ í° ëª©ë¡ ë³´ê¸°</button>
                    </div>

                    <!-- í¬ì¸íŠ¸ ë¶€ë¶„ -->
                    <div class="point-section">
                        <h3 class="sub-section-title">í¬ì¸íŠ¸</h3>
                        <div class="point-input-group">
                            <input type="number" id="pointInput" class="point-input" placeholder="0" value="0" min="0" onchange="calculateTotal()">
                            <button type="button" class="point-all-btn" onclick="useAllPoints()">ì „ì•¡ ì‚¬ìš©</button>
                        </div>
                        <p class="point-available">ì‚¬ìš© ê°€ëŠ¥ í¬ì¸íŠ¸ <span class="point-amount">155,555 P</span></p>
                    </div>
                </section>
            </div>

            <!-- ì˜¤ë¥¸ìª½ ì„¹ì…˜ - ê²°ì œ ê¸ˆì•¡ -->
            <aside class="right-section">
                <div class="payment-summary" aria-labelledby="payment-summary-title">
                    <h2 id="payment-summary-title" class="summary-title">ê²°ì œê¸ˆì•¡</h2>

                    <div class="price-row">
                        <span class="price-label">ì´ ìƒí’ˆ ê¸ˆì•¡</span>
                        <span class="price-value" th:text="${#numbers.formatDecimal(order.totalPrice, 0, 'COMMA', 0, 'POINT')} + 'ì›'">139,000ì›</span>
                    </div>

                    <div class="price-row">
                        <span class="price-label">ë°°ì†¡ë¹„</span>
                        <span class="price-value" id="shippingFee">0ì›</span>
                    </div>

                    <div class="price-row">
                        <span class="price-label">ì¿ í° ì‚¬ìš©</span>
                        <span class="price-value" data-role="coupon-discount" style="color: var(--success-color);">0ì›</span>
                    </div>

                    <div class="price-row">
                        <span class="price-label">í¬ì¸íŠ¸ ì‚¬ìš©</span>
                        <span class="price-value" data-role="points-discount" style="color: var(--success-color);">0ì›</span>
                    </div>
                    <div class="total-row"></div>
                        <div class="total-amount-row">
                            <span class="total-label">ìµœì¢… ê²°ì œ ê¸ˆì•¡</span>
                            <span class="total-price" th:text="${#numbers.formatDecimal(order.totalAmount, 0, 'COMMA', 0, 'POINT')} + ' ì›'">179,000 ì›</span>
                        </div>
                        <span class="installment-text">139 P ì ë¦½ ì˜ˆì •</span>

                    <button type="button" class="payment-btn" th:text="${#numbers.formatDecimal(order.totalAmount, 0, 'COMMA', 0, 'POINT')} + 'ì› ê²°ì œí•˜ê¸°'">179,000 ì› ê²°ì œí•˜ê¸°</button>
                    <p class="terms-notice">
                        ğŸ’¡ <strong>ê²°ì œ ì•ˆë‚´:</strong> ë¸Œëœë“œë³„ ìµœì  ì¿ í°ì´ ìë™ ì ìš©ë©ë‹ˆë‹¤.
                        ì´ë²¤íŠ¸ ì¿ í°ì„ ë°œê¸‰í•˜ì—¬ í• ì¸ ë°›ìœ¼ì„¸ìš”!
                    </p>

    </div>
</main>

<!-- ì£¼ì†Œë¡ ëª¨ë‹¬ -->
<div id="addressModal" class="modal">
    <div class="modal-content" style="max-width: 700px;">
        <div class="modal-header">
            <h2>ë‚´ ë°°ì†¡ì§€ ëª©ë¡</h2>
            <button type="button" class="close" onclick="closeAddressModal()" aria-label="ì£¼ì†Œë¡ ëª¨ë‹¬ ë‹«ê¸°">&times;</button>
        </div>
        <div class="modal-body">
            <div id="addressList" class="modal-card-list">
                <!-- ì£¼ì†Œ ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤. -->
                <div class="loading-message">ì£¼ì†Œë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            </div>
        </div>
        <div class="modal-footer" style="padding: 1.5rem; text-align: right; border-top: 1px solid var(--gray-200);">
            <button type="button" class="btn" onclick="openAddressAddForm()">ìƒˆ ë°°ì†¡ì§€ ì¶”ê°€</button>
        </div>
    </div>
</div>

<!-- ìƒˆ ì£¼ì†Œ ì¶”ê°€/ìˆ˜ì • ëª¨ë‹¬ -->
<div id="addressFormModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="addressFormTitle">ìƒˆ ë°°ì†¡ì§€ ì¶”ê°€</h2>
            <button type="button" class="close" onclick="closeAddressFormModal()" aria-label="ì£¼ì†Œ ì¶”ê°€ ëª¨ë‹¬ ë‹«ê¸°">&times;</button>
        </div>
        <div class="modal-body">
            <form id="addressForm">
                <input type="hidden" id="addressId" name="id">
                <div class="form-group">
                    <label class="form-label" for="form-recipient-name">ë°›ëŠ” ë¶„</label>
                    <input type="text" id="form-recipient-name" name="recipientName" class="input" placeholder="í™ê¸¸ë™" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="form-recipient-phone">ì—°ë½ì²˜</label>
                    <input type="text" id="form-recipient-phone" name="recipientPhone" class="input" placeholder="010-1234-5678" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="form-postcode">ìš°í¸ë²ˆí˜¸</label>
                    <div class="form-row">
                        <input type="text" id="form-postcode" name="postcode" class="input" readonly required>
                        <button type="button" class="btn-address-search" onclick="openAddressSearch(true)">ì£¼ì†Œ ê²€ìƒ‰</button>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label" for="form-address">ì£¼ì†Œ</label>
                    <input type="text" id="form-address" name="address" class="input" readonly required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="form-detail-address">ìƒì„¸ì£¼ì†Œ</label>
                    <input type="text" id="form-detail-address" name="detailAddress" class="input" placeholder="ì˜ˆ: 101ë™ 1203í˜¸" required>
                </div>
                <div class="form-group">
                    <label class="form-label" style="display: flex; align-items: center;">
                        <input type="checkbox" id="form-is-default" name="isDefault" style="margin-right: 8px;">
                        ê¸°ë³¸ ë°°ì†¡ì§€ë¡œ ì„¤ì •
                    </label>
                </div>
            </form>
        </div>
        <div class="modal-footer" style="padding: 1.5rem; text-align: right; border-top: 1px solid var(--gray-200);">
            <button type="button" class="btn" onclick="saveAddress()">ì €ì¥í•˜ê¸°</button>
        </div>
    </div>
</div>


<!-- ì¿ í° ëª¨ë‹¬ -->
<div id="couponModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>ë‚´ ì¿ í° ëª©ë¡</h2>
            <button type="button" class="close" onclick="closeCouponModal()" aria-label="ì¿ í° ëª¨ë‹¬ ë‹«ê¸°">&times;</button>
        </div>
        <div class="modal-body">
            <div id="couponList" class="modal-card-list">
                <div class="loading-message">ì¿ í°ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            </div>
        </div>
    </div>
</div>

<footer th:replace="fragments/layout :: footer"></footer>

<!-- Hidden form with order data for JavaScript -->
<div id="hiddenOrderData" style="display: none;">
    <div th:each="item, itemStat : ${order.items}">
        <input type="hidden" th:id="'item-' + ${itemStat.index} + '-productId'" th:value="${item.productId}" />
        <input type="hidden" th:id="'item-' + ${itemStat.index} + '-productOptionId'" th:value="${item.productOptionId}" />
        <input type="hidden" th:id="'item-' + ${itemStat.index} + '-quantity'" th:value="${item.quantity}" />
        <input type="hidden" th:id="'item-' + ${itemStat.index} + '-price'" th:value="${item.price}" />
        <input type="hidden" th:id="'item-' + ${itemStat.index} + '-productName'" th:value="${item.productName}" />
    </div>
    <input type="hidden" id="totalItemsCount" th:value="${#lists.size(order.items)}" />
</div>

<script src="/js/payment/checkout.js"></script>
<script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
<script>
    // ì£¼ì†Œë¡ ëª¨ë‹¬
    function openAddressModal() {
        document.getElementById('addressModal').style.display = 'block';
        document.body.style.overflow = 'hidden';
        loadAddresses();
    }

    function closeAddressModal() {
        document.getElementById('addressModal').style.display = 'none';
        document.body.style.overflow = '';
    }

    // ì£¼ì†Œ ì¶”ê°€/ìˆ˜ì • í¼ ëª¨ë‹¬
    function openAddressAddForm() {
        document.getElementById('addressForm').reset();
        document.getElementById('addressId').value = '';
        document.getElementById('addressFormTitle').textContent = 'ìƒˆ ë°°ì†¡ì§€ ì¶”ê°€';
        document.getElementById('addressFormModal').style.display = 'block';
    }

    function openAddressEditForm(address) {
        document.getElementById('addressForm').reset();
        document.getElementById('addressId').value = address.id;
        document.getElementById('addressFormTitle').textContent = 'ë°°ì†¡ì§€ ìˆ˜ì •';

        document.getElementById('form-recipient-name').value = address.recipientName;
        document.getElementById('form-recipient-phone').value = address.recipientPhone;
        document.getElementById('form-postcode').value = address.postcode;
        document.getElementById('form-address').value = address.address;
        document.getElementById('form-detail-address').value = address.detailAddress || '';
        document.getElementById('form-is-default').checked = address.default;

        document.getElementById('addressFormModal').style.display = 'block';
    }

    function closeAddressFormModal() {
        document.getElementById('addressFormModal').style.display = 'none';
    }

    // Daum ì£¼ì†Œ ê²€ìƒ‰
    function openAddressSearch(isForm) {
        new daum.Postcode({
            oncomplete: function(data) {
                if (isForm) {
                    document.getElementById('form-postcode').value = data.zonecode;
                    document.getElementById('form-address').value = data.address;
                    document.getElementById('form-detail-address').focus();
                } else {
                    document.getElementById('recipient-postcode').value = data.zonecode;
                    document.getElementById('recipient-address').value = data.address;
                    document.getElementById('recipient-detail-address').focus();
                }
            }
        }).open();
    }

    // ì£¼ì†Œë¡ ë¡œë“œ
    async function loadAddresses() {
        const addressListEl = document.getElementById('addressList');
        addressListEl.innerHTML = '<div class="loading-message">ì£¼ì†Œë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';

        try {
            const response = await fetch('/api/mypage/shipping-addresses');
            if (!response.ok) {
                throw new Error('ì£¼ì†Œë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
            const addresses = await response.json();
            renderAddresses(addresses);
        } catch (error) {
            console.error('ì£¼ì†Œë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
            addressListEl.innerHTML = `<div class="error-message">${error.message}</div>`;
        }
    }

    function renderAddresses(addresses) {
        const addressListEl = document.getElementById('addressList');
        addressListEl.className = 'modal-card-list'; // í´ë˜ìŠ¤ëª… ë³€ê²½
        if (!addresses || addresses.length === 0) {
            addressListEl.innerHTML = '<div class="no-items-message">ì €ì¥ëœ ë°°ì†¡ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
            return;
        }

        addressListEl.innerHTML = addresses.map(addr => `
        <div class="modal-card">
            <div class="modal-card-content">
                <div class="modal-card-header">
                    <strong class="recipient-name">${addr.recipientName}</strong>
                    ${addr.default ? '<span class="default-badge">ê¸°ë³¸</span>' : ''}
                </div>
                <div class="address-details">
                    <p>[${addr.postcode}] ${addr.address}</p>
                    <p>${addr.detailAddress || ''}</p>
                    <p class="phone-number">${addr.recipientPhone}</p>
                </div>
            </div>
            <div class="modal-card-actions">
                <button class="btn-text" onclick='selectAddress(${JSON.stringify(addr)})'>ì„ íƒ</button>
                <button class="btn-text" onclick='openAddressEditForm(${JSON.stringify(addr)})'>ìˆ˜ì •</button>
                <button class="btn-text btn-danger" onclick="deleteAddress(${addr.id})">ì‚­ì œ</button>
                ${!addr.default ? `<button class="btn-text" onclick="setDefaultAddress(${addr.id})">ê¸°ë³¸ìœ¼ë¡œ ì„¤ì •</button>` : ''}
            </div>
        </div>
    `).join('');
    }


    // ì£¼ì†Œ ì„ íƒ
    function selectAddress(address) {
        const trim = (value) => value != null ? String(value).trim() : '';

        document.getElementById('recipient-name').value = trim(address.recipientName);
        document.getElementById('recipient-phone').value = trim(address.recipientPhone);
        document.getElementById('recipient-postcode').value = trim(address.postcode);
        document.getElementById('recipient-address').value = trim(address.address);
        document.getElementById('recipient-detail-address').value = trim(address.detailAddress);
        closeAddressModal();
    }

    // ì£¼ì†Œ ì €ì¥ ë˜ëŠ” ìˆ˜ì •
    function requireValue(value, message) {
        if (!value || !value.trim()) {
            throw new Error(message);
        }
        return value.trim();
    }

    function validatePhone(value) {
        const phonePattern = /^0\d{1,2}-?\d{3,4}-?\d{4}$/;
        if (!phonePattern.test(value)) {
            throw new Error('ì—°ë½ì²˜ í˜•ì‹ì„ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.');
        }
        return value;
    }

    function validateAddressForm(form) {
        const recipientName = requireValue(form.elements['form-recipient-name'].value, 'ë°›ëŠ” ë¶„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        const phone = validatePhone(requireValue(form.elements['form-recipient-phone'].value, 'ì—°ë½ì²˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'));
        const postcode = requireValue(form.elements['form-postcode'].value, 'ìš°í¸ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        const address = requireValue(form.elements['form-address'].value, 'ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        const detailAddress = requireValue(form.elements['form-detail-address'].value, 'ìƒì„¸ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');

        return {
            recipientName,
            recipientPhone: phone,
            postcode,
            address,
            detailAddress
        };
    }

    function validateRecipientInfo() {
        const nameInput = document.getElementById('recipient-name');
        const phoneInput = document.getElementById('recipient-phone');
        const postcodeInput = document.getElementById('recipient-postcode');
        const addressInput = document.getElementById('recipient-address');
        const detailInput = document.getElementById('recipient-detail-address');

        requireValue(nameInput.value, 'ë°›ëŠ” ë¶„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        validatePhone(requireValue(phoneInput.value, 'ì—°ë½ì²˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'));
        requireValue(postcodeInput.value, 'ìš°í¸ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        requireValue(addressInput.value, 'ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        requireValue(detailInput.value, 'ìƒì„¸ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    }

    async function saveAddress() {
        const form = document.getElementById('addressForm');
        const addressId = form.elements['addressId'].value;
        const isDefault = form.elements['form-is-default'].checked;

        let validated;
        try {
            validated = validateAddressForm(form);
        } catch (error) {
            alert(error.message);
            return;
        }

        const data = {
            ...validated,
            isDefault: isDefault
        };

        const method = addressId ? 'PUT' : 'POST';
        const url = addressId ? `/api/mypage/shipping-addresses/${addressId}` : '/api/mypage/shipping-addresses';

        try {
            const response = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (!response.ok) {
                let errorMessage = 'ì£¼ì†Œ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
                try {
                    const errorData = await response.json();
                    if (errorData && errorData.message) {
                        errorMessage = errorData.message;
                    }
                } catch (parseError) {
                    // ignore JSON parse errors
                }
                throw new Error(errorMessage);
            }

            alert('ì£¼ì†Œê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
            closeAddressFormModal();
            await loadAddresses();

            // ë§Œì•½ 'ê¸°ë³¸ ë°°ì†¡ì§€ë¡œ ì„¤ì •'ì´ ì²´í¬ë˜ì—ˆë‹¤ë©´, ë©”ì¸ í¼ì˜ ì£¼ì†Œë„ ì—…ë°ì´íŠ¸
            if (isDefault) {
                selectAddress({
                    recipientName: data.recipientName,
                    recipientPhone: data.recipientPhone,
                    postcode: data.postcode,
                    address: data.address,
                    detailAddress: data.detailAddress
                });
            }

        } catch (error) {
            console.error('ì£¼ì†Œ ì €ì¥ ì‹¤íŒ¨:', error);
            alert(error.message);
        }
    }

    // ì£¼ì†Œ ì‚­ì œ
    async function deleteAddress(addressId) {
        if (!confirm('ì •ë§ë¡œ ì´ ì£¼ì†Œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            return;
        }

        try {
            const response = await fetch(`/api/mypage/shipping-addresses/${addressId}`, {
                method: 'DELETE'
            });

            if (!response.ok) {
                throw new Error('ì£¼ì†Œ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }

            alert('ì£¼ì†Œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            loadAddresses(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        } catch (error) {
            console.error('ì£¼ì†Œ ì‚­ì œ ì‹¤íŒ¨:', error);
            alert(error.message);
        }
    }


    // ê¸°ë³¸ ì£¼ì†Œë¡œ ì„¤ì •
    async function setDefaultAddress(addressId) {
        try {
            const response = await fetch(`/api/mypage/shipping-addresses/${addressId}/default`, {
                method: 'PUT'
            });

            if (!response.ok) {
                throw new Error('ê¸°ë³¸ ë°°ì†¡ì§€ ì„¤ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }

            alert('ê¸°ë³¸ ë°°ì†¡ì§€ë¡œ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
            loadAddresses(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        } catch (error) {
            console.error('ê¸°ë³¸ ë°°ì†¡ì§€ ì„¤ì • ì‹¤íŒ¨:', error);
            alert(error.message);
        }
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ê¸°ë³¸ ë°°ì†¡ì§€ ì •ë³´ê°€ ìˆìœ¼ë©´ ì±„ì›Œë„£ê¸°
    document.addEventListener('DOMContentLoaded', async function() {
        try {
            const response = await fetch('/api/mypage/shipping-addresses');
            if (response.ok) {
                const addresses = await response.json();
                const defaultAddress = addresses.find(addr => addr.default);
                if (defaultAddress) {
                    selectAddress(defaultAddress);
                }
            }
        } catch (error) {
            console.error('ê¸°ë³¸ ë°°ì†¡ì§€ ë¡œë“œ ì‹¤íŒ¨:', error);
        }
    });
</script>
<script th:inline="javascript">
    // ì „ì—­ ë³€ìˆ˜
    let selectedCouponData = null;
    const totalPrice = parseFloat('[[${ order.totalPrice }]]') || 0;
    let shippingCost = determineShippingCost(totalPrice);
    let availablePoints = 0;
    const customerEmail = /*[[${order.user.userEmail}]]*/ '';
    const customerName = /*[[${order.user.userName}]]*/ '';
    let currentFinalAmount = totalPrice + shippingCost;
    let currentUsedPoints = 0;

    const orderProductIds = getOrderProductIds();

    document.addEventListener('DOMContentLoaded', async function() {
        await loadUserPoints();
        updatePaymentSummary();

        const paymentBtn = document.querySelector('.payment-btn');
        if (paymentBtn) {
            paymentBtn.addEventListener('click', handlePaymentButtonClick);
        }
    });

    function determineShippingCost(productAmount) {
        const freeShippingThreshold = 30000;
        return productAmount >= freeShippingThreshold ? 0 : 3000;
    }

    function getOrderProductIds() {
        const totalItemsCount = parseInt(document.getElementById('totalItemsCount').value) || 0;
        const productIds = [];

        for (let index = 0; index < totalItemsCount; index++) {
            const productIdElement = document.getElementById(`item-${index}-productId`);
            if (productIdElement && productIdElement.value) {
                productIds.push(parseInt(productIdElement.value, 10));
            }
        }

        return productIds;
    }

    async function loadUserPoints() {
        try {
            const response = await fetch('/order/my-points');
            const data = await response.json();

            if (data.success) {
                availablePoints = data.totalPoints || 0;
            } else {
                availablePoints = 0;
                console.error('í¬ì¸íŠ¸ ë¡œë”© ì‹¤íŒ¨:', data.message);
            }
        } catch (error) {
            availablePoints = 0;
            console.error('í¬ì¸íŠ¸ ë¡œë”© ì¤‘ ì˜¤ë¥˜:', error);
        } finally {
            const pointAmountEl = document.querySelector('.point-amount');
            if (pointAmountEl) {
                pointAmountEl.textContent = `${formatPrice(availablePoints)} P`;
            }
            const pointInput = document.getElementById('pointInput');
            if (pointInput) {
                pointInput.max = availablePoints;
            }
        }
    }

    function openCouponModal() {
        document.getElementById('couponModal').style.display = 'block';
        document.body.style.overflow = 'hidden';
        loadMyCoupons();
    }

    function closeCouponModal() {
        document.getElementById('couponModal').style.display = 'none';
        document.body.style.overflow = '';
    }

    async function loadMyCoupons() {
        try {
            const productIdsParam = orderProductIds.length > 0
                ? `?${orderProductIds.map(id => `productIds=${id}`).join('&')}`
                : '';

            const response = await fetch(`/order/my-coupons${productIdsParam}`);
            const coupons = await response.json();

            const couponList = document.getElementById('couponList');

            if (coupons.length === 0) {
                couponList.innerHTML = '<div class="no-coupons">ì‚¬ìš© ê°€ëŠ¥í•œ ì¿ í°ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            couponList.innerHTML = coupons.map(coupon => {
                const isUsable = coupon.usable;
                const discountAmount = coupon.coupon.discountAmount || 0;
                const discountRate = coupon.coupon.discountRate || 0;

                let discountType = 'AMOUNT';
                let discountValue = discountAmount;
                let discountText = '';

                if (discountAmount > 0) {
                    discountType = 'AMOUNT';
                    discountValue = discountAmount;
                    discountText = `${formatPrice(discountAmount)}ì› í• ì¸`;
                } else if (discountRate > 0) {
                    discountType = 'RATE';
                    discountValue = discountRate;
                    discountText = `${discountRate}% í• ì¸`;
                } else {
                    discountText = 'í• ì¸ ì •ë³´ ì—†ìŒ';
                }

                return `
                    <div class="modal-card ${!isUsable ? 'disabled' : ''}">
                        <div class="modal-card-content">
                            <div class="modal-card-header">
                                <strong class="coupon-title">${coupon.coupon.couponTitle || ''}</strong>
                            </div>
                            <div class="coupon-details">
                                <p>${coupon.coupon.couponDescription || ''}</p>
                                <p><span class="discount-label">${discountText}</span></p>
                                <p class="expiry-date">ë§Œë£Œì¼: ${formatDate(coupon.coupon.expiredAt)}</p>
                            </div>
                        </div>
                        <div class="modal-card-actions">
                            <button
                                class="btn-text"
                                onclick="applyCoupon(${coupon.userCouponId}, '${escapeQuotes(coupon.coupon.couponTitle)}', '${discountType}', ${discountValue})"
                                ${!isUsable ? 'disabled' : ''}>
                                ${isUsable ? 'ì ìš©í•˜ê¸°' : 'ì‚¬ìš©ë¶ˆê°€'}
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        } catch (error) {
            console.error('ì¿ í° ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
            document.getElementById('couponList').innerHTML = '<div class="error-message">ì¿ í° ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
        }
    }

    async function applyCoupon(userCouponId, couponTitle, discountType, discountValue) {
        try {
            const currentOrderAmount = totalPrice + shippingCost;
            const response = await fetch(`/order/my-coupons/${userCouponId}?orderAmount=${currentOrderAmount}`);

            if (!response.ok) {
                const errorText = await response.text();
                console.error('ì¿ í° ê²€ì¦ ì‹¤íŒ¨:', response.status, errorText);

                if (response.status === 400) {
                    alert('ì¿ í°ì´ ë§Œë£Œë˜ì—ˆê±°ë‚˜ ì´ë¯¸ ì‚¬ìš©ëœ ì¿ í°ì…ë‹ˆë‹¤.');
                } else if (response.status === 404) {
                    alert('ì¿ í°ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                } else {
                    alert('ì¿ í° ê²€ì¦ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                }
                return;
            }

            const couponInfo = await response.json();

            if (!couponInfo.applicable) {
                alert(`ì´ ì¿ í°ì€ ìµœì†Œ ì£¼ë¬¸ ê¸ˆì•¡ ${formatPrice(couponInfo.minPurchaseAmount)}ì› ì´ìƒë¶€í„° ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.`);
                return;
            }

            const actualDiscount = Number(couponInfo.calculatedDiscountAmount) || 0;
            const finalAmountFromServer = Number(couponInfo.finalAmount) || 0;

            selectedCouponData = {
                userCouponId: userCouponId,
                title: couponTitle,
                discountType: discountType,
                discountValue: discountValue,
                calculatedDiscountAmount: actualDiscount,
                finalAmount: finalAmountFromServer
            };

            document.getElementById('selectedCoupon').style.display = 'flex';
            document.getElementById('couponMessage').textContent = 'ì¿ í°ì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.';
            document.querySelector('.selected-coupon-name').textContent = couponTitle;

            if (discountType === 'RATE') {
                document.querySelector('.selected-coupon-discount').textContent = `-${discountValue}% (${formatPrice(actualDiscount)}ì›)`;
            } else {
                document.querySelector('.selected-coupon-discount').textContent = `-${formatPrice(actualDiscount)}ì›`;
            }

            updatePaymentSummary();
            closeCouponModal();
        } catch (error) {
            console.error('ì¿ í° ì ìš© ì¤‘ ì˜¤ë¥˜:', error);
            alert('ì¿ í° ì ìš© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        }
    }

    function calculateDiscountAmount(discountType, discountValue) {
        if (discountType === 'RATE') {
            return Math.floor((totalPrice + shippingCost) * (discountValue / 100));
        }
        return discountValue;
    }

    function cancelCoupon() {
        selectedCouponData = null;
        const selectedCouponEl = document.getElementById('selectedCoupon');
        if (selectedCouponEl) {
            selectedCouponEl.style.display = 'none';
        }
        const couponMessageEl = document.getElementById('couponMessage');
        if (couponMessageEl) {
            couponMessageEl.textContent = 'ì„ íƒëœ ì¿ í°ì´ ì—†ìŠµë‹ˆë‹¤';
        }
        const couponDiscountLabel = document.querySelector('.selected-coupon-discount');
        if (couponDiscountLabel) {
            couponDiscountLabel.textContent = '';
        }
        updatePaymentSummary();
    }

    function useAllPoints() {
        const pointInput = document.getElementById('pointInput');
        if (pointInput) {
            pointInput.value = availablePoints;
            calculateTotal();
        }
    }

    function calculateTotal() {
        updatePaymentSummary();
    }

    function updatePaymentSummary() {
        let couponDiscount = 0;
        if (selectedCouponData) {
            if (selectedCouponData.calculatedDiscountAmount != null) {
                couponDiscount = selectedCouponData.calculatedDiscountAmount;
            } else if (selectedCouponData.discountType) {
                couponDiscount = calculateDiscountAmount(selectedCouponData.discountType, selectedCouponData.discountValue);
            }
        }

        const discountedProductPrice = Math.max(0, totalPrice - couponDiscount);
        shippingCost = determineShippingCost(discountedProductPrice);

        const pointInput = document.getElementById('pointInput');
        const usedPointsRaw = pointInput ? parseInt(pointInput.value, 10) || 0 : 0;
        const payableBeforePoints = Math.max(0, totalPrice + shippingCost - couponDiscount);
        const maxUsablePoints = Math.min(availablePoints, payableBeforePoints);
        const validUsedPoints = Math.min(usedPointsRaw, maxUsablePoints);

        if (pointInput && usedPointsRaw !== validUsedPoints) {
            pointInput.value = validUsedPoints;
        }

        const shippingFeeEl = document.getElementById('shippingFee');
        if (shippingFeeEl) {
            shippingFeeEl.textContent = shippingCost > 0 ? `${formatPrice(shippingCost)}ì›` : 'ë¬´ë£Œë°°ì†¡';
        }

        const couponDiscountEl = document.querySelector('[data-role="coupon-discount"]');
        if (couponDiscountEl) {
            couponDiscountEl.textContent = couponDiscount > 0 ? `-${formatPrice(couponDiscount)}ì›` : '0ì›';
        }

        const pointsDiscountEl = document.querySelector('[data-role="points-discount"]');
        if (pointsDiscountEl) {
            pointsDiscountEl.textContent = validUsedPoints > 0 ? `-${formatPrice(validUsedPoints)}ì›` : '0ì›';
        }

        const finalAmount = Math.max(0, totalPrice + shippingCost - couponDiscount - validUsedPoints);
        currentFinalAmount = finalAmount;
        currentUsedPoints = validUsedPoints;

        const totalPriceEl = document.querySelector('.total-price');
        if (totalPriceEl) {
            totalPriceEl.textContent = `${formatPrice(finalAmount)} ì›`;
        }

        const paymentBtn = document.querySelector('.payment-btn');
        if (paymentBtn) {
            paymentBtn.textContent = `${formatPrice(finalAmount)}ì› ê²°ì œí•˜ê¸°`;
        }

        const earnPoints = Math.floor(finalAmount * 0.01);
        const installmentEl = document.querySelector('.installment-text');
        if (installmentEl) {
            installmentEl.textContent = `${formatPrice(earnPoints)} P ì ë¦½ ì˜ˆì •`;
        }
    }

    async function handlePaymentButtonClick(event) {
        event.preventDefault();

        if (currentFinalAmount < 100) {
            alert('ìµœì¢… ê²°ì œ ê¸ˆì•¡ì€ 100ì› ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
            return;
        }

        try {
            validateRecipientInfo();
        } catch (error) {
            alert(error.message);
            return;
        }

        await processPayment(currentFinalAmount, selectedCouponData, currentUsedPoints);
    }

    function collectOrderItemsData() {
        const items = [];
        const totalItemsCount = parseInt(document.getElementById('totalItemsCount').value) || 0;

        for (let index = 0; index < totalItemsCount; index++) {
            const productIdElement = document.getElementById(`item-${index}-productId`);
            const productOptionIdElement = document.getElementById(`item-${index}-productOptionId`);
            const quantityElement = document.getElementById(`item-${index}-quantity`);
            const priceElement = document.getElementById(`item-${index}-price`);
            const productNameElement = document.getElementById(`item-${index}-productName`);

            if (!productIdElement || !quantityElement || !priceElement) {
                continue;
            }

            const productId = Number(productIdElement.value);
            const quantity = Number(quantityElement.value);
            const priceValue = priceElement.value;
            const priceNumber = Number(priceValue);

            if (Number.isNaN(productId) || Number.isNaN(quantity) || Number.isNaN(priceNumber)) {
                continue;
            }

            const optionRaw = productOptionIdElement ? productOptionIdElement.value : null;
            const optionValue = optionRaw && optionRaw !== 'null' && optionRaw !== 'default'
                ? Number(optionRaw)
                : null;

            items.push({
                productId,
                productOptionId: optionValue,
                quantity,
                price: priceValue,
                productName: productNameElement ? productNameElement.value : ''
            });
        }

        return items;
    }

    function buildOrderPayload(finalAmount, couponData, usedPoints) {
        const orderItems = collectOrderItemsData();
        if (!orderItems.length) {
            throw new Error('ì£¼ë¬¸í•  ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.');
        }

        const couponDiscount = couponData
            ? (couponData.calculatedDiscountAmount != null
                ? couponData.calculatedDiscountAmount
                : calculateDiscountAmount(couponData.discountType, couponData.discountValue))
            : 0;

        const paymentOrderId = `ORDER-${Date.now()}`;
        let fallbackOrderName = 'ìƒí’ˆ ì£¼ë¬¸';
        const fallbackNameElement = document.querySelector('.order-item .item-name');
        if (fallbackNameElement && typeof fallbackNameElement.textContent === 'string') {
            const trimmed = fallbackNameElement.textContent.trim();
            if (trimmed.length > 0) {
                fallbackOrderName = trimmed;
            }
        }

        const orderName = orderItems[0].productName || fallbackOrderName;
        const sanitizedFinalAmount = Math.max(Math.round(finalAmount || 0), 0);

        if (sanitizedFinalAmount < 100) {
            throw new Error('ìµœì¢… ê²°ì œ ê¸ˆì•¡ì€ 100ì› ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
        }

        return {
            paymentOrderId,
            orderItems,
            userCouponId: couponData ? couponData.userCouponId : null,
            couponDiscountAmount: couponDiscount,
            usedPoints: usedPoints || 0,
            finalAmount: sanitizedFinalAmount,
            orderName,
            customerEmail,
            customerName
        };
    }

    async function processPayment(finalAmount, couponData, usedPoints) {
        try {
            const orderPayload = buildOrderPayload(finalAmount, couponData, usedPoints);

            sessionStorage.removeItem('pendingOrderPayload');
            sessionStorage.setItem('pendingOrderPayload', JSON.stringify(orderPayload));

            await PaymentSdk.processTossPayment({
                orderId: orderPayload.paymentOrderId,
                finalAmount: orderPayload.finalAmount,
                orderName: orderPayload.orderName,
                customerEmail: orderPayload.customerEmail,
                customerName: orderPayload.customerName
            });
        } catch (error) {
            console.error('ê²°ì œ ìš”ì²­ ì¤‘ ì˜¤ë¥˜:', error);
            sessionStorage.removeItem('pendingOrderPayload');
            alert(error.message || 'ê²°ì œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
        }
    }

    function formatPrice(price) {
        if (price === null || price === undefined || isNaN(price)) {
            return '0';
        }
        return Number(price).toLocaleString('ko-KR');
    }

    function formatDate(dateString) {
        if (!dateString) return '';
        const date = new Date(dateString);
        return date.toLocaleDateString('ko-KR');
    }

    function escapeQuotes(str) {
        if (!str) return '';
        return str.replace(/'/g, "'").replace(/"/g, '"');
    }

    window.onclick = function(event) {
        const modal = document.getElementById('couponModal');
        if (event.target === modal) {
            closeCouponModal();
        }
        
        const addressModal = document.getElementById('addressModal');
        if (event.target === addressModal) {
            closeAddressModal();
        }

        const addressFormModal = document.getElementById('addressFormModal');
        if (event.target === addressFormModal) {
            closeAddressFormModal();
        }
    }
</script>
</body>
</html>
