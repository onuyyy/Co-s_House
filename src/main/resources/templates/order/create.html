<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns="http://www.w3.org/1999/html">
<head th:replace="~{fragments/layout :: head('ì£¼ë¬¸/ê²°ì œ | ì½”ë”©ì˜ ì§‘')}"></head>
<link rel="stylesheet" th:href="@{/css/order.css}">
<body class="page font-body">
<header th:replace="fragments/layout :: header"></header>

<!-- Main Content -->
<main class="main-content">
    <div class="page-card">
<!--        <h1 class="page-title">ì£¼ë¬¸/ê²°ì œ</h1>-->

        <div class="order-layout">
            <!-- ì™¼ìª½ ì„¹ì…˜ -->
            <div class="left-section">

                <!-- ì£¼ë¬¸ì ì •ë³´ ì„¹ì…˜ -->
                <section class="section-card" aria-labelledby="orderer-info-title">
                    <div class="section-head">
                        <h2 id="orderer-info-title" class="section-title">ì£¼ë¬¸ì ì •ë³´</h2>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="orderer-name">ì£¼ë¬¸ìëª…</label>
                        <input type="text" id="orderer-name" class="input" th:value="${order.user.userName}" readonly>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="orderer-phone">ì—°ë½ì²˜</label>
                        <input type="text" id="orderer-phone" class="input" th:value="${order.user.phone}" readonly>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="orderer-email">ì´ë©”ì¼</label>
                        <input type="text" id="orderer-email" class="input" th:value="${order.user.userEmail}" readonly>
                    </div>
                </section>

                <!-- ë°°ì†¡ì§€ ì •ë³´ ì„¹ì…˜ -->
                <section class="section-card" aria-labelledby="delivery-info-title">
                    <div class="section-head">
                        <h2 id="delivery-info-title" class="section-title">
                            ë°°ì†¡ì§€ ì •ë³´
                            <button type="button" class="coupon-link">ë³€ê²½</button>
                        </h2>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="recipient-name">ë°›ëŠ” ë¶„</label>
                        <input type="text" id="recipient-name" class="input" th:value="${order.user.userName}" readonly>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="recipient-phone">ì—°ë½ì²˜</label>
                        <input type="text" id="recipient-phone" class="input" th:value="${order.user.phone}" readonly>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="recipient-address">ì£¼ì†Œ</label>
                        <input type="text" id="recipient-address" class="input" th:value="${order.user.address}" readonly>
                    </div>

                    <div class="form-group">
                        <button type="button" class="address-search-btn">ê¸°ë³¸ ë°°ì†¡ì§€ë¡œ ì €ì¥</button>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="delivery-request">ë°°ì†¡ ìš”ì²­ì‚¬í•­</label>
                        <select id="delivery-request" class="input">
                            <option>ë°°ì†¡ì‹œ ìš”ì²­ì‚¬í•­ì„ ì„ íƒí•´ì£¼ì„¸ìš”</option>
                            <option>ë¬¸ ì•ì— ë†“ì•„ì£¼ì„¸ìš”</option>
                            <option>ê²½ë¹„ì‹¤ì— ë§¡ê²¨ì£¼ì„¸ìš”</option>
                            <option>íƒë°°ë³´ê´€í•¨ì— ë„£ì–´ì£¼ì„¸ìš”</option>
                            <option>ì§ì ‘ ë°›ê² ìŠµë‹ˆë‹¤</option>
                        </select>
                    </div>
                </section>

                <!-- ì£¼ë¬¸ ìƒí’ˆ ì •ë³´ ì„¹ì…˜ -->
                <section class="section-card" aria-labelledby="order-items-title">
                    <div class="section-head">
                        <h2 id="order-items-title" class="section-title">
                            ì£¼ë¬¸ ìƒí’ˆ ì •ë³´
                            <span class="item-count" th:text="${#lists.size(order.items)} + 'ê±´'">1ê±´</span>
                        </h2>
                    </div>

                    <div class="order-items">
                        <div class="order-item" th:each="item : ${order.items}">
                            <div class="item-info">
                                <div class="item-image">
                                    <div class="product-img-placeholder">ğŸ“¦</div>
                                </div>
                                <div class="item-details">
                                    <h3 class="item-name" th:text="${item.productName}">ìƒí’ˆëª…</h3>
                                    <p class="item-option" th:if="${item.productOptionName != null}" th:text="${item.productOptionName}">ì˜µì…˜ëª…</p>
                                    <p class="item-quantity" th:text="'ìˆ˜ëŸ‰: ' + ${item.quantity} + 'ê°œ'">ìˆ˜ëŸ‰: 0ê°œ</p>
                                </div>
                            </div>
                            <div class="item-shipping">
                                <p class="item-price" th:text="${#numbers.formatDecimal(item.price, 0, 'COMMA', 0, 'POINT')} + 'ì›'">139,000ì›</p>
                                <span class="shipping-label">ë¬´ë£Œë°°ì†¡</span>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- í¬ì¸íŠ¸/ì¿ í° ì •ë³´ ì„¹ì…˜ -->
                <section class="section-card" aria-labelledby="discount-info-title">
                    <div class="section-head">
                        <h2 id="discount-info-title" class="section-title">í¬ì¸íŠ¸/ì¿ í° ì •ë³´</h2>
                    </div>

                    <!-- ì¿ í° ë¶€ë¶„ -->
                    <div class="coupon-section">
                        <h3 class="sub-section-title">ì¿ í°</h3>
                        <div class="coupon-selected" id="selectedCoupon" style="display: none;">
                            <div class="selected-coupon-info">
                                <span class="selected-coupon-name"></span>
                                <span class="selected-coupon-discount"></span>
                            </div>
                            <button type="button" class="coupon-cancel-btn" onclick="cancelCoupon()">ì·¨ì†Œ</button>
                        </div>
                        <p class="coupon-message" id="couponMessage">ì„ íƒëœ ì¿ í°ì´ ì—†ìŠµë‹ˆë‹¤</p>
                        <button type="button" class="coupon-link" onclick="openCouponModal()">ë‚´ ì¿ í° ëª©ë¡ ë³´ê¸°</button>
                    </div>

                    <!-- í¬ì¸íŠ¸ ë¶€ë¶„ -->
                    <div class="point-section">
                        <h3 class="sub-section-title">í¬ì¸íŠ¸</h3>
                        <div class="point-input-group">
                            <input type="number" id="pointInput" class="point-input" placeholder="0" value="0" min="0" onchange="calculateTotal()">
                            <button type="button" class="point-all-btn" onclick="useAllPoints()">ì „ì•¡ ì‚¬ìš©</button>
                        </div>
                        <p class="point-available">ì‚¬ìš© ê°€ëŠ¥ í¬ì¸íŠ¸ <span class="point-amount">155,555 P</span></p>
                    </div>
                </section>
            </div>

            <!-- ì˜¤ë¥¸ìª½ ì„¹ì…˜ - ê²°ì œ ê¸ˆì•¡ -->
            <aside class="right-section">
                <div class="payment-summary" aria-labelledby="payment-summary-title">
                    <h2 id="payment-summary-title" class="summary-title">ê²°ì œê¸ˆì•¡</h2>

                    <div class="price-row">
                        <span class="price-label">ì´ ìƒí’ˆ ê¸ˆì•¡</span>
                        <span class="price-value" th:text="${#numbers.formatDecimal(order.totalPrice, 0, 'COMMA', 0, 'POINT')} + 'ì›'">139,000ì›</span>
                    </div>

                    <div class="price-row">
                        <span class="price-label">ë°°ì†¡ë¹„</span>
                        <span class="price-value" id="shippingFee">0ì›</span>
                    </div>

                    <div class="price-row">
                        <span class="price-label">ì¿ í° ì‚¬ìš©</span>
                        <span class="price-value" data-role="coupon-discount" style="color: var(--success-color);">0ì›</span>
                    </div>

                    <div class="price-row">
                        <span class="price-label">í¬ì¸íŠ¸ ì‚¬ìš©</span>
                        <span class="price-value" data-role="points-discount" style="color: var(--success-color);">0ì›</span>
                    </div>
                    <div class="total-row"></div>
                        <div class="total-amount-row">
                            <span class="total-label">ìµœì¢… ê²°ì œ ê¸ˆì•¡</span>
                            <span class="total-price" th:text="${#numbers.formatDecimal(order.totalAmount, 0, 'COMMA', 0, 'POINT')} + ' ì›'">179,000 ì›</span>
                        </div>
                        <span class="installment-text">139 P ì ë¦½ ì˜ˆì •</span>

                    <button type="button" class="payment-btn" th:text="${#numbers.formatDecimal(order.totalAmount, 0, 'COMMA', 0, 'POINT')} + 'ì› ê²°ì œí•˜ê¸°'">179,000 ì› ê²°ì œí•˜ê¸°</button>
                    <p class="terms-notice">
                        ğŸ’¡ <strong>ê²°ì œ ì•ˆë‚´:</strong> ë¸Œëœë“œë³„ ìµœì  ì¿ í°ì´ ìë™ ì ìš©ë©ë‹ˆë‹¤.
                        ì´ë²¤íŠ¸ ì¿ í°ì„ ë°œê¸‰í•˜ì—¬ í• ì¸ ë°›ìœ¼ì„¸ìš”!
                    </p>

                </div>
            </aside>
        </div>
    </div>
</main>

<!-- ì¿ í° ëª¨ë‹¬ -->
<div id="couponModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>ë‚´ ì¿ í° ëª©ë¡</h2>
            <button type="button" class="close" onclick="closeCouponModal()" aria-label="ì¿ í° ëª¨ë‹¬ ë‹«ê¸°">&times;</button>
        </div>
        <div class="modal-body">
            <div id="couponList" class="coupon-list">
                <div class="loading-message">ì¿ í°ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            </div>
        </div>
    </div>
</div>

<footer th:replace="fragments/layout :: footer"></footer>

<!-- Hidden form with order data for JavaScript -->
<div id="hiddenOrderData" style="display: none;">
    <div th:each="item, itemStat : ${order.items}">
        <input type="hidden" th:id="'item-' + ${itemStat.index} + '-productId'" th:value="${item.productId}" />
        <input type="hidden" th:id="'item-' + ${itemStat.index} + '-productOptionId'" th:value="${item.productOptionId}" />
        <input type="hidden" th:id="'item-' + ${itemStat.index} + '-quantity'" th:value="${item.quantity}" />
        <input type="hidden" th:id="'item-' + ${itemStat.index} + '-price'" th:value="${item.price}" />
        <input type="hidden" th:id="'item-' + ${itemStat.index} + '-productName'" th:value="${item.productName}" />
    </div>
    <input type="hidden" id="totalItemsCount" th:value="${#lists.size(order.items)}" />
</div>

<script src="/js/payment/checkout.js"></script>
<script th:inline="javascript">
    // ì „ì—­ ë³€ìˆ˜
    let selectedCouponData = null;
    const totalPrice = parseFloat('[[${ order.totalPrice }]]') || 0;
    let shippingCost = determineShippingCost(totalPrice);
    let availablePoints = 0;
    const customerEmail = /*[[${order.user.userEmail}]]*/ '';
    const customerName = /*[[${order.user.userName}]]*/ '';
    let currentFinalAmount = totalPrice + shippingCost;
    let currentUsedPoints = 0;

    const orderProductIds = getOrderProductIds();

    document.addEventListener('DOMContentLoaded', async function() {
        await loadUserPoints();
        updatePaymentSummary();

        const paymentBtn = document.querySelector('.payment-btn');
        if (paymentBtn) {
            paymentBtn.addEventListener('click', handlePaymentButtonClick);
        }
    });

    function determineShippingCost(productAmount) {
        const freeShippingThreshold = 30000;
        return productAmount >= freeShippingThreshold ? 0 : 3000;
    }

    function getOrderProductIds() {
        const totalItemsCount = parseInt(document.getElementById('totalItemsCount').value) || 0;
        const productIds = [];

        for (let index = 0; index < totalItemsCount; index++) {
            const productIdElement = document.getElementById(`item-${index}-productId`);
            if (productIdElement && productIdElement.value) {
                productIds.push(parseInt(productIdElement.value, 10));
            }
        }

        return productIds;
    }

    async function loadUserPoints() {
        try {
            const response = await fetch('/order/my-points');
            const data = await response.json();

            if (data.success) {
                availablePoints = data.totalPoints || 0;
            } else {
                availablePoints = 0;
                console.error('í¬ì¸íŠ¸ ë¡œë”© ì‹¤íŒ¨:', data.message);
            }
        } catch (error) {
            availablePoints = 0;
            console.error('í¬ì¸íŠ¸ ë¡œë”© ì¤‘ ì˜¤ë¥˜:', error);
        } finally {
            const pointAmountEl = document.querySelector('.point-amount');
            if (pointAmountEl) {
                pointAmountEl.textContent = `${formatPrice(availablePoints)} P`;
            }
            const pointInput = document.getElementById('pointInput');
            if (pointInput) {
                pointInput.max = availablePoints;
            }
        }
    }

    function openCouponModal() {
        document.getElementById('couponModal').style.display = 'block';
        document.body.style.overflow = 'hidden';
        loadMyCoupons();
    }

    function closeCouponModal() {
        document.getElementById('couponModal').style.display = 'none';
        document.body.style.overflow = '';
    }

    async function loadMyCoupons() {
        try {
            const productIdsParam = orderProductIds.length > 0
                ? `?${orderProductIds.map(id => `productIds=${id}`).join('&')}`
                : '';

            const response = await fetch(`/order/my-coupons${productIdsParam}`);
            const coupons = await response.json();

            const couponList = document.getElementById('couponList');

            if (coupons.length === 0) {
                couponList.innerHTML = '<div class="no-coupons">ì‚¬ìš© ê°€ëŠ¥í•œ ì¿ í°ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            couponList.innerHTML = coupons.map(coupon => {
                const isUsable = coupon.usable;
                const discountAmount = coupon.coupon.discountAmount || 0;
                const discountRate = coupon.coupon.discountRate || 0;

                let discountType = 'AMOUNT';
                let discountValue = discountAmount;
                let discountText = '';

                if (discountAmount > 0) {
                    discountType = 'AMOUNT';
                    discountValue = discountAmount;
                    discountText = `${formatPrice(discountAmount)}ì› í• ì¸`;
                } else if (discountRate > 0) {
                    discountType = 'RATE';
                    discountValue = discountRate;
                    discountText = `${discountRate}% í• ì¸`;
                } else {
                    discountText = 'í• ì¸ ì •ë³´ ì—†ìŒ';
                }

                return `
                    <div class="coupon-item ${!isUsable ? 'disabled' : ''}">
                        <div class="coupon-info">
                            <div class="coupon-title">${coupon.coupon.couponTitle || ''}</div>
                            <div class="coupon-description">${coupon.coupon.couponDescription || ''}</div>
                            <div class="coupon-discount-type">${discountType === 'AMOUNT' ? 'ê¸ˆì•¡í• ì¸' : 'í¼ì„¼íŠ¸í• ì¸'}</div>
                            <div class="coupon-discount">${discountText}</div>
                            <div class="coupon-expire">ë§Œë£Œì¼: ${formatDate(coupon.coupon.expiredAt)}</div>
                        </div>
                        <button
                            class="coupon-use-btn ${!isUsable ? 'disabled' : ''}"
                            onclick="applyCoupon(${coupon.userCouponId}, '${escapeQuotes(coupon.coupon.couponTitle)}', '${discountType}', ${discountValue})"
                            ${!isUsable ? 'disabled' : ''}
                        >
                            ${isUsable ? 'ì ìš©í•˜ê¸°' : 'ì‚¬ìš©ë¶ˆê°€'}
                        </button>
                    </div>
                `;
            }).join('');
        } catch (error) {
            console.error('ì¿ í° ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
            document.getElementById('couponList').innerHTML = '<div class="error-message">ì¿ í° ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
        }
    }

    async function applyCoupon(userCouponId, couponTitle, discountType, discountValue) {
        try {
            const currentOrderAmount = totalPrice + shippingCost;
            const response = await fetch(`/order/my-coupons/${userCouponId}?orderAmount=${currentOrderAmount}`);

            if (!response.ok) {
                const errorText = await response.text();
                console.error('ì¿ í° ê²€ì¦ ì‹¤íŒ¨:', response.status, errorText);

                if (response.status === 400) {
                    alert('ì¿ í°ì´ ë§Œë£Œë˜ì—ˆê±°ë‚˜ ì´ë¯¸ ì‚¬ìš©ëœ ì¿ í°ì…ë‹ˆë‹¤.');
                } else if (response.status === 404) {
                    alert('ì¿ í°ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                } else {
                    alert('ì¿ í° ê²€ì¦ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                }
                return;
            }

            const couponInfo = await response.json();

            if (!couponInfo.applicable) {
                alert(`ì´ ì¿ í°ì€ ìµœì†Œ ì£¼ë¬¸ ê¸ˆì•¡ ${formatPrice(couponInfo.minPurchaseAmount)}ì› ì´ìƒë¶€í„° ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.`);
                return;
            }

            const actualDiscount = Number(couponInfo.calculatedDiscountAmount) || 0;
            const finalAmountFromServer = Number(couponInfo.finalAmount) || 0;

            selectedCouponData = {
                userCouponId: userCouponId,
                title: couponTitle,
                discountType: discountType,
                discountValue: discountValue,
                calculatedDiscountAmount: actualDiscount,
                finalAmount: finalAmountFromServer
            };

            document.getElementById('selectedCoupon').style.display = 'flex';
            document.getElementById('couponMessage').textContent = 'ì¿ í°ì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.';
            document.querySelector('.selected-coupon-name').textContent = couponTitle;

            if (discountType === 'RATE') {
                document.querySelector('.selected-coupon-discount').textContent = `-${discountValue}% (${formatPrice(actualDiscount)}ì›)`;
            } else {
                document.querySelector('.selected-coupon-discount').textContent = `-${formatPrice(actualDiscount)}ì›`;
            }

            updatePaymentSummary();
            closeCouponModal();
        } catch (error) {
            console.error('ì¿ í° ì ìš© ì¤‘ ì˜¤ë¥˜:', error);
            alert('ì¿ í° ì ìš© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        }
    }

    function calculateDiscountAmount(discountType, discountValue) {
        if (discountType === 'RATE') {
            return Math.floor((totalPrice + shippingCost) * (discountValue / 100));
        }
        return discountValue;
    }

    function cancelCoupon() {
        selectedCouponData = null;
        const selectedCouponEl = document.getElementById('selectedCoupon');
        if (selectedCouponEl) {
            selectedCouponEl.style.display = 'none';
        }
        const couponMessageEl = document.getElementById('couponMessage');
        if (couponMessageEl) {
            couponMessageEl.textContent = 'ì„ íƒëœ ì¿ í°ì´ ì—†ìŠµë‹ˆë‹¤';
        }
        const couponDiscountLabel = document.querySelector('.selected-coupon-discount');
        if (couponDiscountLabel) {
            couponDiscountLabel.textContent = '';
        }
        updatePaymentSummary();
    }

    function useAllPoints() {
        const pointInput = document.getElementById('pointInput');
        if (pointInput) {
            pointInput.value = availablePoints;
            calculateTotal();
        }
    }

    function calculateTotal() {
        updatePaymentSummary();
    }

    function updatePaymentSummary() {
        let couponDiscount = 0;
        if (selectedCouponData) {
            if (selectedCouponData.calculatedDiscountAmount != null) {
                couponDiscount = selectedCouponData.calculatedDiscountAmount;
            } else if (selectedCouponData.discountType) {
                couponDiscount = calculateDiscountAmount(selectedCouponData.discountType, selectedCouponData.discountValue);
            }
        }

        const discountedProductPrice = Math.max(0, totalPrice - couponDiscount);
        shippingCost = determineShippingCost(discountedProductPrice);

        const pointInput = document.getElementById('pointInput');
        const usedPointsRaw = pointInput ? parseInt(pointInput.value, 10) || 0 : 0;
        const payableBeforePoints = Math.max(0, totalPrice + shippingCost - couponDiscount);
        const maxUsablePoints = Math.min(availablePoints, payableBeforePoints);
        const validUsedPoints = Math.min(usedPointsRaw, maxUsablePoints);

        if (pointInput && usedPointsRaw !== validUsedPoints) {
            pointInput.value = validUsedPoints;
        }

        const shippingFeeEl = document.getElementById('shippingFee');
        if (shippingFeeEl) {
            shippingFeeEl.textContent = shippingCost > 0 ? `${formatPrice(shippingCost)}ì›` : 'ë¬´ë£Œë°°ì†¡';
        }

        const couponDiscountEl = document.querySelector('[data-role="coupon-discount"]');
        if (couponDiscountEl) {
            couponDiscountEl.textContent = couponDiscount > 0 ? `-${formatPrice(couponDiscount)}ì›` : '0ì›';
        }

        const pointsDiscountEl = document.querySelector('[data-role="points-discount"]');
        if (pointsDiscountEl) {
            pointsDiscountEl.textContent = validUsedPoints > 0 ? `-${formatPrice(validUsedPoints)}ì›` : '0ì›';
        }

        const finalAmount = Math.max(0, totalPrice + shippingCost - couponDiscount - validUsedPoints);
        currentFinalAmount = finalAmount;
        currentUsedPoints = validUsedPoints;

        const totalPriceEl = document.querySelector('.total-price');
        if (totalPriceEl) {
            totalPriceEl.textContent = `${formatPrice(finalAmount)} ì›`;
        }

        const paymentBtn = document.querySelector('.payment-btn');
        if (paymentBtn) {
            paymentBtn.textContent = `${formatPrice(finalAmount)}ì› ê²°ì œí•˜ê¸°`;
        }

        const earnPoints = Math.floor(finalAmount * 0.01);
        const installmentEl = document.querySelector('.installment-text');
        if (installmentEl) {
            installmentEl.textContent = `${formatPrice(earnPoints)} P ì ë¦½ ì˜ˆì •`;
        }
    }

    async function handlePaymentButtonClick(event) {
        event.preventDefault();

        if (currentFinalAmount < 100) {
            alert('ìµœì¢… ê²°ì œ ê¸ˆì•¡ì€ 100ì› ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
            return;
        }

        await processPayment(currentFinalAmount, selectedCouponData, currentUsedPoints);
    }

    function collectOrderItemsData() {
        const items = [];
        const totalItemsCount = parseInt(document.getElementById('totalItemsCount').value) || 0;

        for (let index = 0; index < totalItemsCount; index++) {
            const productIdElement = document.getElementById(`item-${index}-productId`);
            const productOptionIdElement = document.getElementById(`item-${index}-productOptionId`);
            const quantityElement = document.getElementById(`item-${index}-quantity`);
            const priceElement = document.getElementById(`item-${index}-price`);
            const productNameElement = document.getElementById(`item-${index}-productName`);

            if (!productIdElement || !quantityElement || !priceElement) {
                continue;
            }

            const productId = Number(productIdElement.value);
            const quantity = Number(quantityElement.value);
            const priceValue = priceElement.value;
            const priceNumber = Number(priceValue);

            if (Number.isNaN(productId) || Number.isNaN(quantity) || Number.isNaN(priceNumber)) {
                continue;
            }

            const optionRaw = productOptionIdElement ? productOptionIdElement.value : null;
            const optionValue = optionRaw && optionRaw !== 'null' && optionRaw !== 'default'
                ? Number(optionRaw)
                : null;

            items.push({
                productId,
                productOptionId: optionValue,
                quantity,
                price: priceValue,
                productName: productNameElement ? productNameElement.value : ''
            });
        }

        return items;
    }

    function buildOrderPayload(finalAmount, couponData, usedPoints) {
        const orderItems = collectOrderItemsData();
        if (!orderItems.length) {
            throw new Error('ì£¼ë¬¸í•  ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.');
        }

        const couponDiscount = couponData
            ? (couponData.calculatedDiscountAmount != null
                ? couponData.calculatedDiscountAmount
                : calculateDiscountAmount(couponData.discountType, couponData.discountValue))
            : 0;

        const paymentOrderId = `ORDER-${Date.now()}`;
        let fallbackOrderName = 'ìƒí’ˆ ì£¼ë¬¸';
        const fallbackNameElement = document.querySelector('.order-item .item-name');
        if (fallbackNameElement && typeof fallbackNameElement.textContent === 'string') {
            const trimmed = fallbackNameElement.textContent.trim();
            if (trimmed.length > 0) {
                fallbackOrderName = trimmed;
            }
        }

        const orderName = orderItems[0].productName || fallbackOrderName;
        const sanitizedFinalAmount = Math.max(Math.round(finalAmount || 0), 0);

        if (sanitizedFinalAmount < 100) {
            throw new Error('ìµœì¢… ê²°ì œ ê¸ˆì•¡ì€ 100ì› ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
        }

        return {
            paymentOrderId,
            orderItems,
            userCouponId: couponData ? couponData.userCouponId : null,
            couponDiscountAmount: couponDiscount,
            usedPoints: usedPoints || 0,
            finalAmount: sanitizedFinalAmount,
            orderName,
            customerEmail,
            customerName
        };
    }

    async function processPayment(finalAmount, couponData, usedPoints) {
        try {
            const orderPayload = buildOrderPayload(finalAmount, couponData, usedPoints);

            sessionStorage.removeItem('pendingOrderPayload');
            sessionStorage.setItem('pendingOrderPayload', JSON.stringify(orderPayload));

            await PaymentSdk.processTossPayment({
                orderId: orderPayload.paymentOrderId,
                finalAmount: orderPayload.finalAmount,
                orderName: orderPayload.orderName,
                customerEmail: orderPayload.customerEmail,
                customerName: orderPayload.customerName
            });
        } catch (error) {
            console.error('ê²°ì œ ìš”ì²­ ì¤‘ ì˜¤ë¥˜:', error);
            sessionStorage.removeItem('pendingOrderPayload');
            alert(error.message || 'ê²°ì œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
        }
    }

    function formatPrice(price) {
        if (price === null || price === undefined || isNaN(price)) {
            return '0';
        }
        return Number(price).toLocaleString('ko-KR');
    }

    function formatDate(dateString) {
        if (!dateString) return '';
        const date = new Date(dateString);
        return date.toLocaleDateString('ko-KR');
    }

    function escapeQuotes(str) {
        if (!str) return '';
        return str.replace(/'/g, "\\'").replace(/"/g, '\\"');
    }

    window.onclick = function(event) {
        const modal = document.getElementById('couponModal');
        if (event.target === modal) {
            closeCouponModal();
        }
    }
</script>
</body>
</html>

<!--<!doctype html>-->
<!--<html lang="ko" xmlns:th="http://www.thymeleaf.org">-->
<!--<head th:replace="~{fragments/layout :: head('ì£¼ë¬¸/ê²°ì œ')}"></head>-->
<!--&lt;!&ndash; í˜ì´ì§€ ì „ìš© CSS ì¶”ê°€ &ndash;&gt;-->
<!--<link rel="stylesheet" th:href="@{/css/order.css}">-->
<!--<body class="page font-body">-->
<!--  <div th:replace="~{fragments/layout :: header}"></div>-->

<!--  &lt;!&ndash; Main Content &ndash;&gt;-->
<!--  <section class="items-card" aria-labelledby="page-title">-->
<!--      <div class="section-head">-->

<!--    <div class="order-layout">-->
<!--      &lt;!&ndash; ì™¼ìª½ ì„¹ì…˜ &ndash;&gt;-->
<!--      <div class="left-section">-->

<!--        &lt;!&ndash; ì£¼ë¬¸ ê²°ì œ / ì£¼ë¬¸ì ì •ë³´ ì„¹ì…˜ &ndash;&gt;-->
<!--        <div class="section-card">-->
<!--          <h2 class="section-title">ì£¼ë¬¸ ê²°ì œ / ì£¼ë¬¸ì ì •ë³´</h2>-->

<!--          <div class="form-group">-->
<!--            <label class="form-label">ì£¼ë¬¸ìëª…</label>-->
<!--            <input type="text" class="input" th:value="${order.user.userName}" readonly>-->
<!--          </div>-->

<!--          <div class="form-group">-->
<!--            <label class="form-label">ì—°ë½ì²˜</label>-->
<!--            <input type="text" class="input" th:value="${order.user.phone}" readonly>-->
<!--          </div>-->

<!--          <div class="form-group">-->
<!--            <label class="form-label">ì´ë©”ì¼</label>-->
<!--            <input type="text" class="input" th:value="${order.user.userEmail}" readonly>-->
<!--          </div>-->
<!--        </div>-->

<!--        &lt;!&ndash; ë°°ì†¡ì§€ ì •ë³´ ì„¹ì…˜ &ndash;&gt;-->
<!--        <div class="section-card">-->
<!--          <h2 class="section-title">ë°°ì†¡ì§€ ì •ë³´-->
<!--            <button type="button" class="coupon-link">ë³€ê²½</button>-->
<!--          </h2>-->

<!--          <div class="form-group">-->
<!--            <label class="form-label">ë°›ëŠ” ë¶„</label>-->
<!--            <input type="text" class="input" th:value="${order.user.userName}" readonly>-->
<!--          </div>-->

<!--          <div class="form-group">-->
<!--            <label class="form-label">ì—°ë½ì²˜</label>-->
<!--            <input type="text" class="input" th:value="${order.user.phone}" readonly>-->
<!--          </div>-->

<!--          <div class="form-group">-->
<!--            <label class="form-label">ì£¼ì†Œ</label>-->
<!--            <input type="text" class="input" th:value="${order.user.address}" readonly>-->
<!--          </div>-->

<!--          <div class="form-group">-->
<!--            <button type="button" class="address-search-btn coupon-link">ê¸°ë³¸ ë°°ì†¡ì§€ë¡œ ì €ì¥</button>-->
<!--          </div>-->

<!--          <div class="form-group">-->
<!--            <label class="form-label">ë°°ì†¡ì‹œ ìš”ì²­ì‚¬í•­ì„ ì„ íƒí•´ì£¼ì„¸ìš”</label>-->
<!--            <select class="input">-->
<!--              <option>ë°°ì†¡ì‹œ ìš”ì²­ì‚¬í•­ì„ ì„ íƒí•´ì£¼ì„¸ìš”</option>-->
<!--              <option>ë¬¸ ì•ì— ë†“ì•„ì£¼ì„¸ìš”</option>-->
<!--              <option>ê²½ë¹„ì‹¤ì— ë§¡ê²¨ì£¼ì„¸ìš”</option>-->
<!--              <option>íƒë°°ë³´ê´€í•¨ì— ë„£ì–´ì£¼ì„¸ìš”</option>-->
<!--              <option>ì§ì ‘ ë°›ê² ìŠµë‹ˆë‹¤</option>-->
<!--            </select>-->
<!--          </div>-->
<!--        </div>-->

<!--        &lt;!&ndash; ì£¼ë¬¸ ìƒí’ˆ ì •ë³´ ì„¹ì…˜ &ndash;&gt;-->
<!--        <div class="section-card">-->
<!--          <h2 class="section-title">ì£¼ë¬¸ ìƒí’ˆ ì •ë³´-->
<!--            <span class="item-count" th:text="${#lists.size(order.items)} + 'ê±´'">1ê±´</span>-->
<!--          </h2>-->

<!--          <div class="order-items">-->
<!--            <div class="order-item" th:each="item : ${order.items}">-->
<!--              <div class="item-info">-->
<!--                <div class="item-image">-->
<!--                  <div class="product-img-placeholder">ğŸ“¦</div>-->
<!--                </div>-->
<!--                <div class="item-details">-->
<!--                  <p class="item-name" th:text="${item.productName}">ìƒí’ˆëª…</p>-->
<!--                  <p class="item-option" th:if="${item.productOptionName != null}" th:text="${item.productOptionName}">ì˜µì…˜ëª…</p>-->
<!--                  <p class="item-quantity" th:text="'ìˆ˜ëŸ‰: ' + ${item.quantity} + 'ê°œ'">ìˆ˜ëŸ‰: 0ê°œ</p>-->
<!--                </div>-->
<!--              </div>-->
<!--              <div class="item-shipping">-->
<!--                <div>-->
<!--                  <p class="item-price" th:text="${#numbers.formatDecimal(item.price, 0, 'COMMA', 0, 'POINT')} + 'ì›'">139,000ì›</p>-->
<!--                  <span class="shipping-label">ë¬´ë£Œë°°ì†¡</span>-->
<!--                </div>-->
<!--              </div>-->
<!--            </div>-->
<!--          </div>-->
<!--        </div>-->

<!--        &lt;!&ndash; í¬ì¸íŠ¸/ì¿ í° ì •ë³´ ì„¹ì…˜ &ndash;&gt;-->
<!--        <div class="section-card">-->
<!--          <h2 class="section-title">í¬ì¸íŠ¸/ì¿ í° ì •ë³´</h2>-->

<!--          &lt;!&ndash; ì¿ í° ë¶€ë¶„ &ndash;&gt;-->
<!--          <div class="coupon-section">-->
<!--            <h3 class="sub-section-title">ì¿ í°</h3>-->
<!--            <div class="coupon-selected" id="selectedCoupon" style="display: none;">-->
<!--              <div class="selected-coupon-info">-->
<!--                <span class="selected-coupon-name"></span>-->
<!--                <span class="selected-coupon-discount"></span>-->
<!--              </div>-->
<!--              <button type="button" class="coupon-cancel-btn" onclick="cancelCoupon()">ì·¨ì†Œ</button>-->
<!--            </div>-->
<!--            <p class="coupon-message" id="couponMessage">ì„ íƒëœ ì¿ í°ì´ ì—†ìŠµë‹ˆë‹¤</p>-->
<!--            <button type="button" class="coupon-link" onclick="openCouponModal()">ë‚´ ì¿ í° ëª©ë¡ ë³´ê¸°</button>-->
<!--          </div>-->

<!--          &lt;!&ndash; í¬ì¸íŠ¸ ë¶€ë¶„ &ndash;&gt;-->
<!--          <div class="point-section">-->
<!--            <h3 class="sub-section-title">í¬ì¸íŠ¸</h3>-->
<!--            <div class="point-input-group">-->
<!--              <input type="number" id="pointInput" class="point-input" placeholder="0" value="0" min="0" onchange="calculateTotal()">-->
<!--              <button type="button" class="point-all-btn coupon-link" onclick="useAllPoints()">ì „ì•¡ ì‚¬ìš©</button>-->
<!--            </div>-->
<!--            <p class="point-available">ì‚¬ìš© ê°€ëŠ¥ í¬ì¸íŠ¸ <span class="point-amount">155,555 P</span></p>-->
<!--          </div>-->
<!--        </div>-->
<!--      </div>-->

<!--      &lt;!&ndash; ì˜¤ë¥¸ìª½ ì„¹ì…˜ - ê²°ì œ ê¸ˆì•¡ &ndash;&gt;-->
<!--      <div class="right-section">-->
<!--        <div class="payment-summary">-->
<!--          <h2 class="summary-title">ê²°ì œê¸ˆì•¡</h2>-->

<!--          <div class="price-row">-->
<!--            <span class="price-label">ì´ ìƒí’ˆ ê¸ˆì•¡</span>-->
<!--            <span class="price-value" th:text="${#numbers.formatDecimal(order.totalPrice, 0, 'COMMA', 0, 'POINT')} + 'ì›'">139,000ì›</span>-->
<!--          </div>-->

<!--          <div class="price-row">-->
<!--            <span class="price-label">ë°°ì†¡ë¹„</span>-->
<!--            <span class="price-value" id="shippingFee">0ì›</span>-->
<!--          </div>-->

<!--          <div class="price-row">-->
<!--            <span class="price-label">ì¿ í° ì‚¬ìš©</span>-->
<!--            <span class="price-value" data-role="coupon-discount">0ì›</span>-->
<!--          </div>-->

<!--          <div class="price-row">-->
<!--            <span class="price-label">í¬ì¸íŠ¸ ì‚¬ìš©</span>-->
<!--            <span class="price-value" data-role="points-discount">0ì›</span>-->
<!--          </div>-->

<!--          <div class="total-row">-->
<!--            <span class="total-label">ìµœì¢… ê²°ì œ ê¸ˆì•¡</span>-->
<!--            <span class="total-price" th:text="${#numbers.formatDecimal(order.totalAmount, 0, 'COMMA', 0, 'POINT')} + ' ì›'">179,000 ì›</span>-->
<!--            <span class="installment-text">139 P ì ë¦½ ì˜ˆì •</span>-->
<!--          </div>-->

<!--          <div class="terms-notice">-->
<!--            ë°›ì•„ë³¼ í…ìŠ¤íŠ¸ ì œì•ˆ ì´í›„ì…ë‹ˆë‹¤, ì¶”í›„ ë‚´ìš©ì„ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.-->
<!--            <br><br>-->
<!--            ì´ìš©ì•½ê´€/ê²°ì œëŒ€í–‰ ë° ì‡¼í•‘ëª° ì´ìš©ì•½ê´€ ê°œì¸ì •ë³´ ìˆ˜ì§‘, ê²°ì œëŒ€í–‰ ì„œë¹„ìŠ¤ì™€ ë“± ì„œë¹„ìŠ¤ì— ëŒ€í•œ ì € ê³µì¸ ì‹œí‚¬ì¸ì¦ì„ í•„ì´ ë°©ë©´ ë‚´ìš©ì…ë‹ˆë‹¤.-->
<!--          </div>-->

<!--          <button type="button" class="payment-btn" th:text="${#numbers.formatDecimal(order.totalAmount, 0, 'COMMA', 0, 'POINT')} + 'ì› ê²°ì œí•˜ê¸°'">179,000 ì› ê²°ì œí•˜ê¸°</button>-->
<!--        </div>-->
<!--      </div>-->
<!--    </div>-->
<!--  </div>-->

<!--  &lt;!&ndash; ì¿ í° ëª¨ë‹¬ &ndash;&gt;-->
<!--  <div id="couponModal" class="modal">-->
<!--    <div class="modal-content">-->
<!--      <div class="modal-header">-->
<!--        <h2>ë‚´ ì¿ í° ëª©ë¡</h2>-->
<!--        <span class="close" onclick="closeCouponModal()">&times;</span>-->
<!--      </div>-->
<!--      <div class="modal-body">-->
<!--        <div id="couponList" class="coupon-list">-->
<!--          <div class="loading-message">ì¿ í°ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>-->
<!--        </div>-->
<!--      </div>-->
<!--    </div>-->
<!--  </div>-->

<!--  <div th:replace="~{fragments/layout :: footer}"></div>-->

<!--  &lt;!&ndash; Hidden form with order data for JavaScript &ndash;&gt;-->
<!--  <div id="hiddenOrderData" style="display: none;">-->
<!--    <div th:each="item, itemStat : ${order.items}">-->
<!--      <input type="hidden" th:id="'item-' + ${itemStat.index} + '-productId'" th:value="${item.productId}" />-->
<!--      <input type="hidden" th:id="'item-' + ${itemStat.index} + '-productOptionId'" th:value="${item.productOptionId}" />-->
<!--      <input type="hidden" th:id="'item-' + ${itemStat.index} + '-quantity'" th:value="${item.quantity}" />-->
<!--      <input type="hidden" th:id="'item-' + ${itemStat.index} + '-price'" th:value="${item.price}" />-->
<!--      <input type="hidden" th:id="'item-' + ${itemStat.index} + '-productName'" th:value="${item.productName}" />-->
<!--    </div>-->
<!--    <input type="hidden" id="totalItemsCount" th:value="${#lists.size(order.items)}" />-->
<!--  </div>-->

<!--  <script src="/js/payment/checkout.js"></script>-->
<!--  <script th:inline="javascript">-->
<!--    // ì „ì—­ ë³€ìˆ˜-->
<!--    let selectedCouponData = null;-->
<!--    const totalPrice = parseFloat('[[${ order.totalPrice }]]') || 0;-->
<!--    let shippingCost = determineShippingCost(totalPrice);-->
<!--    let availablePoints = 0;-->
<!--    const customerEmail = /*[[${order.user.userEmail}]]*/ '';-->
<!--    const customerName = /*[[${order.user.userName}]]*/ '';-->
<!--    let currentFinalAmount = totalPrice + shippingCost;-->
<!--    let currentUsedPoints = 0;-->

<!--    const orderProductIds = getOrderProductIds();-->

<!--    document.addEventListener('DOMContentLoaded', async function() {-->
<!--        await loadUserPoints();-->
<!--        updatePaymentSummary();-->

<!--        const paymentBtn = document.querySelector('.payment-btn');-->
<!--        if (paymentBtn) {-->
<!--            paymentBtn.addEventListener('click', handlePaymentButtonClick);-->
<!--        }-->
<!--    });-->

<!--    function determineShippingCost(productAmount) {-->
<!--        const freeShippingThreshold = 30000;-->
<!--        return productAmount >= freeShippingThreshold ? 0 : 3000;-->
<!--    }-->

<!--    function getOrderProductIds() {-->
<!--        const totalItemsCount = parseInt(document.getElementById('totalItemsCount').value) || 0;-->
<!--        const productIds = [];-->

<!--        for (let index = 0; index < totalItemsCount; index++) {-->
<!--            const productIdElement = document.getElementById(`item-${index}-productId`);-->
<!--            if (productIdElement && productIdElement.value) {-->
<!--                productIds.push(parseInt(productIdElement.value, 10));-->
<!--            }-->
<!--        }-->

<!--        return productIds;-->
<!--    }-->

<!--    async function loadUserPoints() {-->
<!--        try {-->
<!--            const response = await fetch('/order/my-points');-->
<!--            const data = await response.json();-->

<!--            if (data.success) {-->
<!--                availablePoints = data.totalPoints || 0;-->
<!--            } else {-->
<!--                availablePoints = 0;-->
<!--                console.error('í¬ì¸íŠ¸ ë¡œë”© ì‹¤íŒ¨:', data.message);-->
<!--            }-->
<!--        } catch (error) {-->
<!--            availablePoints = 0;-->
<!--            console.error('í¬ì¸íŠ¸ ë¡œë”© ì¤‘ ì˜¤ë¥˜:', error);-->
<!--        } finally {-->
<!--            const pointAmountEl = document.querySelector('.point-amount');-->
<!--            if (pointAmountEl) {-->
<!--                pointAmountEl.textContent = `${formatPrice(availablePoints)} P`;-->
<!--            }-->
<!--            const pointInput = document.getElementById('pointInput');-->
<!--            if (pointInput) {-->
<!--                pointInput.max = availablePoints;-->
<!--            }-->
<!--        }-->
<!--    }-->

<!--    function openCouponModal() {-->
<!--        document.getElementById('couponModal').style.display = 'block';-->
<!--        loadMyCoupons();-->
<!--    }-->

<!--    function closeCouponModal() {-->
<!--        document.getElementById('couponModal').style.display = 'none';-->
<!--    }-->

<!--    async function loadMyCoupons() {-->
<!--        try {-->
<!--            const productIdsParam = orderProductIds.length > 0-->
<!--                ? `?${orderProductIds.map(id => `productIds=${id}`).join('&')}`-->
<!--                : '';-->

<!--            const response = await fetch(`/order/my-coupons${productIdsParam}`);-->
<!--            const coupons = await response.json();-->

<!--            const couponList = document.getElementById('couponList');-->

<!--            if (coupons.length === 0) {-->
<!--                couponList.innerHTML = '<div class="no-coupons">ì‚¬ìš© ê°€ëŠ¥í•œ ì¿ í°ì´ ì—†ìŠµë‹ˆë‹¤.</div>';-->
<!--                return;-->
<!--            }-->

<!--            couponList.innerHTML = coupons.map(coupon => {-->
<!--                const isUsable = coupon.usable;-->
<!--                const discountAmount = coupon.coupon.discountAmount || 0;-->
<!--                const discountRate = coupon.coupon.discountRate || 0;-->

<!--                let discountType = 'AMOUNT';-->
<!--                let discountValue = discountAmount;-->
<!--                let discountText = '';-->

<!--                if (discountAmount > 0) {-->
<!--                    discountType = 'AMOUNT';-->
<!--                    discountValue = discountAmount;-->
<!--                    discountText = `${formatPrice(discountAmount)}ì› í• ì¸`;-->
<!--                } else if (discountRate > 0) {-->
<!--                    discountType = 'RATE';-->
<!--                    discountValue = discountRate;-->
<!--                    discountText = `${discountRate}% í• ì¸`;-->
<!--                } else {-->
<!--                    discountText = 'í• ì¸ ì •ë³´ ì—†ìŒ';-->
<!--                }-->

<!--                return `-->
<!--                    <div class="coupon-item ${!isUsable ? 'disabled' : ''}">-->
<!--                        <div class="coupon-info">-->
<!--                            <div class="coupon-title">${coupon.coupon.couponTitle || ''}</div>-->
<!--                            <div class="coupon-description">${coupon.coupon.couponDescription || ''}</div>-->
<!--                            <div class="coupon-discount-type">${discountType === 'AMOUNT' ? 'ê¸ˆì•¡í• ì¸' : 'í¼ì„¼íŠ¸í• ì¸'}</div>-->
<!--                            <div class="coupon-discount">${discountText}</div>-->
<!--                            <div class="coupon-expire">ë§Œë£Œì¼: ${formatDate(coupon.coupon.expiredAt)}</div>-->
<!--                        </div>-->
<!--                        <button-->
<!--                            class="coupon-use-btn ${!isUsable ? 'disabled' : ''}"-->
<!--                            onclick="applyCoupon(${coupon.userCouponId}, '${escapeQuotes(coupon.coupon.couponTitle)}', '${discountType}', ${discountValue})"-->
<!--                            ${!isUsable ? 'disabled' : ''}-->
<!--                        >-->
<!--                            ${isUsable ? 'ì ìš©í•˜ê¸°' : 'ì‚¬ìš©ë¶ˆê°€'}-->
<!--                        </button>-->
<!--                    </div>-->
<!--                `;-->
<!--            }).join('');-->
<!--        } catch (error) {-->
<!--            console.error('ì¿ í° ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);-->
<!--            document.getElementById('couponList').innerHTML = '<div class="error-message">ì¿ í° ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';-->
<!--        }-->
<!--    }-->

<!--    async function applyCoupon(userCouponId, couponTitle, discountType, discountValue) {-->
<!--        try {-->
<!--            const currentOrderAmount = totalPrice + shippingCost;-->
<!--            const response = await fetch(`/order/my-coupons/${userCouponId}?orderAmount=${currentOrderAmount}`);-->

<!--            if (!response.ok) {-->
<!--                const errorText = await response.text();-->
<!--                console.error('ì¿ í° ê²€ì¦ ì‹¤íŒ¨:', response.status, errorText);-->

<!--                if (response.status === 400) {-->
<!--                    alert('ì¿ í°ì´ ë§Œë£Œë˜ì—ˆê±°ë‚˜ ì´ë¯¸ ì‚¬ìš©ëœ ì¿ í°ì…ë‹ˆë‹¤.');-->
<!--                } else if (response.status === 404) {-->
<!--                    alert('ì¿ í°ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');-->
<!--                } else {-->
<!--                    alert('ì¿ í° ê²€ì¦ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');-->
<!--                }-->
<!--                return;-->
<!--            }-->

<!--            const couponInfo = await response.json();-->

<!--            if (!couponInfo.applicable) {-->
<!--                alert(`ì´ ì¿ í°ì€ ìµœì†Œ ì£¼ë¬¸ ê¸ˆì•¡ ${formatPrice(couponInfo.minPurchaseAmount)}ì› ì´ìƒë¶€í„° ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.`);-->
<!--                return;-->
<!--            }-->

<!--            const actualDiscount = Number(couponInfo.calculatedDiscountAmount) || 0;-->
<!--            const finalAmountFromServer = Number(couponInfo.finalAmount) || 0;-->

<!--            selectedCouponData = {-->
<!--                userCouponId: userCouponId,-->
<!--                title: couponTitle,-->
<!--                discountType: discountType,-->
<!--                discountValue: discountValue,-->
<!--                calculatedDiscountAmount: actualDiscount,-->
<!--                finalAmount: finalAmountFromServer-->
<!--            };-->

<!--            document.getElementById('selectedCoupon').style.display = 'flex';-->
<!--            document.getElementById('couponMessage').textContent = 'ì¿ í°ì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.';-->
<!--            document.querySelector('.selected-coupon-name').textContent = couponTitle;-->

<!--            if (discountType === 'RATE') {-->
<!--                document.querySelector('.selected-coupon-discount').textContent = `-${discountValue}% (${formatPrice(actualDiscount)}ì›)`;-->
<!--            } else {-->
<!--                document.querySelector('.selected-coupon-discount').textContent = `-${formatPrice(actualDiscount)}ì›`;-->
<!--            }-->

<!--            updatePaymentSummary();-->
<!--            closeCouponModal();-->
<!--        } catch (error) {-->
<!--            console.error('ì¿ í° ì ìš© ì¤‘ ì˜¤ë¥˜:', error);-->
<!--            alert('ì¿ í° ì ìš© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');-->
<!--        }-->
<!--    }-->

<!--    function calculateDiscountAmount(discountType, discountValue) {-->
<!--        if (discountType === 'RATE') {-->
<!--            return Math.floor((totalPrice + shippingCost) * (discountValue / 100));-->
<!--        }-->
<!--        return discountValue;-->
<!--    }-->

<!--    function cancelCoupon() {-->
<!--        selectedCouponData = null;-->
<!--        const selectedCouponEl = document.getElementById('selectedCoupon');-->
<!--        if (selectedCouponEl) {-->
<!--            selectedCouponEl.style.display = 'none';-->
<!--        }-->
<!--        const couponMessageEl = document.getElementById('couponMessage');-->
<!--        if (couponMessageEl) {-->
<!--            couponMessageEl.textContent = 'ì„ íƒëœ ì¿ í°ì´ ì—†ìŠµë‹ˆë‹¤';-->
<!--        }-->
<!--        const couponDiscountLabel = document.querySelector('.selected-coupon-discount');-->
<!--        if (couponDiscountLabel) {-->
<!--            couponDiscountLabel.textContent = '';-->
<!--        }-->
<!--        updatePaymentSummary();-->
<!--    }-->

<!--    function useAllPoints() {-->
<!--        const pointInput = document.getElementById('pointInput');-->
<!--        if (pointInput) {-->
<!--            pointInput.value = availablePoints;-->
<!--            calculateTotal();-->
<!--        }-->
<!--    }-->

<!--    function calculateTotal() {-->
<!--        updatePaymentSummary();-->
<!--    }-->

<!--    function updatePaymentSummary() {-->
<!--        let couponDiscount = 0;-->
<!--        if (selectedCouponData) {-->
<!--            if (selectedCouponData.calculatedDiscountAmount != null) {-->
<!--                couponDiscount = selectedCouponData.calculatedDiscountAmount;-->
<!--            } else if (selectedCouponData.discountType) {-->
<!--                couponDiscount = calculateDiscountAmount(selectedCouponData.discountType, selectedCouponData.discountValue);-->
<!--            }-->
<!--        }-->

<!--        const discountedProductPrice = Math.max(0, totalPrice - couponDiscount);-->
<!--        shippingCost = determineShippingCost(discountedProductPrice);-->

<!--        const pointInput = document.getElementById('pointInput');-->
<!--        const usedPointsRaw = pointInput ? parseInt(pointInput.value, 10) || 0 : 0;-->
<!--        const payableBeforePoints = Math.max(0, totalPrice + shippingCost - couponDiscount);-->
<!--        const maxUsablePoints = Math.min(availablePoints, payableBeforePoints);-->
<!--        const validUsedPoints = Math.min(usedPointsRaw, maxUsablePoints);-->

<!--        if (pointInput && usedPointsRaw !== validUsedPoints) {-->
<!--            pointInput.value = validUsedPoints;-->
<!--        }-->

<!--        const shippingFeeEl = document.getElementById('shippingFee');-->
<!--        if (shippingFeeEl) {-->
<!--            shippingFeeEl.textContent = shippingCost > 0 ? `${formatPrice(shippingCost)}ì›` : 'ë¬´ë£Œë°°ì†¡';-->
<!--        }-->

<!--        const couponDiscountEl = document.querySelector('[data-role="coupon-discount"]');-->
<!--        if (couponDiscountEl) {-->
<!--            couponDiscountEl.textContent = couponDiscount > 0 ? `-${formatPrice(couponDiscount)}ì›` : '0ì›';-->
<!--        }-->

<!--        const pointsDiscountEl = document.querySelector('[data-role="points-discount"]');-->
<!--        if (pointsDiscountEl) {-->
<!--            pointsDiscountEl.textContent = validUsedPoints > 0 ? `-${formatPrice(validUsedPoints)}ì›` : '0ì›';-->
<!--        }-->

<!--        const finalAmount = Math.max(0, totalPrice + shippingCost - couponDiscount - validUsedPoints);-->
<!--        currentFinalAmount = finalAmount;-->
<!--        currentUsedPoints = validUsedPoints;-->

<!--        const totalPriceEl = document.querySelector('.total-price');-->
<!--        if (totalPriceEl) {-->
<!--            totalPriceEl.textContent = `${formatPrice(finalAmount)} ì›`;-->
<!--        }-->

<!--        const paymentBtn = document.querySelector('.payment-btn');-->
<!--        if (paymentBtn) {-->
<!--            paymentBtn.textContent = `${formatPrice(finalAmount)}ì› ê²°ì œí•˜ê¸°`;-->
<!--        }-->

<!--        const earnPoints = Math.floor(finalAmount * 0.01);-->
<!--        const installmentEl = document.querySelector('.installment-text');-->
<!--        if (installmentEl) {-->
<!--            installmentEl.textContent = `${formatPrice(earnPoints)} P ì ë¦½ ì˜ˆì •`;-->
<!--        }-->
<!--    }-->

<!--    async function handlePaymentButtonClick(event) {-->
<!--        event.preventDefault();-->

<!--        if (currentFinalAmount < 100) {-->
<!--            alert('ìµœì¢… ê²°ì œ ê¸ˆì•¡ì€ 100ì› ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');-->
<!--            return;-->
<!--        }-->

<!--        await processPayment(currentFinalAmount, selectedCouponData, currentUsedPoints);-->
<!--    }-->

<!--    function collectOrderItemsData() {-->
<!--        const items = [];-->
<!--        const totalItemsCount = parseInt(document.getElementById('totalItemsCount').value) || 0;-->

<!--        for (let index = 0; index < totalItemsCount; index++) {-->
<!--            const productIdElement = document.getElementById(`item-${index}-productId`);-->
<!--            const productOptionIdElement = document.getElementById(`item-${index}-productOptionId`);-->
<!--            const quantityElement = document.getElementById(`item-${index}-quantity`);-->
<!--            const priceElement = document.getElementById(`item-${index}-price`);-->
<!--            const productNameElement = document.getElementById(`item-${index}-productName`);-->

<!--            if (!productIdElement || !quantityElement || !priceElement) {-->
<!--                continue;-->
<!--            }-->

<!--            const productId = Number(productIdElement.value);-->
<!--            const quantity = Number(quantityElement.value);-->
<!--            const priceValue = priceElement.value;-->
<!--            const priceNumber = Number(priceValue);-->

<!--            if (Number.isNaN(productId) || Number.isNaN(quantity) || Number.isNaN(priceNumber)) {-->
<!--                continue;-->
<!--            }-->

<!--            const optionRaw = productOptionIdElement ? productOptionIdElement.value : null;-->
<!--            const optionValue = optionRaw && optionRaw !== 'null' && optionRaw !== 'default'-->
<!--                ? Number(optionRaw)-->
<!--                : null;-->

<!--            items.push({-->
<!--                productId,-->
<!--                productOptionId: optionValue,-->
<!--                quantity,-->
<!--                price: priceValue,-->
<!--                productName: productNameElement ? productNameElement.value : ''-->
<!--            });-->
<!--        }-->

<!--        return items;-->
<!--    }-->

<!--    function buildOrderPayload(finalAmount, couponData, usedPoints) {-->
<!--        const orderItems = collectOrderItemsData();-->
<!--        if (!orderItems.length) {-->
<!--            throw new Error('ì£¼ë¬¸í•  ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.');-->
<!--        }-->

<!--        const couponDiscount = couponData-->
<!--            ? (couponData.calculatedDiscountAmount != null-->
<!--                ? couponData.calculatedDiscountAmount-->
<!--                : calculateDiscountAmount(couponData.discountType, couponData.discountValue))-->
<!--            : 0;-->

<!--        const paymentOrderId = `ORDER-${Date.now()}`;-->
<!--        let fallbackOrderName = 'ìƒí’ˆ ì£¼ë¬¸';-->
<!--        const fallbackNameElement = document.querySelector('.order-item .item-name');-->
<!--        if (fallbackNameElement && typeof fallbackNameElement.textContent === 'string') {-->
<!--            const trimmed = fallbackNameElement.textContent.trim();-->
<!--            if (trimmed.length > 0) {-->
<!--                fallbackOrderName = trimmed;-->
<!--            }-->
<!--        }-->

<!--        const orderName = orderItems[0].productName || fallbackOrderName;-->
<!--        const sanitizedFinalAmount = Math.max(Math.round(finalAmount || 0), 0);-->

<!--        if (sanitizedFinalAmount < 100) {-->
<!--            throw new Error('ìµœì¢… ê²°ì œ ê¸ˆì•¡ì€ 100ì› ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');-->
<!--        }-->

<!--        return {-->
<!--            paymentOrderId,-->
<!--            orderItems,-->
<!--            userCouponId: couponData ? couponData.userCouponId : null,-->
<!--            couponDiscountAmount: couponDiscount,-->
<!--            usedPoints: usedPoints || 0,-->
<!--            finalAmount: sanitizedFinalAmount,-->
<!--            orderName,-->
<!--            customerEmail,-->
<!--            customerName-->
<!--        };-->
<!--    }-->

<!--    async function processPayment(finalAmount, couponData, usedPoints) {-->
<!--        try {-->
<!--            const orderPayload = buildOrderPayload(finalAmount, couponData, usedPoints);-->

<!--            sessionStorage.removeItem('pendingOrderPayload');-->
<!--            sessionStorage.setItem('pendingOrderPayload', JSON.stringify(orderPayload));-->

<!--            await PaymentSdk.processTossPayment({-->
<!--                orderId: orderPayload.paymentOrderId,-->
<!--                finalAmount: orderPayload.finalAmount,-->
<!--                orderName: orderPayload.orderName,-->
<!--                customerEmail: orderPayload.customerEmail,-->
<!--                customerName: orderPayload.customerName-->
<!--            });-->
<!--        } catch (error) {-->
<!--            console.error('ê²°ì œ ìš”ì²­ ì¤‘ ì˜¤ë¥˜:', error);-->
<!--            sessionStorage.removeItem('pendingOrderPayload');-->
<!--            alert(error.message || 'ê²°ì œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');-->
<!--        }-->
<!--    }-->

<!--    function formatPrice(price) {-->
<!--        if (price === null || price === undefined || isNaN(price)) {-->
<!--            return '0';-->
<!--        }-->
<!--        return Number(price).toLocaleString('ko-KR');-->
<!--    }-->

<!--    function formatDate(dateString) {-->
<!--        if (!dateString) return '';-->
<!--        const date = new Date(dateString);-->
<!--        return date.toLocaleDateString('ko-KR');-->
<!--    }-->

<!--    function escapeQuotes(str) {-->
<!--        if (!str) return '';-->
<!--        return str.replace(/'/g, "\\'").replace(/"/g, '\\"');-->
<!--    }-->

<!--    window.onclick = function(event) {-->
<!--        const modal = document.getElementById('couponModal');-->
<!--        if (event.target === modal) {-->
<!--            modal.style.display = 'none';-->
<!--        }-->
<!--    }-->
<!--  </script>-->

<!--  <style>-->
<!--    .payment-method {-->
<!--      display: flex;-->
<!--      flex-direction: column;-->
<!--      gap: 12px;-->
<!--    }-->

<!--    .method-option {-->
<!--      display: flex;-->
<!--      align-items: center;-->
<!--    }-->

<!--    .method-option input[type="radio"] {-->
<!--      margin-right: 12px;-->
<!--    }-->

<!--    .method-option label {-->
<!--      display: flex;-->
<!--      align-items: center;-->
<!--      gap: 8px;-->
<!--      cursor: pointer;-->
<!--      font-size: 14px;-->
<!--    }-->

<!--    .method-logo {-->
<!--      font-size: 16px;-->
<!--    }-->

<!--    .method-tag {-->
<!--      background: #e3f2fd;-->
<!--      color: #1976d2;-->
<!--      padding: 2px 6px;-->
<!--      border-radius: 4px;-->
<!--      font-size: 11px;-->
<!--      font-weight: 500;-->
<!--    }-->

<!--    .installment-info {-->
<!--      margin-top: 16px;-->
<!--      padding-top: 16px;-->
<!--      border-top: 1px solid #eee;-->
<!--      font-size: 12px;-->
<!--      color: #666;-->
<!--    }-->

<!--    .installment-info p {-->
<!--      margin: 0;-->
<!--      font-weight: 500;-->
<!--      color: #333;-->
<!--    }-->

<!--    .installment-info small {-->
<!--      display: block;-->
<!--      margin-top: 4px;-->
<!--    }-->
<!--  </style>-->
<!--</body>-->
<!--</html>-->
