<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/layout :: head('ì£¼ë¬¸/ê²°ì œ')"></head>
<!-- í˜ì´ì§€ ì „ìš© CSS ì¶”ê°€ -->
<link rel="stylesheet" th:href="@{/css/order.css}">
<body class="page font-body">
  <div th:replace="fragments/layout :: header"></div>

  <div class="container">
    <h1 class="page-title">ì£¼ë¬¸/ê²°ì œ</h1>

    <div class="order-layout">
      <!-- ì™¼ìª½ ì„¹ì…˜ -->
      <div class="left-section">

        <!-- ì£¼ë¬¸ ê²°ì œ / ì£¼ë¬¸ì ì •ë³´ ì„¹ì…˜ -->
        <div class="section-card">
          <h2 class="section-title">ì£¼ë¬¸ ê²°ì œ / ì£¼ë¬¸ì ì •ë³´</h2>

          <div class="form-group">
            <label class="form-label">ì£¼ë¬¸ìëª…</label>
            <input type="text" class="input" th:value="${order.user.userName}" readonly>
          </div>

          <div class="form-group">
            <label class="form-label">ì—°ë½ì²˜</label>
            <input type="text" class="input" th:value="${order.user.phone}" readonly>
          </div>

          <div class="form-group">
            <label class="form-label">ì´ë©”ì¼</label>
            <input type="text" class="input" th:value="${order.user.userEmail}" readonly>
          </div>
        </div>

        <!-- ë°°ì†¡ì§€ ì •ë³´ ì„¹ì…˜ -->
        <div class="section-card">
          <h2 class="section-title">ë°°ì†¡ì§€ ì •ë³´
            <button type="button" class="coupon-link">ë³€ê²½</button>
          </h2>

          <div class="form-group">
            <label class="form-label">ë°›ëŠ” ë¶„</label>
            <input type="text" class="input" th:value="${order.user.userName}" readonly>
          </div>

          <div class="form-group">
            <label class="form-label">ì—°ë½ì²˜</label>
            <input type="text" class="input" th:value="${order.user.phone}" readonly>
          </div>

          <div class="form-group">
            <label class="form-label">ì£¼ì†Œ</label>
            <input type="text" class="input" th:value="${order.user.address}" readonly>
          </div>

          <div class="form-group">
            <button type="button" class="address-search-btn coupon-link">ê¸°ë³¸ ë°°ì†¡ì§€ë¡œ ì €ì¥</button>
          </div>

          <div class="form-group">
            <label class="form-label">ë°°ì†¡ì‹œ ìš”ì²­ì‚¬í•­ì„ ì„ íƒí•´ì£¼ì„¸ìš”</label>
            <select class="input">
              <option>ë°°ì†¡ì‹œ ìš”ì²­ì‚¬í•­ì„ ì„ íƒí•´ì£¼ì„¸ìš”</option>
              <option>ë¬¸ ì•ì— ë†“ì•„ì£¼ì„¸ìš”</option>
              <option>ê²½ë¹„ì‹¤ì— ë§¡ê²¨ì£¼ì„¸ìš”</option>
              <option>íƒë°°ë³´ê´€í•¨ì— ë„£ì–´ì£¼ì„¸ìš”</option>
              <option>ì§ì ‘ ë°›ê² ìŠµë‹ˆë‹¤</option>
            </select>
          </div>
        </div>

        <!-- ì£¼ë¬¸ ìƒí’ˆ ì •ë³´ ì„¹ì…˜ -->
        <div class="section-card">
          <h2 class="section-title">ì£¼ë¬¸ ìƒí’ˆ ì •ë³´
            <span class="item-count" th:text="${#lists.size(order.items)} + 'ê±´'">1ê±´</span>
          </h2>

          <div class="order-items">
            <div class="order-item" th:each="item : ${order.items}">
              <div class="item-info">
                <div class="item-image">
                  <div class="product-img-placeholder">ğŸ“¦</div>
                </div>
                <div class="item-details">
                  <p class="item-name">ìƒí’ˆëª…</p>
                  <p class="item-option" th:if="${item.productOptionName != null}" th:text="${item.productOptionName}">ì˜µì…˜ëª…</p>
                  <p class="item-quantity" th:text="'ìˆ˜ëŸ‰: ' + ${item.quantity} + 'ê°œ'">ìˆ˜ëŸ‰: 1ê°œ</p>
                </div>
              </div>
              <div class="item-shipping">
                <div>
                  <p class="item-price" th:text="${#numbers.formatDecimal(item.price, 0, 'COMMA', 0, 'POINT')} + 'ì›'">139,000ì›</p>
                  <span class="shipping-label">ë¬´ë£Œë°°ì†¡</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- í¬ì¸íŠ¸/ì¿ í° ì •ë³´ ì„¹ì…˜ -->
        <div class="section-card">
          <h2 class="section-title">í¬ì¸íŠ¸/ì¿ í° ì •ë³´</h2>

          <!-- ì¿ í° ë¶€ë¶„ -->
          <div class="coupon-section">
            <h3 class="sub-section-title">ì¿ í°</h3>
            <div class="coupon-selected" id="selectedCoupon" style="display: none;">
              <div class="selected-coupon-info">
                <span class="selected-coupon-name"></span>
                <span class="selected-coupon-discount"></span>
              </div>
              <button type="button" class="coupon-cancel-btn" onclick="cancelCoupon()">ì·¨ì†Œ</button>
            </div>
            <p class="coupon-message" id="couponMessage">ì„ íƒëœ ì¿ í°ì´ ì—†ìŠµë‹ˆë‹¤</p>
            <button type="button" class="coupon-link" onclick="openCouponModal()">ë‚´ ì¿ í° ëª©ë¡ ë³´ê¸°</button>
          </div>

          <!-- í¬ì¸íŠ¸ ë¶€ë¶„ -->
          <div class="point-section">
            <h3 class="sub-section-title">í¬ì¸íŠ¸</h3>
            <div class="point-input-group">
              <input type="number" id="pointInput" class="point-input" placeholder="0" value="0" min="0" onchange="calculateTotal()">
              <button type="button" class="point-all-btn coupon-link" onclick="useAllPoints()">ì „ì•¡ ì‚¬ìš©</button>
            </div>
            <p class="point-available">ì‚¬ìš© ê°€ëŠ¥ í¬ì¸íŠ¸ <span class="point-amount">155,555 P</span></p>
          </div>
        </div>
      </div>

      <!-- ì˜¤ë¥¸ìª½ ì„¹ì…˜ - ê²°ì œ ê¸ˆì•¡ -->
      <div class="right-section">
        <div class="payment-summary">
          <h2 class="summary-title">ê²°ì œê¸ˆì•¡</h2>

          <div class="price-row">
            <span class="price-label">ì´ ìƒí’ˆ ê¸ˆì•¡</span>
            <span class="price-value" th:text="${#numbers.formatDecimal(order.totalPrice, 0, 'COMMA', 0, 'POINT')} + 'ì›'">139,000ì›</span>
          </div>

          <div class="price-row">
            <span class="price-label">ë°°ì†¡ë¹„</span>
            <span class="price-value">40,000ì›</span>
          </div>

          <div class="price-row">
            <span class="price-label">ì¿ í° ì‚¬ìš©</span>
            <span class="price-value">0ì›</span>
          </div>

          <div class="price-row">
            <span class="price-label">í¬ì¸íŠ¸ ì‚¬ìš©</span>
            <span class="price-value">0ì›</span>
          </div>

          <div class="total-row">
            <span class="total-label">ìµœì¢… ê²°ì œ ê¸ˆì•¡</span>
            <span class="total-price" th:text="${#numbers.formatDecimal(order.totalAmount, 0, 'COMMA', 0, 'POINT')} + ' ì›'">179,000 ì›</span>
            <span class="installment-text">139 P ì ë¦½ ì˜ˆì •</span>
          </div>

          <div class="terms-notice">
            ë°›ì•„ë³¼ í…ìŠ¤íŠ¸ ì œì•ˆ ì´í›„ì…ë‹ˆë‹¤, ì¶”í›„ ë‚´ìš©ì„ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
            <br><br>
            ì´ìš©ì•½ê´€/ê²°ì œëŒ€í–‰ ë° ì‡¼í•‘ëª° ì´ìš©ì•½ê´€ ê°œì¸ì •ë³´ ìˆ˜ì§‘, ê²°ì œëŒ€í–‰ ì„œë¹„ìŠ¤ì™€ ë“± ì„œë¹„ìŠ¤ì— ëŒ€í•œ ì € ê³µì¸ ì‹œí‚¬ì¸ì¦ì„ í•„ì´ ë°©ë©´ ë‚´ìš©ì…ë‹ˆë‹¤.
          </div>

          <button type="button" class="payment-btn" th:text="${#numbers.formatDecimal(order.totalAmount + 40000, 0, 'COMMA', 0, 'POINT')} + 'ì› ê²°ì œí•˜ê¸°'">179,000 ì› ê²°ì œí•˜ê¸°</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ì¿ í° ëª¨ë‹¬ -->
  <div id="couponModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>ë‚´ ì¿ í° ëª©ë¡</h2>
        <span class="close" onclick="closeCouponModal()">&times;</span>
      </div>
      <div class="modal-body">
        <div id="couponList" class="coupon-list">
          <div class="loading-message">ì¿ í°ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        </div>
      </div>
    </div>
  </div>

  <div th:replace="fragments/layout :: footer"></div>

  <script>
    // ì „ì—­ ë³€ìˆ˜
    let selectedCouponData = null;
    const totalPrice = parseFloat('[[${ order.totalPrice }]]') || 0;
    const shippingCost = 40000;
    const availablePoints = 155555;

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
    document.addEventListener('DOMContentLoaded', function() {
        updatePaymentSummary();
    });

    // ì¿ í° ëª¨ë‹¬ ì—´ê¸°
    function openCouponModal() {
        document.getElementById('couponModal').style.display = 'block';
        loadMyCoupons();
    }

    // ì¿ í° ëª¨ë‹¬ ë‹«ê¸°
    function closeCouponModal() {
        document.getElementById('couponModal').style.display = 'none';
    }

    // ë‚´ ì¿ í° ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
    async function loadMyCoupons() {
        try {
            const response = await fetch('/order/my-coupons');
            const coupons = await response.json();

            const couponList = document.getElementById('couponList');

            if (coupons.length === 0) {
                couponList.innerHTML = '<div class="no-coupons">ì‚¬ìš© ê°€ëŠ¥í•œ ì¿ í°ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            couponList.innerHTML = coupons.map(coupon => {
                const isUsable = coupon.usable;
                const discountAmount = coupon.coupon.discountAmount || 0;
                const discountRate = coupon.coupon.discountRate || 0;

                // í• ì¸ íƒ€ì…ê³¼ ê°’ ê²°ì •
                let discountType = 'AMOUNT'; // ê¸°ë³¸ê°’: ê¸ˆì•¡í• ì¸
                let discountValue = discountAmount;
                let discountText = '';

                if (discountAmount > 0) {
                    discountType = 'AMOUNT';
                    discountValue = discountAmount;
                    discountText = `${formatPrice(discountAmount)}ì› í• ì¸`;
                } else if (discountRate > 0) {
                    discountType = 'RATE';
                    discountValue = discountRate;
                    discountText = `${discountRate}% í• ì¸`;
                } else {
                    discountText = 'í• ì¸ ì •ë³´ ì—†ìŒ';
                }

                return `
                    <div class="coupon-item ${!isUsable ? 'disabled' : ''}">
                        <div class="coupon-info">
                            <div class="coupon-title">${coupon.coupon.couponTitle || ''}</div>
                            <div class="coupon-description">${coupon.coupon.couponDescription || ''}</div>
                            <div class="coupon-discount-type">${discountType === 'AMOUNT' ? 'ê¸ˆì•¡í• ì¸' : 'í¼ì„¼íŠ¸í• ì¸'}</div>
                            <div class="coupon-discount">${discountText}</div>
                            <div class="coupon-expire">ë§Œë£Œì¼: ${formatDate(coupon.coupon.expiredAt)}</div>
                        </div>
                        <button
                            class="coupon-use-btn ${!isUsable ? 'disabled' : ''}"
                            onclick="applyCoupon(${coupon.userCouponId}, '${escapeQuotes(coupon.coupon.couponTitle)}', '${discountType}', ${discountValue})"
                            ${!isUsable ? 'disabled' : ''}
                        >
                            ${isUsable ? 'ì ìš©í•˜ê¸°' : 'ì‚¬ìš©ë¶ˆê°€'}
                        </button>
                    </div>
                `;
            }).join('');

        } catch (error) {
            console.error('ì¿ í° ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
            document.getElementById('couponList').innerHTML = '<div class="error-message">ì¿ í° ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
        }
    }

    // ì¿ í° ì ìš©
    function applyCoupon(userCouponId, couponTitle, discountType, discountValue) {
        selectedCouponData = {
            userCouponId: userCouponId,
            title: couponTitle,
            discountType: discountType, // 'AMOUNT' ë˜ëŠ” 'RATE'
            discountValue: discountValue
        };

        // í• ì¸ ê¸ˆì•¡ ê³„ì‚°
        let discountAmount = calculateDiscountAmount(discountType, discountValue);

        // ì„ íƒëœ ì¿ í° í‘œì‹œ
        document.getElementById('selectedCoupon').style.display = 'flex';
        document.getElementById('couponMessage').textContent = 'ì¿ í°ì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.';
        document.querySelector('.selected-coupon-name').textContent = couponTitle;

        if (discountType === 'RATE') {
            document.querySelector('.selected-coupon-discount').textContent = `-${discountValue}% (${formatPrice(discountAmount)}ì›)`;
        } else {
            document.querySelector('.selected-coupon-discount').textContent = `-${formatPrice(discountAmount)}ì›`;
        }

        // ê²°ì œ ê¸ˆì•¡ ì—…ë°ì´íŠ¸
        updatePaymentSummary();

        // ëª¨ë‹¬ ë‹«ê¸°
        closeCouponModal();
    }

    // í• ì¸ ê¸ˆì•¡ ê³„ì‚°
    function calculateDiscountAmount(discountType, discountValue) {
        if (discountType === 'RATE') {
            // í¼ì„¼íŠ¸ í• ì¸: ì›ë˜ê¸ˆì•¡ * (í• ì¸ìœ¨ / 100)
            return Math.floor((totalPrice + shippingCost) * (discountValue / 100));
        } else {
            // ê¸ˆì•¡ í• ì¸: í• ì¸ ê¸ˆì•¡ ê·¸ëŒ€ë¡œ
            return discountValue;
        }
    }

    // ì¿ í° ì·¨ì†Œ
    function cancelCoupon() {
        selectedCouponData = null;
        document.getElementById('selectedCoupon').style.display = 'none';
        document.getElementById('couponMessage').textContent = 'ì„ íƒëœ ì¿ í°ì´ ì—†ìŠµë‹ˆë‹¤';
        updatePaymentSummary();
    }

    // í¬ì¸íŠ¸ ì „ì•¡ ì‚¬ìš©
    function useAllPoints() {
        const pointInput = document.getElementById('pointInput');
        pointInput.value = availablePoints;
        calculateTotal();
    }

    // ê²°ì œ ê¸ˆì•¡ ê³„ì‚°
    function calculateTotal() {
        updatePaymentSummary();
    }

    // ê²°ì œ ìš”ì•½ ì—…ë°ì´íŠ¸
    function updatePaymentSummary() {
        const usedPoints = parseInt(document.getElementById('pointInput').value) || 0;

        // ì¿ í° í• ì¸ ê¸ˆì•¡ ê³„ì‚°
        let couponDiscount = 0;
        if (selectedCouponData) {
            couponDiscount = calculateDiscountAmount(selectedCouponData.discountType, selectedCouponData.discountValue);
        }

        // ê° í•­ëª© ì—…ë°ì´íŠ¸
        document.querySelector('.price-row:nth-child(3) .price-value').textContent = couponDiscount > 0 ? `-${formatPrice(couponDiscount)}ì›` : `0ì›`;
        document.querySelector('.price-row:nth-child(4) .price-value').textContent = usedPoints > 0 ? `-${formatPrice(usedPoints)}ì›` : `0ì›`;

        // ìµœì¢… ê²°ì œ ê¸ˆì•¡ ê³„ì‚° (0ì› ë¯¸ë§Œìœ¼ë¡œ ë‚´ë ¤ê°€ì§€ ì•Šë„ë¡)
        const finalAmount = Math.max(0, totalPrice + shippingCost - couponDiscount - usedPoints);
        document.querySelector('.total-price').textContent = `${formatPrice(finalAmount)} ì›`;

        // ê²°ì œ ë²„íŠ¼ ì—…ë°ì´íŠ¸ (ì¿ í° IDì™€ í¬ì¸íŠ¸ í¬í•¨)
        const paymentBtn = document.querySelector('.payment-btn');
        paymentBtn.textContent = `${formatPrice(finalAmount)}ì› ê²°ì œí•˜ê¸°`;

        // ê²°ì œ ë²„íŠ¼ì— í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€ (ì¿ í° ID ì „ë‹¬)
        paymentBtn.onclick = function() {
            processPayment(finalAmount, selectedCouponData, usedPoints);
        };

        // ì ë¦½ ì˜ˆì • í¬ì¸íŠ¸ (ê²°ì œ ê¸ˆì•¡ì˜ 1%)
        const earnPoints = Math.floor(finalAmount * 0.01);
        document.querySelector('.installment-text').textContent = `${formatPrice(earnPoints)} P ì ë¦½ ì˜ˆì •`;
    }

    // ê²°ì œ ì²˜ë¦¬ í•¨ìˆ˜
    function processPayment(finalAmount, couponData, usedPoints) {
        // ê²°ì œ ë°ì´í„° êµ¬ì„±
        const paymentData = {
            amount: finalAmount,
            couponId: couponData ? couponData.userCouponId : null,
            usedPoints: usedPoints,
            orderId: '[[${ order.orderId }]]' || null
        };

        console.log('ê²°ì œ ë°ì´í„°:', paymentData);

        // ì‹¤ì œ ê²°ì œ API í˜¸ì¶œ (ì—¬ê¸°ì„œëŠ” ë¡œê·¸ë§Œ ì¶œë ¥)
        // ì‹¤ì œ êµ¬í˜„ ì‹œì—ëŠ” ê²°ì œ APIë¥¼ í˜¸ì¶œí•´ì•¼ í•©ë‹ˆë‹¤
        alert(`ê²°ì œ ê¸ˆì•¡: ${formatPrice(finalAmount)}ì›\nì¿ í° ID: ${paymentData.couponId || 'ì—†ìŒ'}\nì‚¬ìš© í¬ì¸íŠ¸: ${usedPoints}P`);

        // TODO: ì‹¤ì œ ê²°ì œ API í˜¸ì¶œ
        // fetch('/api/payment/process', {
        //     method: 'POST',
        //     headers: {
        //         'Content-Type': 'application/json'
        //     },
        //     body: JSON.stringify(paymentData)
        // }).then(response => response.json()).then(data => {
        //     if (data.success) {
        //         window.location.href = '/payment/success';
        //     } else {
        //         alert('ê²°ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        //     }
        // });
    }

    // ìˆ«ì í¬ë§·íŒ… (ì½¤ë§ˆ ì¶”ê°€)
    function formatPrice(price) {
        if (price === null || price === undefined || isNaN(price)) {
            return '0';
        }
        return Number(price).toLocaleString('ko-KR');
    }

    // ë‚ ì§œ í¬ë§·íŒ…
    function formatDate(dateString) {
        if (!dateString) return '';
        const date = new Date(dateString);
        return date.toLocaleDateString('ko-KR');
    }

    // ë”°ì˜´í‘œ ì´ìŠ¤ì¼€ì´í”„
    function escapeQuotes(str) {
        if (!str) return '';
        return str.replace(/'/g, "\\'").replace(/"/g, '\\"');
    }

    // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
    window.onclick = function(event) {
        const modal = document.getElementById('couponModal');
        if (event.target == modal) {
            modal.style.display = 'none';
        }
    }
  </script>

  <style>
    .payment-method {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .method-option {
      display: flex;
      align-items: center;
    }

    .method-option input[type="radio"] {
      margin-right: 12px;
    }

    .method-option label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      font-size: 14px;
    }

    .method-logo {
      font-size: 16px;
    }

    .method-tag {
      background: #e3f2fd;
      color: #1976d2;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 500;
    }

    .installment-info {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid #eee;
      font-size: 12px;
      color: #666;
    }

    .installment-info p {
      margin: 0;
      font-weight: 500;
      color: #333;
    }

    .installment-info small {
      display: block;
      margin-top: 4px;
    }
  </style>
</body>
</html>