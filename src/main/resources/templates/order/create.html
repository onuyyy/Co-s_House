<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/layout :: head('ì£¼ë¬¸/ê²°ì œ')"></head>
<!-- í˜ì´ì§€ ì „ìš© CSS ì¶”ê°€ -->
<link rel="stylesheet" th:href="@{/css/order.css}">
<body class="page font-body">
  <div th:replace="fragments/layout :: header"></div>

  <div class="container">
    <h1 class="page-title">ì£¼ë¬¸/ê²°ì œ</h1>

    <div class="order-layout">
      <!-- ì™¼ìª½ ì„¹ì…˜ -->
      <div class="left-section">

        <!-- ì£¼ë¬¸ ê²°ì œ / ì£¼ë¬¸ì ì •ë³´ ì„¹ì…˜ -->
        <div class="section-card">
          <h2 class="section-title">ì£¼ë¬¸ ê²°ì œ / ì£¼ë¬¸ì ì •ë³´</h2>

          <div class="form-group">
            <label class="form-label">ì£¼ë¬¸ìëª…</label>
            <input type="text" class="input" th:value="${order.user.userName}" readonly>
          </div>

          <div class="form-group">
            <label class="form-label">ì—°ë½ì²˜</label>
            <input type="text" class="input" th:value="${order.user.phone}" readonly>
          </div>

          <div class="form-group">
            <label class="form-label">ì´ë©”ì¼</label>
            <input type="text" class="input" th:value="${order.user.userEmail}" readonly>
          </div>
        </div>

        <!-- ë°°ì†¡ì§€ ì •ë³´ ì„¹ì…˜ -->
        <div class="section-card">
          <h2 class="section-title">ë°°ì†¡ì§€ ì •ë³´
            <button type="button" class="coupon-link">ë³€ê²½</button>
          </h2>

          <div class="form-group">
            <label class="form-label">ë°›ëŠ” ë¶„</label>
            <input type="text" class="input" th:value="${order.user.userName}" readonly>
          </div>

          <div class="form-group">
            <label class="form-label">ì—°ë½ì²˜</label>
            <input type="text" class="input" th:value="${order.user.phone}" readonly>
          </div>

          <div class="form-group">
            <label class="form-label">ì£¼ì†Œ</label>
            <input type="text" class="input" th:value="${order.user.address}" readonly>
          </div>

          <div class="form-group">
            <button type="button" class="address-search-btn coupon-link">ê¸°ë³¸ ë°°ì†¡ì§€ë¡œ ì €ì¥</button>
          </div>

          <div class="form-group">
            <label class="form-label">ë°°ì†¡ì‹œ ìš”ì²­ì‚¬í•­ì„ ì„ íƒí•´ì£¼ì„¸ìš”</label>
            <select class="input">
              <option>ë°°ì†¡ì‹œ ìš”ì²­ì‚¬í•­ì„ ì„ íƒí•´ì£¼ì„¸ìš”</option>
              <option>ë¬¸ ì•ì— ë†“ì•„ì£¼ì„¸ìš”</option>
              <option>ê²½ë¹„ì‹¤ì— ë§¡ê²¨ì£¼ì„¸ìš”</option>
              <option>íƒë°°ë³´ê´€í•¨ì— ë„£ì–´ì£¼ì„¸ìš”</option>
              <option>ì§ì ‘ ë°›ê² ìŠµë‹ˆë‹¤</option>
            </select>
          </div>
        </div>

        <!-- ì£¼ë¬¸ ìƒí’ˆ ì •ë³´ ì„¹ì…˜ -->
        <div class="section-card">
          <h2 class="section-title">ì£¼ë¬¸ ìƒí’ˆ ì •ë³´
            <span class="item-count" th:text="${#lists.size(order.items)} + 'ê±´'">1ê±´</span>
          </h2>

          <div class="order-items">
            <div class="order-item" th:each="item : ${order.items}">
              <div class="item-info">
                <div class="item-image">
                  <div class="product-img-placeholder">ğŸ“¦</div>
                </div>
                <div class="item-details">
                  <p class="item-name" th:text="${item.productName}">ìƒí’ˆëª…</p>
                  <p class="item-option" th:if="${item.productOptionName != null}" th:text="${item.productOptionName}">ì˜µì…˜ëª…</p>
                  <p class="item-quantity" th:text="'ìˆ˜ëŸ‰: ' + ${item.quantity} + 'ê°œ'">ìˆ˜ëŸ‰: 0ê°œ</p>
                </div>
              </div>
              <div class="item-shipping">
                <div>
                  <p class="item-price" th:text="${#numbers.formatDecimal(item.price, 0, 'COMMA', 0, 'POINT')} + 'ì›'">139,000ì›</p>
                  <span class="shipping-label">ë¬´ë£Œë°°ì†¡</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- í¬ì¸íŠ¸/ì¿ í° ì •ë³´ ì„¹ì…˜ -->
        <div class="section-card">
          <h2 class="section-title">í¬ì¸íŠ¸/ì¿ í° ì •ë³´</h2>

          <!-- ì¿ í° ë¶€ë¶„ -->
          <div class="coupon-section">
            <h3 class="sub-section-title">ì¿ í°</h3>
            <div class="coupon-selected" id="selectedCoupon" style="display: none;">
              <div class="selected-coupon-info">
                <span class="selected-coupon-name"></span>
                <span class="selected-coupon-discount"></span>
              </div>
              <button type="button" class="coupon-cancel-btn" onclick="cancelCoupon()">ì·¨ì†Œ</button>
            </div>
            <p class="coupon-message" id="couponMessage">ì„ íƒëœ ì¿ í°ì´ ì—†ìŠµë‹ˆë‹¤</p>
            <button type="button" class="coupon-link" onclick="openCouponModal()">ë‚´ ì¿ í° ëª©ë¡ ë³´ê¸°</button>
          </div>

          <!-- í¬ì¸íŠ¸ ë¶€ë¶„ -->
          <div class="point-section">
            <h3 class="sub-section-title">í¬ì¸íŠ¸</h3>
            <div class="point-input-group">
              <input type="number" id="pointInput" class="point-input" placeholder="0" value="0" min="0" onchange="calculateTotal()">
              <button type="button" class="point-all-btn coupon-link" onclick="useAllPoints()">ì „ì•¡ ì‚¬ìš©</button>
            </div>
            <p class="point-available">ì‚¬ìš© ê°€ëŠ¥ í¬ì¸íŠ¸ <span class="point-amount">155,555 P</span></p>
          </div>
        </div>
      </div>

      <!-- ì˜¤ë¥¸ìª½ ì„¹ì…˜ - ê²°ì œ ê¸ˆì•¡ -->
      <div class="right-section">
        <div class="payment-summary">
          <h2 class="summary-title">ê²°ì œê¸ˆì•¡</h2>

          <div class="price-row">
            <span class="price-label">ì´ ìƒí’ˆ ê¸ˆì•¡</span>
            <span class="price-value" th:text="${#numbers.formatDecimal(order.totalPrice, 0, 'COMMA', 0, 'POINT')} + 'ì›'">139,000ì›</span>
          </div>

          <div class="price-row">
            <span class="price-label">ë°°ì†¡ë¹„</span>
            <span class="price-value" id="shippingFee">0ì›</span>
          </div>

          <div class="price-row">
            <span class="price-label">ì¿ í° ì‚¬ìš©</span>
            <span class="price-value">0ì›</span>
          </div>

          <div class="price-row">
            <span class="price-label">í¬ì¸íŠ¸ ì‚¬ìš©</span>
            <span class="price-value">0ì›</span>
          </div>

          <div class="total-row">
            <span class="total-label">ìµœì¢… ê²°ì œ ê¸ˆì•¡</span>
            <span class="total-price" th:text="${#numbers.formatDecimal(order.totalAmount, 0, 'COMMA', 0, 'POINT')} + ' ì›'">179,000 ì›</span>
            <span class="installment-text">139 P ì ë¦½ ì˜ˆì •</span>
          </div>

          <div class="terms-notice">
            ë°›ì•„ë³¼ í…ìŠ¤íŠ¸ ì œì•ˆ ì´í›„ì…ë‹ˆë‹¤, ì¶”í›„ ë‚´ìš©ì„ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
            <br><br>
            ì´ìš©ì•½ê´€/ê²°ì œëŒ€í–‰ ë° ì‡¼í•‘ëª° ì´ìš©ì•½ê´€ ê°œì¸ì •ë³´ ìˆ˜ì§‘, ê²°ì œëŒ€í–‰ ì„œë¹„ìŠ¤ì™€ ë“± ì„œë¹„ìŠ¤ì— ëŒ€í•œ ì € ê³µì¸ ì‹œí‚¬ì¸ì¦ì„ í•„ì´ ë°©ë©´ ë‚´ìš©ì…ë‹ˆë‹¤.
          </div>

          <button type="button" class="payment-btn" th:text="${#numbers.formatDecimal(order.totalAmount, 0, 'COMMA', 0, 'POINT')} + 'ì› ê²°ì œí•˜ê¸°'">179,000 ì› ê²°ì œí•˜ê¸°</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ì¿ í° ëª¨ë‹¬ -->
  <div id="couponModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>ë‚´ ì¿ í° ëª©ë¡</h2>
        <span class="close" onclick="closeCouponModal()">&times;</span>
      </div>
      <div class="modal-body">
        <div id="couponList" class="coupon-list">
          <div class="loading-message">ì¿ í°ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        </div>
      </div>
    </div>
  </div>

  <div th:replace="fragments/layout :: footer"></div>

  <!-- Hidden form with order data for JavaScript -->
  <div id="hiddenOrderData" style="display: none;">
    <div th:each="item, itemStat : ${order.items}">
      <input type="hidden" th:id="'item-' + ${itemStat.index} + '-productId'" th:value="${item.productId}" />
      <input type="hidden" th:id="'item-' + ${itemStat.index} + '-productOptionId'" th:value="${item.productOptionId}" />
      <input type="hidden" th:id="'item-' + ${itemStat.index} + '-quantity'" th:value="${item.quantity}" />
      <input type="hidden" th:id="'item-' + ${itemStat.index} + '-price'" th:value="${item.price}" />
    </div>
    <input type="hidden" id="totalItemsCount" th:value="${#lists.size(order.items)}" />
  </div>

  <script>
    // ì „ì—­ ë³€ìˆ˜
    let selectedCouponData = null;
    const totalPrice = parseFloat('[[${ order.totalPrice }]]') || 0;
    let shippingCost = calculateShippingCost(); // ë°°ì†¡ë¹„ ê³„ì‚°
    let availablePoints = 0; // ë™ì ìœ¼ë¡œ ë¡œë”©

    // ì£¼ë¬¸ ìƒí’ˆ ID ëª©ë¡ (ì¿ í° í•„í„°ë§ìš©)
    const orderProductIds = getOrderProductIds();

    // ë°°ì†¡ë¹„ ê³„ì‚° í•¨ìˆ˜ (30,000ì› ì´ìƒ ë¬´ë£Œë°°ì†¡)
    function calculateShippingCost() {
        const freeShippingThreshold = 30000;
        return totalPrice >= freeShippingThreshold ? 0 : 3000;
    }

    // ì£¼ë¬¸ ìƒí’ˆ ID ëª©ë¡ ì¶”ì¶œ
    function getOrderProductIds() {
        const totalItemsCount = parseInt(document.getElementById('totalItemsCount').value) || 0;
        const productIds = [];

        for (let index = 0; index < totalItemsCount; index++) {
            const productIdElement = document.getElementById(`item-${index}-productId`);
            if (productIdElement && productIdElement.value) {
                productIds.push(parseInt(productIdElement.value));
            }
        }

        return productIds;
    }

    // í¬ì¸íŠ¸ ì •ë³´ ë¡œë”©
    async function loadUserPoints() {
        try {
            const response = await fetch('/order/my-points');
            const data = await response.json();

            if (data.success) {
                availablePoints = data.totalPoints || 0;

                // í¬ì¸íŠ¸ í‘œì‹œ ì—…ë°ì´íŠ¸
                document.querySelector('.point-amount').textContent = `${formatPrice(availablePoints)} P`;

                // í¬ì¸íŠ¸ ì…ë ¥ í•„ë“œ ìµœëŒ€ê°’ ì„¤ì •
                document.getElementById('pointInput').max = availablePoints;

                console.log('í¬ì¸íŠ¸ ë¡œë”© ì™„ë£Œ:', availablePoints);
            } else {
                console.error('í¬ì¸íŠ¸ ë¡œë”© ì‹¤íŒ¨:', data.message);
                availablePoints = 0;
                document.querySelector('.point-amount').textContent = '0 P';
            }
        } catch (error) {
            console.error('í¬ì¸íŠ¸ ë¡œë”© ì¤‘ ì˜¤ë¥˜:', error);
            availablePoints = 0;
            document.querySelector('.point-amount').textContent = '0 P';
        }
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
    document.addEventListener('DOMContentLoaded', function() {
        loadUserPoints(); // í¬ì¸íŠ¸ ë¡œë”©
        updatePaymentSummary();
    });

    // ì¿ í° ëª¨ë‹¬ ì—´ê¸°
    function openCouponModal() {
        document.getElementById('couponModal').style.display = 'block';
        loadMyCoupons();
    }

    // ì¿ í° ëª¨ë‹¬ ë‹«ê¸°
    function closeCouponModal() {
        document.getElementById('couponModal').style.display = 'none';
    }

    // ë‚´ ì¿ í° ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° (ì£¼ë¬¸ ìƒí’ˆì— ì ìš© ê°€ëŠ¥í•œ ì¿ í°ë§Œ)
    async function loadMyCoupons() {
        try {
            // ì£¼ë¬¸ ìƒí’ˆ IDë¥¼ ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ë¡œ ì „ë‹¬í•˜ì—¬ ì ìš© ê°€ëŠ¥í•œ ì¿ í°ë§Œ ì¡°íšŒ
            const productIdsParam = orderProductIds.length > 0 ?
                `?${orderProductIds.map(id => `productIds=${id}`).join('&')}` : '';

            const response = await fetch(`/order/my-coupons${productIdsParam}`);
            const coupons = await response.json();

            const couponList = document.getElementById('couponList');

            if (coupons.length === 0) {
                couponList.innerHTML = '<div class="no-coupons">ì‚¬ìš© ê°€ëŠ¥í•œ ì¿ í°ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            couponList.innerHTML = coupons.map(coupon => {
                const isUsable = coupon.usable;
                const discountAmount = coupon.coupon.discountAmount || 0;
                const discountRate = coupon.coupon.discountRate || 0;

                // í• ì¸ íƒ€ì…ê³¼ ê°’ ê²°ì •
                let discountType = 'AMOUNT'; // ê¸°ë³¸ê°’: ê¸ˆì•¡í• ì¸
                let discountValue = discountAmount;
                let discountText = '';

                if (discountAmount > 0) {
                    discountType = 'AMOUNT';
                    discountValue = discountAmount;
                    discountText = `${formatPrice(discountAmount)}ì› í• ì¸`;
                } else if (discountRate > 0) {
                    discountType = 'RATE';
                    discountValue = discountRate;
                    discountText = `${discountRate}% í• ì¸`;
                } else {
                    discountText = 'í• ì¸ ì •ë³´ ì—†ìŒ';
                }

                return `
                    <div class="coupon-item ${!isUsable ? 'disabled' : ''}">
                        <div class="coupon-info">
                            <div class="coupon-title">${coupon.coupon.couponTitle || ''}</div>
                            <div class="coupon-description">${coupon.coupon.couponDescription || ''}</div>
                            <div class="coupon-discount-type">${discountType === 'AMOUNT' ? 'ê¸ˆì•¡í• ì¸' : 'í¼ì„¼íŠ¸í• ì¸'}</div>
                            <div class="coupon-discount">${discountText}</div>
                            <div class="coupon-expire">ë§Œë£Œì¼: ${formatDate(coupon.coupon.expiredAt)}</div>
                        </div>
                        <button
                            class="coupon-use-btn ${!isUsable ? 'disabled' : ''}"
                            onclick="applyCoupon(${coupon.userCouponId}, '${escapeQuotes(coupon.coupon.couponTitle)}', '${discountType}', ${discountValue})"
                            ${!isUsable ? 'disabled' : ''}
                        >
                            ${isUsable ? 'ì ìš©í•˜ê¸°' : 'ì‚¬ìš©ë¶ˆê°€'}
                        </button>
                    </div>
                `;
            }).join('');

        } catch (error) {
            console.error('ì¿ í° ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
            document.getElementById('couponList').innerHTML = '<div class="error-message">ì¿ í° ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
        }
    }

    // ì¿ í° ì ìš©
    async function applyCoupon(userCouponId, couponTitle, discountType, discountValue) {
        try {
            // í˜„ì¬ ì£¼ë¬¸ ê¸ˆì•¡ ê³„ì‚°
            const currentOrderAmount = totalPrice + shippingCost;

            // ì„œë²„ì—ì„œ ì¿ í° ì ìš© ê°€ëŠ¥ ì—¬ë¶€ ë° ì‹¤ì œ í• ì¸ ê¸ˆì•¡ í™•ì¸
            const response = await fetch(`/order/my-coupons/${userCouponId}?orderAmount=${currentOrderAmount}`);

            if (!response.ok) {
                // ì„œë²„ì—ì„œ ë°˜í™˜í•˜ëŠ” êµ¬ì²´ì ì¸ ì—ëŸ¬ ë©”ì‹œì§€ ì²˜ë¦¬
                const errorText = await response.text();
                console.error('ì¿ í° ê²€ì¦ ì‹¤íŒ¨:', response.status, errorText);

                if (response.status === 400) {
                    alert('ì¿ í°ì´ ë§Œë£Œë˜ì—ˆê±°ë‚˜ ì´ë¯¸ ì‚¬ìš©ëœ ì¿ í°ì…ë‹ˆë‹¤.');
                } else if (response.status === 404) {
                    alert('ì¿ í°ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                } else {
                    alert('ì¿ í° ê²€ì¦ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                }
                return;
            }

            const couponInfo = await response.json();

            // ì¿ í° ì ìš© ë¶ˆê°€ëŠ¥í•œ ê²½ìš°
            if (!couponInfo.applicable) {
                alert(`ì´ ì¿ í°ì€ ìµœì†Œ ì£¼ë¬¸ ê¸ˆì•¡ ${formatPrice(couponInfo.minPurchaseAmount)}ì› ì´ìƒë¶€í„° ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.`);
                return;
            }

            // ì„œë²„ì—ì„œ ê³„ì‚°ëœ í• ì¸ ì •ë³´ë¡œ ì—…ë°ì´íŠ¸
            selectedCouponData = {
                userCouponId: userCouponId,
                title: couponTitle,
                discountType: discountType,
                discountValue: discountValue,
                calculatedDiscountAmount: couponInfo.calculatedDiscountAmount, // ì„œë²„ì—ì„œ ê³„ì‚°ëœ ì‹¤ì œ í• ì¸ ê¸ˆì•¡
                finalAmount: couponInfo.finalAmount
            };

            // ì„ íƒëœ ì¿ í° í‘œì‹œ
            document.getElementById('selectedCoupon').style.display = 'flex';
            document.getElementById('couponMessage').textContent = 'ì¿ í°ì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.';
            document.querySelector('.selected-coupon-name').textContent = couponTitle;

            // ì‹¤ì œ ê³„ì‚°ëœ í• ì¸ ê¸ˆì•¡ í‘œì‹œ
            const actualDiscount = couponInfo.calculatedDiscountAmount;
            if (discountType === 'RATE') {
                document.querySelector('.selected-coupon-discount').textContent = `-${discountValue}% (${formatPrice(actualDiscount)}ì›)`;
            } else {
                document.querySelector('.selected-coupon-discount').textContent = `-${formatPrice(actualDiscount)}ì›`;
            }

            // ê²°ì œ ê¸ˆì•¡ ì—…ë°ì´íŠ¸
            updatePaymentSummary();

            // ëª¨ë‹¬ ë‹«ê¸°
            closeCouponModal();

        } catch (error) {
            console.error('ì¿ í° ì ìš© ì¤‘ ì˜¤ë¥˜:', error);
            alert('ì¿ í° ì ìš© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        }
    }

    // í• ì¸ ê¸ˆì•¡ ê³„ì‚°
    function calculateDiscountAmount(discountType, discountValue) {
        if (discountType === 'RATE') {
            // í¼ì„¼íŠ¸ í• ì¸: ì›ë˜ê¸ˆì•¡ * (í• ì¸ìœ¨ / 100)
            return Math.floor((totalPrice + shippingCost) * (discountValue / 100));
        } else {
            // ê¸ˆì•¡ í• ì¸: í• ì¸ ê¸ˆì•¡ ê·¸ëŒ€ë¡œ
            return discountValue;
        }
    }

    // ì¿ í° ì·¨ì†Œ
    function cancelCoupon() {
        selectedCouponData = null;
        document.getElementById('selectedCoupon').style.display = 'none';
        document.getElementById('couponMessage').textContent = 'ì„ íƒëœ ì¿ í°ì´ ì—†ìŠµë‹ˆë‹¤';
        updatePaymentSummary();
    }

    // í¬ì¸íŠ¸ ì „ì•¡ ì‚¬ìš©
    function useAllPoints() {
        const pointInput = document.getElementById('pointInput');
        pointInput.value = availablePoints;
        calculateTotal();
    }

    // ê²°ì œ ê¸ˆì•¡ ê³„ì‚°
    function calculateTotal() {
        updatePaymentSummary();
    }

    // ê²°ì œ ìš”ì•½ ì—…ë°ì´íŠ¸
    function updatePaymentSummary() {
        const usedPoints = parseInt(document.getElementById('pointInput').value) || 0;

        // í¬ì¸íŠ¸ ì‚¬ìš©ìœ¼ë¡œ ì¸í•œ ì¿ í°ê³¼ì˜ ìƒí˜¸ì‘ìš© ì²´í¬
        const maxUsablePoints = Math.min(availablePoints, totalPrice + shippingCost);
        const validUsedPoints = Math.min(usedPoints, maxUsablePoints);

        // ì¿ í° í• ì¸ ê¸ˆì•¡ - ì„œë²„ì—ì„œ ê³„ì‚°ëœ ì‹¤ì œ í• ì¸ ê¸ˆì•¡ ì‚¬ìš©
        let couponDiscount = 0;
        if (selectedCouponData && selectedCouponData.calculatedDiscountAmount) {
            couponDiscount = selectedCouponData.calculatedDiscountAmount;
        }

        // ì¿ í° ì ìš© í›„ ë°°ì†¡ë¹„ ì¬ê³„ì‚° (ì¿ í°ìœ¼ë¡œ ìƒí’ˆê¸ˆì•¡ì´ 30,000ì› ì´í•˜ê°€ ë˜ë©´ ë°°ì†¡ë¹„ ë°œìƒ)
        const discountedProductPrice = Math.max(0, totalPrice - couponDiscount);
        const recalculatedShippingCost = discountedProductPrice >= 30000 ? 0 : 3000;
        shippingCost = recalculatedShippingCost;

        // ë°°ì†¡ë¹„ í‘œì‹œ ì—…ë°ì´íŠ¸
        document.getElementById('shippingFee').textContent = shippingCost > 0 ? `${formatPrice(shippingCost)}ì›` : 'ë¬´ë£Œë°°ì†¡';

        // ê° í•­ëª© ì—…ë°ì´íŠ¸ (h2 íƒœê·¸ ë•Œë¬¸ì— ì¸ë±ìŠ¤ê°€ 1ì”© ë°€ë¦¼)
        // nth-child(4) = ì¿ í° ì‚¬ìš©, nth-child(5) = í¬ì¸íŠ¸ ì‚¬ìš©
        document.querySelector('.price-row:nth-child(4) .price-value').textContent = couponDiscount > 0 ? `-${formatPrice(couponDiscount)}ì›` : `0ì›`;
        document.querySelector('.price-row:nth-child(5) .price-value').textContent = validUsedPoints > 0 ? `-${formatPrice(validUsedPoints)}ì›` : `0ì›`;

        // ìµœì¢… ê²°ì œ ê¸ˆì•¡ ê³„ì‚° (0ì› ë¯¸ë§Œìœ¼ë¡œ ë‚´ë ¤ê°€ì§€ ì•Šë„ë¡)
        const finalAmount = Math.max(0, totalPrice + shippingCost - couponDiscount - validUsedPoints);
        document.querySelector('.total-price').textContent = `${formatPrice(finalAmount)} ì›`;

        // í¬ì¸íŠ¸ ì…ë ¥ê°’ì´ ìµœëŒ€ ì‚¬ìš© ê°€ëŠ¥ í¬ì¸íŠ¸ë¥¼ ì´ˆê³¼í•œ ê²½ìš° ì¡°ì •
        if (usedPoints !== validUsedPoints) {
            document.getElementById('pointInput').value = validUsedPoints;
        }

        // ê²°ì œ ë²„íŠ¼ ì—…ë°ì´íŠ¸ (ì¿ í° IDì™€ í¬ì¸íŠ¸ í¬í•¨)
        const paymentBtn = document.querySelector('.payment-btn');
        paymentBtn.textContent = `${formatPrice(finalAmount)}ì› ê²°ì œí•˜ê¸°`;

        // ê²°ì œ ë²„íŠ¼ì— í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€ (ì¿ í° ID ì „ë‹¬)
        paymentBtn.onclick = function() {
            processPayment(finalAmount, selectedCouponData, validUsedPoints);
        };

        // ì ë¦½ ì˜ˆì • í¬ì¸íŠ¸ (ê²°ì œ ê¸ˆì•¡ì˜ 1%)
        const earnPoints = Math.floor(finalAmount * 0.01);
        document.querySelector('.installment-text').textContent = `${formatPrice(earnPoints)} P ì ë¦½ ì˜ˆì •`;
    }

    // ê²°ì œ ì²˜ë¦¬ í•¨ìˆ˜
    function processPayment(finalAmount, couponData, usedPoints) {
        // ì£¼ë¬¸ ë°ì´í„°ë¥¼ í¼ìœ¼ë¡œ ì „ì†¡í•˜ì—¬ ì‹¤ì œ ì£¼ë¬¸ ìƒì„±
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/order/create';
        form.style.display = 'none';

        // ìˆ¨ê²¨ì§„ ì…ë ¥ í•„ë“œì—ì„œ ì£¼ë¬¸ ì•„ì´í…œ ë°ì´í„° ì½ê¸°
        const totalItemsCount = parseInt(document.getElementById('totalItemsCount').value) || 0;
        console.log('Debug - Total items count:', totalItemsCount);

        if (totalItemsCount === 0) {
            console.error('Debug - No order items found!');
            alert('ì£¼ë¬¸í•  ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }

        // ê° ì•„ì´í…œì„ ìˆœíšŒí•˜ë©´ì„œ í¼ì— ì¶”ê°€
        for (let index = 0; index < totalItemsCount; index++) {
            const productIdElement = document.getElementById(`item-${index}-productId`);
            const productOptionIdElement = document.getElementById(`item-${index}-productOptionId`);
            const quantityElement = document.getElementById(`item-${index}-quantity`);
            const priceElement = document.getElementById(`item-${index}-price`);

            if (!productIdElement || !quantityElement || !priceElement) {
                console.error(`Debug - Missing required fields for item ${index}`);
                continue;
            }

            console.log(`Debug - Processing item[${index}] - productId: ${productIdElement.value}, quantity: ${quantityElement.value}, price: ${priceElement.value}`);

            // productId ì¶”ê°€
            const productIdInput = document.createElement('input');
            productIdInput.type = 'hidden';
            productIdInput.name = `orderItems[${index}].productId`;
            productIdInput.value = productIdElement.value;
            form.appendChild(productIdInput);

            // productOptionId ì¶”ê°€ (ìˆëŠ” ê²½ìš°ì—ë§Œ)
            if (productOptionIdElement && productOptionIdElement.value && productOptionIdElement.value !== 'null') {
                const optionIdInput = document.createElement('input');
                optionIdInput.type = 'hidden';
                optionIdInput.name = `orderItems[${index}].productOptionId`;
                optionIdInput.value = productOptionIdElement.value;
                form.appendChild(optionIdInput);
            }

            // quantity ì¶”ê°€
            const quantityInput = document.createElement('input');
            quantityInput.type = 'hidden';
            quantityInput.name = `orderItems[${index}].quantity`;
            quantityInput.value = quantityElement.value;
            form.appendChild(quantityInput);

            // price ì¶”ê°€
            const priceInput = document.createElement('input');
            priceInput.type = 'hidden';
            priceInput.name = `orderItems[${index}].price`;
            priceInput.value = priceElement.value;
            form.appendChild(priceInput);
        }

        // ì¿ í° ì •ë³´ ì¶”ê°€ (ì¿ í°ì„ ì‚¬ìš©í•œ ê²½ìš°)
        if (couponData) {
            const couponIdInput = document.createElement('input');
            couponIdInput.type = 'hidden';
            couponIdInput.name = 'userCouponId';
            couponIdInput.value = couponData.userCouponId;
            form.appendChild(couponIdInput);

            const couponDiscountInput = document.createElement('input');
            couponDiscountInput.type = 'hidden';
            couponDiscountInput.name = 'couponDiscountAmount';
            couponDiscountInput.value = couponData.calculatedDiscountAmount || 0;
            form.appendChild(couponDiscountInput);
        }

        // í¬ì¸íŠ¸ ì •ë³´ ì¶”ê°€ (í¬ì¸íŠ¸ë¥¼ ì‚¬ìš©í•œ ê²½ìš°)
        if (usedPoints > 0) {
            const pointsInput = document.createElement('input');
            pointsInput.type = 'hidden';
            pointsInput.name = 'usedPoints';
            pointsInput.value = usedPoints;
            form.appendChild(pointsInput);
        }

        // ìµœì¢… ê²°ì œ ê¸ˆì•¡ ì¶”ê°€
        const finalAmountInput = document.createElement('input');
        finalAmountInput.type = 'hidden';
        finalAmountInput.name = 'finalAmount';
        finalAmountInput.value = finalAmount;
        form.appendChild(finalAmountInput);

        document.body.appendChild(form);

        // í¼ ì „ì†¡ í›„ ì‘ë‹µ ì²˜ë¦¬ë¥¼ ìœ„í•´ fetch ì‚¬ìš©
        const formData = new FormData(form);

        fetch('/order/create', {
            method: 'POST',
            body: formData,
            credentials: 'include'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                // ì„ íƒì ìœ¼ë¡œ ì£¼ë¬¸ ì™„ë£Œ í˜ì´ì§€ë¡œ ì´ë™
                // window.location.href = '/order/success?orderId=' + data.orderId;
            } else {
                alert(data.message);
            }
        })
        .catch(error => {
            console.error('ì£¼ë¬¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:', error);
            alert('ì£¼ë¬¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
        })
        .finally(() => {
            // í¼ ì œê±°
            document.body.removeChild(form);
        });
    }

    // ìˆ«ì í¬ë§·íŒ… (ì½¤ë§ˆ ì¶”ê°€)
    function formatPrice(price) {
        if (price === null || price === undefined || isNaN(price)) {
            return '0';
        }
        return Number(price).toLocaleString('ko-KR');
    }

    // ë‚ ì§œ í¬ë§·íŒ…
    function formatDate(dateString) {
        if (!dateString) return '';
        const date = new Date(dateString);
        return date.toLocaleDateString('ko-KR');
    }

    // ë”°ì˜´í‘œ ì´ìŠ¤ì¼€ì´í”„
    function escapeQuotes(str) {
        if (!str) return '';
        return str.replace(/'/g, "\\'").replace(/"/g, '\\"');
    }

    // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
    window.onclick = function(event) {
        const modal = document.getElementById('couponModal');
        if (event.target == modal) {
            modal.style.display = 'none';
        }
    }
  </script>

  <style>
    .payment-method {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .method-option {
      display: flex;
      align-items: center;
    }

    .method-option input[type="radio"] {
      margin-right: 12px;
    }

    .method-option label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      font-size: 14px;
    }

    .method-logo {
      font-size: 16px;
    }

    .method-tag {
      background: #e3f2fd;
      color: #1976d2;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 500;
    }

    .installment-info {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid #eee;
      font-size: 12px;
      color: #666;
    }

    .installment-info p {
      margin: 0;
      font-weight: 500;
      color: #333;
    }

    .installment-info small {
      display: block;
      margin-top: 4px;
    }
  </style>
</body>
</html>