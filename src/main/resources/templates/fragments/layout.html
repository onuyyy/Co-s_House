<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head th:fragment="head(title)">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title th:text="${title}">코딩의 집</title>
  <link rel="icon" th:href="@{/images/logo.png}" type="image/png" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-Fo3rlrZj/k7ujTnHg4CGR2D7kSs0v4LLanw2qksYuRlKq2a7mS5tnEEn9F/nx0xwu1jHq+8a6B1Z4x1N2R5xjw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="stylesheet" th:href="@{/css/app.css}">
  <link rel="stylesheet" th:href="@{/css/main/header.css}">
</head>
<body class="page font-body">
  <header th:fragment="header" class="site-header">
    <div class="header-banner">
      코딩의집 이벤트 배너
    </div>
    <nav class="navbar" aria-label="주요 메뉴">
      <div class="nav-container">
        <a th:href="@{/}" class="logo">코딩의집</a>
        <ul class="nav-menu">
          <li><a th:href="@{/product}" th:classappend="${#httpServletRequest != null and #strings.startsWith(#httpServletRequest.requestURI, '/product')} ? 'is-active' : ''">쇼핑</a></li>
            <li>
                <a th:href="@{/posts}"
                   th:classappend="${#httpServletRequest != null and #strings.startsWith(#httpServletRequest.requestURI, '/posts')} ? 'is-active' : ''">
                    커뮤니티
                </a>
            </li>
            <li>
                <a th:href="@{/events}"
                   th:classappend="${#httpServletRequest != null and #strings.startsWith(#httpServletRequest.requestURI, '/events')} ? 'is-active' : ''">
                    이벤트
                </a>
            </li>
        </ul>
        <div class="nav-right">
          <div class="search-container">
            <form th:action="@{/search}" method="get" class="search-form">
              <input type="text" name="keyword" class="search-input-global" placeholder="통합검색" th:value="${param.keyword != null ? param.keyword : (keyword != null ? keyword : '')}" />
              <button type="submit" class="search-btn-global"><i class="fas fa-search"></i></button>
            </form>
          </div>
          <div class="nav-icons">
            <a th:href="@{/cart}" class="nav-icon">
              <img th:src="@{/images/장바구니.png}" alt="장바구니" class="icon-img" />
            </a>
            <a th:href="@{/heart}" class="nav-icon">
              <img th:src="@{/images/좋아요전.png}" alt="하트" class="icon-img" />
            </a>
            <a th:href="@{/history}" class="nav-icon">
              <img th:src="@{/images/북마크전.png}" alt="북마크" class="icon-img" />
            </a>
            <a th:href="@{/customer}" class="nav-icon">
              <img th:src="@{/images/고객센터.png}" alt="고객센터" class="icon-img" />
            </a>
          </div>
          <div class="user-actions" data-auth-state="${session.user != null ? 'logged-in' : 'logged-out'}">
            <span class="auth-links auth-guest" th:classappend="${session.user != null} ? ' is-hidden'">
              <a th:href="@{/controller/register/login}" class="link-auth">로그인</a>
              <a th:href="@{/account/register}" class="link-auth primary">회원가입</a>
            </span>
            <span class="auth-links auth-member" th:classappend="${session.user == null} ? ' is-hidden'">
              <a th:href="@{/mypage}" class="link-auth">마이페이지</a>
              <form th:action="@{/controller/register/logout}" method="post" class="logout-form" data-role="logout-form">
                <button type="submit" class="link-auth">로그아웃</button>
                <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
              </form>
            </span>
            <a class="user-btn" th:href="@{/posts/new}">글쓰기 ▼</a>  <!-- 포스트 링크 바꾸기 -->
          </div>
        </div>
      </div>
    </nav>
  </header>

  <script>
    (function () {
      var header = document.querySelector('.site-header');
      if (!header || !document.body) {
        return;
      }

      function updateHeaderOffset() {
        document.body.style.setProperty('--header-offset', header.offsetHeight + 'px');
      }

      if (window.ResizeObserver) {
        var observer = new ResizeObserver(function () {
          updateHeaderOffset();
        });
        observer.observe(header);
      }

      window.addEventListener('resize', updateHeaderOffset, { passive: true });
      window.addEventListener('load', updateHeaderOffset, { once: true });
      if (document.readyState === 'loading') {
        window.addEventListener('DOMContentLoaded', updateHeaderOffset, { once: true });
      } else {
        updateHeaderOffset();
      }
    })();
  </script>

  <script>
    (function () {
      const authContainer = document.querySelector('[data-auth-state]');
      if (!authContainer) {
        return;
      }

      const guestBlock = authContainer.querySelector('.auth-guest');
      const memberBlock = authContainer.querySelector('.auth-member');
      const logoutForm = authContainer.querySelector('form[data-role="logout-form"]');

      const setState = (state) => {
        authContainer.dataset.authState = state;
        if (state === 'logged-in') {
          guestBlock?.classList.add('is-hidden');
          memberBlock?.classList.remove('is-hidden');
        } else {
          memberBlock?.classList.add('is-hidden');
          guestBlock?.classList.remove('is-hidden');
        }
      };

      const syncState = async () => {
        try {
          const res = await fetch('/controller/register/me', { credentials: 'same-origin' });
          setState(res.ok ? 'logged-in' : 'logged-out');
        } catch (err) {
          console.error('auth state sync failed', err);
        }
      };

      logoutForm?.addEventListener('submit', async (event) => {
        event.preventDefault();
        const action = logoutForm.getAttribute('action');
        const formData = new FormData(logoutForm);
        const headers = {
          'X-Requested-With': 'XMLHttpRequest',
          'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8'
        };
        const params = new URLSearchParams();
        const previousState = authContainer.dataset.authState;
        const logoutButton = logoutForm.querySelector('button');

        logoutButton?.setAttribute('disabled', 'disabled');
        setState('logged-out');

        for (const [key, value] of formData.entries()) {
          if (key) {
            params.append(key, value);
            if (key.toLowerCase().includes('csrf')) {
              headers['X-CSRF-TOKEN'] = value;
            }
          }
        }

        try {
          const response = await fetch(action, {
            method: 'POST',
            credentials: 'same-origin',
            headers,
            body: params.toString()
          });

          if (response.ok || response.status === 204) {
            window.location.href = '/controller/register/login';
            return;
          }

          setState(previousState);
          logoutButton?.removeAttribute('disabled');
          window.location.href = action;
        } catch (error) {
          console.error('logout failed', error);
          setState(previousState);
          logoutButton?.removeAttribute('disabled');
          window.location.href = action;
        }
      });

      const initialState = authContainer.dataset.authState === 'logged-in' ? 'logged-in' : 'logged-out';
      setState(initialState);
      syncState();
    })();
  </script>

  <script>
    (function () {
      const forms = document.querySelectorAll('.search-form');
      if (!forms.length) {
        return;
      }

      forms.forEach(function (form) {
        const input = form.querySelector('input[name="keyword"]');
        form.addEventListener('submit', function (event) {
          if (!input) {
            return;
          }

          const trimmed = input.value.trim();
          if (!trimmed) {
            event.preventDefault();
            input.value = '';
            input.focus();
            return;
          }

          input.value = trimmed;
        });
      });
    })();
  </script>

  <footer th:fragment="footer" class="app-footer">
    <div class="container footer-wrap">
      <div class="footer-brand">
        <a th:href="@{/}" class="brand">
          <img class="logo" th:src="@{/images/logo.png}" alt="코딩의집" />
          <span class="name">코딩의 집</span>
        </a>
        <div class="footer-contact">
          <span>고객센터 1234-5678 (평일 10:00 - 19:00)</span>
          <a href="mailto:hello@codinghouse.kr">Co-s_House@codinghouse.kr</a>
          <span>서울 강남구 강남대로 364, 11층</span>
        </div>
      </div>

      <div class="footer-links">
        <div class="link-group">
          <h4>서비스</h4>
          <a th:href="@{/product}">스토어</a>
          <a th:href="@{/templates/posts}">커뮤니티</a>
          <a th:href="@{/events}">이벤트</a>
          <a th:href="@{/notices}">공지사항</a>
        </div>
        <div class="link-group">
          <h4>안내</h4>
          <a th:href="@{/policy/terms}">이용약관</a>
          <a th:href="@{/policy/privacy}">개인정보처리방침</a>
          <a th:href="@{/policy/guide}">운영정책</a>
          <a th:href="@{/support}">FAQ</a>
        </div>
      </div>
    </div>

    <div class="footer-bottom">
      <div class="container footer-bottom-inner">
        <div class="corp-info">(주)코딩의집 | 대표이사 오원준 | 사업자등록번호 123-45-67890</div>
        <div class="footer-legal"> </div>
        <div class="copyright">© <span th:text="${#dates.format(#dates.createNow(),'yyyy')}">2025</span> CODING HOUSE</div>
      </div>
    </div>
  </footer>
</body>
</html>
