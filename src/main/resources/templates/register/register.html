<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>회원가입 | 코딩의 집</title>
    <link rel="stylesheet" th:href="@{/css/app.css}">
    <link rel="stylesheet" th:href="@{/css/auth.css}">
</head>
<body class="register-page">
<main class="register-shell">
    <div class="register-brand" aria-label="서비스 로고">
        <img class="logo" th:src="@{/images/logo.png}" alt="코딩의 집 로고" />
        <div class="name">코딩의 집</div>    </div>

    <section class="register-shell__form" aria-label="회원가입 폼">
        <div class="register-card">
            <header class="register-card__header">
                <h2>회원가입</h2>
            </header>

            <div class="register-social">
                <p class="register-social__title">SNS 계정으로 빠르게 시작하기</p>
                <div class="register-social__buttons" role="group" aria-label="소셜 회원가입">
                    <a th:href="@{/oauth2/authorization/kakao}" class="social-btn --kakao" aria-label="카카오로 회원가입">
                        <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                            <path d="M12 4.5c-4.42 0-8 2.64-8 5.9 0 1.93 1.24 3.64 3.15 4.75l-1 3.35a.6.6 0 0 0 .9.68l3.5-2.2c.46.05.93.08 1.45.08 4.42 0 8-2.64 8-5.9S16.42 4.5 12 4.5z" />
                        </svg>
                        카카오로 계속하기
                    </a>
                    <a th:href="@{/oauth2/authorization/naver}" class="social-btn --naver" aria-label="네이버로 회원가입">
                        <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                            <path d="M7 5h4.2l5.8 8.1V5H19v14h-4.2L9 10.9V19H7z" />
                        </svg>
                        네이버로 계속하기
                    </a>
                </div>
            </div>

            <div class="register-divider" role="separator" aria-label="또는"></div>

            <form id="registerForm" novalidate>
                <div class="form-grid">
                    <div class="form-field">
                        <label for="name">이름</label>
                        <input id="name" name="name" type="text" class="input" placeholder="실명을 입력해주세요" required minlength="2" maxlength="20" autocomplete="name">
                        <span class="field-error" id="nameError" hidden></span>
                    </div>

                    <div class="form-field">
                        <label for="nickname">닉네임</label>
                        <input id="nickname" name="nickname" type="text" class="input" placeholder="닉네임" required minlength="2" maxlength="20" autocomplete="nickname">
                        <span class="field-error" id="nicknameError" hidden></span>
                    </div>

                    <div class="form-field" data-field="email">
                        <label for="email">이메일</label>
                        <div class="field-inline">
                            <input id="email" name="email" type="email" class="input" placeholder="example@email.com" required autocomplete="email">
                            <button type="button" class="chip-button" id="emailSendBtn">인증 메일 보내기</button>
                        </div>
                        <p class="field-hint">회원가입 및 본인 확인을 위해 사용됩니다.</p>
                        <span class="field-error" id="emailError" hidden></span>
                    </div>

                    <div class="form-field" id="emailCodeField" hidden>
                        <label for="emailCode">인증번호</label>
                        <div class="field-inline">
                            <input id="emailCode" type="text" class="input" placeholder="6자리 숫자" maxlength="6" inputmode="numeric" autocomplete="one-time-code">
                            <button type="button" class="chip-button" id="emailConfirmBtn">인증 확인</button>
                        </div>
                        <div class="field-meta" id="emailStatus" aria-live="polite"></div>
                    </div>

                    <div class="form-field">
                        <label for="password">비밀번호</label>
                        <input id="password" name="password" type="password" class="input" placeholder="영문, 숫자를 포함한 8자 이상" required minlength="8" autocomplete="new-password">
                        <span class="field-error" id="passwordError" hidden></span>
                    </div>

                    <div class="form-field">
                        <label for="passwordConfirm">비밀번호 확인</label>
                        <input id="passwordConfirm" name="passwordConfirm" type="password" class="input" placeholder="비밀번호를 다시 입력해주세요" required autocomplete="new-password">
                        <span class="field-error" id="passwordConfirmError" hidden></span>
                    </div>

                    <div class="form-field">
                        <label for="phone">휴대폰 번호</label>
                        <input id="phone" name="phone" type="tel" class="input" placeholder="010-0000-0000" required autocomplete="tel-national">
                        <span class="field-error" id="phoneError" hidden></span>
                    </div>

                    <div class="form-field address-field">
                        <label for="address">주소</label>
                        <div class="field-inline">
                            <input id="address" name="address" type="text" class="input" placeholder="주소 검색 버튼을 눌러주세요" required readonly>
                            <button type="button" class="chip-button" id="addressSearchBtn">주소 검색</button>
                        </div>
                        <input id="addressDetail" name="addressDetail" type="text" class="input --muted" placeholder="상세 주소 (선택)" autocomplete="address-line2">
                        <span class="field-error" id="addressError" hidden></span>
                    </div>
                </div>

                <section class="terms-card" aria-labelledby="termsTitle">
                    <div class="terms-card__header">
                        <label class="checkbox">
                            <input type="checkbox" id="agreeAll">
                            <span class="checkbox__indicator" aria-hidden="true"></span>
                            <span>모든 약관에 동의합니다</span>
                        </label>
                        <p id="termsTitle">필수 항목에 동의해야 가입이 완료됩니다.</p>
                    </div>

                    <ul class="terms-list">
                        <li>
                            <label class="checkbox">
                                <input type="checkbox" id="agreeAge" required>
                                <span class="checkbox__indicator" aria-hidden="true"></span>
                                <span>만 14세 이상입니다 <strong class="required">(필수)</strong></span>
                            </label>
                        </li>
                        <li>
                            <label class="checkbox">
                                <input type="checkbox" id="agreeTerms" required>
                                <span class="checkbox__indicator" aria-hidden="true"></span>
                                <span><a href="/terms" target="_blank" rel="noopener">이용약관</a>에 동의합니다 <strong class="required">(필수)</strong></span>
                            </label>
                        </li>
                        <li>
                            <label class="checkbox">
                                <input type="checkbox" id="agreePrivacy" required>
                                <span class="checkbox__indicator" aria-hidden="true"></span>
                                <span><a href="/privacy" target="_blank" rel="noopener">개인정보 처리방침</a>에 동의합니다 <strong class="required">(필수)</strong></span>
                            </label>
                        </li>
                        <li>
                            <label class="checkbox">
                                <input type="checkbox" id="agreeMarketing">
                                <span class="checkbox__indicator" aria-hidden="true"></span>
                                <span>이벤트・마케팅 정보 수신에 동의합니다 <span class="optional">(선택)</span></span>
                            </label>
                        </li>
                    </ul>
                </section>

                <button type="submit" class="register-submit" id="registerSubmit" disabled>회원가입 완료하기</button>
                <input type="hidden" id="csrfToken" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
            </form>

            <div id="registerMessage" class="register-alert" role="status" aria-live="polite" hidden></div>

            <footer class="register-card__footer">
                이미 계정이 있으신가요? <a th:href="@{/controller/register/login}">로그인으로 이동</a>
            </footer>
        </div>
    </section>
</main>

<script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const state = {
            emailVerified: false,
            verificationRequested: false
        };

        const form = document.getElementById('registerForm');
        const submitButton = document.getElementById('registerSubmit');
        const registerMessage = document.getElementById('registerMessage');
        const csrfInput = document.getElementById('csrfToken');

        const emailInput = document.getElementById('email');
        const emailSendBtn = document.getElementById('emailSendBtn');
        const emailCodeField = document.getElementById('emailCodeField');
        const emailCodeInput = document.getElementById('emailCode');
        const emailConfirmBtn = document.getElementById('emailConfirmBtn');
        const emailStatus = document.getElementById('emailStatus');

        const addressBtn = document.getElementById('addressSearchBtn');
        const addressInput = document.getElementById('address');
        const addressDetailInput = document.getElementById('addressDetail');
        const phoneInput = document.getElementById('phone');

        const agreementAll = document.getElementById('agreeAll');
        const agreementRequired = document.querySelectorAll('.terms-list input[required]');

        phoneInput.addEventListener('input', formatPhoneNumber);

        form.querySelectorAll('input[required]').forEach(input => {
            input.addEventListener('input', () => {
                validateField(input);
                updateSubmitState();
            });
            input.addEventListener('blur', () => validateField(input));
        });

        agreementAll.addEventListener('change', () => {
            const isChecked = agreementAll.checked;
            document.querySelectorAll('.terms-list input[type="checkbox"]').forEach(box => {
                box.checked = isChecked;
            });
            updateSubmitState();
        });

        document.querySelectorAll('.terms-list input[type="checkbox"]').forEach(box => {
            box.addEventListener('change', updateSubmitState);
        });

        emailInput.addEventListener('input', () => {
            state.emailVerified = false;
            state.verificationRequested = false;
            emailCodeField.hidden = true;
            emailStatus.textContent = '';
            emailSendBtn.disabled = false;
            emailConfirmBtn.disabled = false;
            emailCodeInput.value = '';
            updateSubmitState();
        });

        emailSendBtn.addEventListener('click', async () => {
            const nameValue = document.getElementById('name').value.trim();
            const emailValue = emailInput.value.trim();

            if (!validateField(emailInput)) {
                showInlineError('email', '올바른 이메일을 입력해주세요.');
                return;
            }

            emailSendBtn.disabled = true;
            emailSendBtn.textContent = '발송 중...';
            clearEmailStatus();

            try {
                const response = await fetch('/auth/email/verification/request', {
                    method: 'POST',
                    headers: buildHeaders({ 'Content-Type': 'application/json' }),
                    body: JSON.stringify({ name: nameValue || '회원', email: emailValue })
                });

                const result = await response.json().catch(() => ({}));

                if (response.ok) {
                    state.verificationRequested = true;
                    emailCodeField.hidden = false;
                    setEmailStatus('인증번호를 발송했습니다. 5분 이내에 입력해주세요.', 'info');
                } else {
                    setEmailStatus(result.message || '메일 발송에 실패했습니다. 잠시 후 다시 시도해주세요.', 'error');
                }
            } catch (error) {
                setEmailStatus('네트워크 오류가 발생했습니다. 다시 시도해주세요.', 'error');
            } finally {
                emailSendBtn.disabled = false;
                emailSendBtn.textContent = '인증 메일 보내기';
                updateSubmitState();
            }
        });

        emailConfirmBtn.addEventListener('click', async () => {
            const code = emailCodeInput.value.trim();
            const emailValue = emailInput.value.trim();

            if (!state.verificationRequested) {
                setEmailStatus('먼저 인증 메일을 발송해주세요.', 'error');
                return;
            }

            if (!code || code.length !== 6 || !/^\d+$/.test(code)) {
                setEmailStatus('6자리 숫자 인증번호를 입력해주세요.', 'error');
                return;
            }

            emailConfirmBtn.disabled = true;
            emailConfirmBtn.textContent = '확인 중...';

            try {
                const response = await fetch('/auth/email/verification/confirm', {
                    method: 'POST',
                    headers: buildHeaders({ 'Content-Type': 'application/json' }),
                    body: JSON.stringify({ email: emailValue, code })
                });

                const result = await response.json().catch(() => ({}));

                if (response.ok && result.verified) {
                    state.emailVerified = true;
                    setEmailStatus('이메일 인증이 완료되었습니다.', 'success');
                    emailInput.readOnly = true;
                    emailSendBtn.disabled = true;
                    emailConfirmBtn.disabled = true;
                    emailCodeInput.disabled = true;
                    emailCodeInput.value = '';
                } else {
                    setEmailStatus(result.message || '인증번호가 일치하지 않습니다.', 'error');
                }
            } catch (error) {
                setEmailStatus('인증에 실패했습니다. 다시 시도해주세요.', 'error');
            } finally {
                emailConfirmBtn.disabled = state.emailVerified;
                emailConfirmBtn.textContent = state.emailVerified ? '인증 완료' : '인증 확인';
                updateSubmitState();
            }
        });

        addressBtn.addEventListener('click', openAddressSearch);

        form.addEventListener('submit', async (event) => {
            event.preventDefault();

            const requiredFields = Array.from(form.querySelectorAll('input[required]'));
            let isValid = true;

            requiredFields.forEach(field => {
                if (!validateField(field)) {
                    isValid = false;
                }
            });

            if (!state.emailVerified) {
                setEmailStatus('이메일 인증 완료 후 가입할 수 있습니다.', 'error');
                isValid = false;
            }

            if (!isValid) {
                showMessage('입력한 정보를 다시 확인해주세요.', 'error');
                return;
            }

            submitButton.disabled = true;
            submitButton.textContent = '가입 처리 중...';

            try {
                const payload = {
                    name: document.getElementById('name').value.trim(),
                    nickname: document.getElementById('nickname').value.trim(),
                    email: emailInput.value.trim(),
                    password: document.getElementById('password').value,
                    phone: phoneInput.value.trim(),
                    address: [addressInput.value.trim(), addressDetailInput.value.trim()].filter(Boolean).join(' ')
                };

                const response = await fetch('/controller/register/register', {
                    method: 'POST',
                    headers: buildHeaders({ 'Content-Type': 'application/json' }),
                    body: JSON.stringify(payload)
                });

                const result = await response.json().catch(() => ({}));

                if (response.ok) {
                    showMessage('회원가입이 완료되었습니다. 로그인 페이지로 이동합니다.', 'success');
                    setTimeout(() => {
                        window.location.href = '/controller/register/login?registered=true';
                    }, 1200);
                } else {
                    showMessage(result.message || '회원가입 중 문제가 발생했습니다.', 'error');
                }
            } catch (error) {
                showMessage('네트워크 오류가 발생했습니다. 잠시 후 다시 시도해주세요.', 'error');
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = '회원가입 완료하기';
            }
        });

        function updateSubmitState() {
            const requiredInputs = form.querySelectorAll('input[required]');
            const everyInputValid = Array.from(requiredInputs).every(field => field.value.trim() && !field.classList.contains('error'));
            const everyAgreementChecked = Array.from(agreementRequired).every(box => box.checked);
            submitButton.disabled = !(everyInputValid && everyAgreementChecked && state.emailVerified);
        }

        function validateField(field) {
            const value = field.value.trim();
            const errorElement = document.getElementById(field.name + 'Error');
            let message = '';

            switch (field.name) {
                case 'name':
                    if (!value) {
                        message = '이름을 입력해주세요.';
                    } else if (value.length < 2) {
                        message = '이름은 2자 이상이어야 합니다.';
                    }
                    break;
                case 'nickname':
                    if (!value) {
                        message = '닉네임을 입력해주세요.';
                    } else if (value.length < 2 || value.length > 20) {
                        message = '닉네임은 2~20자 이내로 입력해주세요.';
                    }
                    break;
                case 'email':
                    if (!value) {
                        message = '이메일을 입력해주세요.';
                    } else if (!/^\S+@\S+\.\S+$/.test(value)) {
                        message = '올바른 이메일 형식이 아닙니다.';
                    }
                    break;
                case 'password':
                    if (!value) {
                        message = '비밀번호를 입력해주세요.';
                    } else if (value.length < 8 || !/(?=.*[A-Za-z])(?=.*\d)/.test(value)) {
                        message = '영문과 숫자를 포함한 8자 이상으로 입력해주세요.';
                    }
                    break;
                case 'passwordConfirm':
                    if (!value) {
                        message = '비밀번호를 다시 입력해주세요.';
                    } else if (value !== document.getElementById('password').value) {
                        message = '비밀번호가 일치하지 않습니다.';
                    }
                    break;
                case 'phone':
                    if (!value) {
                        message = '휴대폰 번호를 입력해주세요.';
                    } else if (!/^010-\d{4}-\d{4}$/.test(value)) {
                        message = '010-0000-0000 형식으로 입력해주세요.';
                    }
                    break;
                case 'address':
                    if (!value) {
                        message = '주소를 입력해주세요.';
                    }
                    break;
            }

            field.classList.toggle('error', Boolean(message));
            if (errorElement) {
                errorElement.textContent = message;
                errorElement.hidden = !message;
            }
            return !message;
        }

        function buildHeaders(init = {}) {
            const headers = { ...init };
            if (csrfInput && csrfInput.name && csrfInput.value) {
                headers['X-CSRF-TOKEN'] = csrfInput.value;
            }
            return headers;
        }

        function showInlineError(name, message) {
            const errorElement = document.getElementById(name + 'Error');
            if (errorElement) {
                errorElement.textContent = message;
                errorElement.hidden = false;
            }
        }

        function showMessage(text, type) {
            registerMessage.textContent = text;
            registerMessage.className = `register-alert --${type}`;
            registerMessage.hidden = false;
            setTimeout(() => {
                registerMessage.hidden = true;
            }, 3500);
        }

        function clearEmailStatus() {
            emailStatus.textContent = '';
            emailStatus.className = 'field-meta';
        }

        function setEmailStatus(text, type) {
            emailStatus.textContent = text;
            emailStatus.className = `field-meta --${type}`;
        }

        function formatPhoneNumber(event) {
            const numbersOnly = event.target.value.replace(/[^\d]/g, '');
            let formatted = numbersOnly;

            if (numbersOnly.length > 3 && numbersOnly.length <= 7) {
                formatted = `${numbersOnly.slice(0, 3)}-${numbersOnly.slice(3)}`;
            } else if (numbersOnly.length > 7) {
                formatted = `${numbersOnly.slice(0, 3)}-${numbersOnly.slice(3, 7)}-${numbersOnly.slice(7, 11)}`;
            }

            event.target.value = formatted;
        }

        function openAddressSearch() {
            if (!window.daum || !window.daum.Postcode) {
                showMessage('주소 검색 서비스를 불러오지 못했습니다.', 'error');
                return;
            }

            new daum.Postcode({
                oncomplete: function(data) {
                    const addr = data.userSelectedType === 'R' ? data.roadAddress : data.jibunAddress;
                    addressInput.value = addr;
                    addressDetailInput.focus();
                    validateField(addressInput);
                    updateSubmitState();
                }
            }).open();
        }
    });
</script>
</body>
</html>
