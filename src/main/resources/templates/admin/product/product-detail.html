<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" 
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" 
      layout:decorate="~{layout/admin-layout}"
      lang="ko">
<head>
    <title>ìƒí’ˆ ìƒì„¸ì •ë³´</title>
    <link rel="stylesheet" th:href="@{/css/admin/admin-common.css}">
    <link rel="stylesheet" th:href="@{/css/admin/product.css}">
</head>
<body>
    <div layout:fragment="content-header" class="content-header">
        <h2 class="page-title">ìƒí’ˆ ìƒì„¸ì •ë³´</h2>
        <div class="header-actions">
            <a th:href="@{/api/admin/products}" class="btn btn-secondary">ëª©ë¡ìœ¼ë¡œ</a>
        </div>
    </div>

    <div layout:fragment="content">
        <div th:if="${param.success}" class="alert alert-success">ìƒí’ˆ ì •ë³´ê°€ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.</div>
        <div th:if="${param.error}" class="alert alert-danger" th:text="${param.error}">ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>

        <div class="product-mode-selector">
            <button id="viewMode" class="product-mode-btn active" onclick="toggleMode('view')">ğŸ‘ï¸ ë³´ê¸° ëª¨ë“œ</button>
            <button id="editMode" class="product-mode-btn" onclick="toggleMode('edit')">âœï¸ ìˆ˜ì • ëª¨ë“œ</button>
        </div>

        <!-- ì½ê¸° ì „ìš© -->
        <div class="detail-card" id="viewSection">
            <h3>ğŸ“¦ ìƒí’ˆ ì •ë³´</h3>
            <div class="product-layout">
                <div class="product-image-section">
                    <div class="image-container">
                        <img th:if="${product.mainImageUrl != null and !product.mainImageUrl.isEmpty()}"
                             th:src="${product.mainImageUrl}"
                             th:alt="${product.productTitle}"
                             class="product-main-image">
                        <div th:unless="${product.mainImageUrl != null and !product.mainImageUrl.isEmpty()}"
                             class="no-image-large">ğŸ“·</div>
                    </div>
                </div>
                <div class="product-info-section">
                    <div class="product-detail-grid">
                        <div class="product-detail-label">ìƒí’ˆëª…</div><div class="product-detail-value" th:text="${product.productTitle}">ìƒí’ˆëª…</div>
                        <div class="product-detail-label">ë¸Œëœë“œ</div><div class="product-detail-value" th:text="${product.brandName ?: '-'}">ë¸Œëœë“œ</div>
                        <div class="product-detail-label">ì›ê°€</div><div class="product-detail-value" th:text="${product.originalPrice != null ? #numbers.formatCurrency(product.originalPrice) : '-'}">ì›ê°€</div>
                        <div class="product-detail-label">íŒë§¤ê°€</div><div class="product-detail-value" th:text="${product.salePrice != null ? #numbers.formatCurrency(product.salePrice) : '-'}">íŒë§¤ê°€</div>
                        <div class="product-detail-label">ì¬ê³ </div><div class="product-detail-value" th:text="${product.stockQuantity ?: 0}">ì¬ê³ </div>
                        <div class="product-detail-label">ìƒíƒœ</div><div class="product-detail-value"><span th:class="${product.productStatus == 'íŒë§¤ì¤‘' ? 'product-status-active' : 'product-status-inactive'}" th:text="${product.productStatus ?: '-'}">ìƒíƒœ</span></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ìˆ˜ì • í¼ -->
        <div class="detail-card hidden" id="editSection">
            <h3>âœï¸ ìƒí’ˆ ì •ë³´ ìˆ˜ì •</h3>
            <form th:action="@{/api/admin/products/{productId}/update(productId=${product.productId})}" method="post">
                <div class="edit-layout">
                    <div class="edit-image-section">
                        <div class="form-group">
                            <label for="productImage">ìƒí’ˆ ì´ë¯¸ì§€</label>
                            <div class="image-upload-container">
                                <div class="current-image">
                                    <img id="previewImage"
                                         th:if="${product.mainImageUrl != null and !product.mainImageUrl.isEmpty()}"
                                         th:src="${product.mainImageUrl}"
                                         class="edit-preview-image">
                                    <div id="noImagePreview"
                                         th:unless="${product.mainImageUrl != null and !product.mainImageUrl.isEmpty()}"
                                         class="no-image-preview">ğŸ“·</div>
                                </div>
                                <input type="url" id="productImage" name="productImage"
                                       th:value="${product.mainImageUrl}"
                                       class="product-form-control"
                                       placeholder="ì´ë¯¸ì§€ URLì„ ì…ë ¥í•˜ì„¸ìš”"
                                       onchange="updateImagePreview()">
                            </div>
                        </div>
                    </div>
                    <div class="edit-info-section">
                        <div class="product-form-group">
                            <label for="productTitle">ìƒí’ˆëª… *</label>
                            <input type="text" id="productTitle" name="productTitle" th:value="${product.productTitle}" class="product-form-control" required>
                        </div>
                        <div class="product-form-group">
                            <label for="originalPrice">ì›ê°€</label>
                            <input type="number" id="originalPrice" name="originalPrice" th:value="${product.originalPrice}" step="0.01" class="product-form-control">
                        </div>
                        <div class="product-form-group">
                            <label for="salePrice">íŒë§¤ê°€</label>
                            <input type="number" id="salePrice" name="salePrice" th:value="${product.salePrice}" step="0.01" class="product-form-control">
                        </div>
                        <div class="product-form-group">
                            <label for="stockQuantity">ì¬ê³ ìˆ˜ëŸ‰</label>
                            <input type="number" id="stockQuantity" name="stockQuantity" th:value="${product.stockQuantity}" class="product-form-control">
                        </div>
                    </div>
                </div>
                <div class="product-form-actions">
                    <button type="submit" class="btn btn-primary">ğŸ’¾ ìˆ˜ì • ì €ì¥</button>
                    <button type="button" class="btn btn-danger" onclick="deleteProduct()">ğŸ—‘ï¸ ì‚­ì œ</button>
                    <button type="button" class="btn btn-secondary" onclick="toggleMode('view')">âŒ ì·¨ì†Œ</button>
                </div>
            </form>
        </div>

        <div class="product-readonly-message" id="readonlyMessage">
            <strong>ì½ê¸° ì „ìš© ëª¨ë“œ</strong><br>í˜„ì¬ ìƒí’ˆ ì •ë³´ ì¡°íšŒë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.
        </div>
    </div>


    <th:block layout:fragment="extra-scripts">
        <script>
            function toggleMode(mode) {
                const viewBtn = document.getElementById('viewMode');
                const editBtn = document.getElementById('editMode');
                const viewSection = document.getElementById('viewSection');
                const editSection = document.getElementById('editSection');
                const readonlyMessage = document.getElementById('readonlyMessage');
                
                if (mode === 'view') {
                    viewBtn.classList.add('active'); editBtn.classList.remove('active');
                    viewSection.style.display = 'block'; editSection.classList.add('hidden'); readonlyMessage.style.display = 'block';
                } else {
                    editBtn.classList.add('active'); viewBtn.classList.remove('active');
                    viewSection.style.display = 'none'; editSection.classList.remove('hidden'); readonlyMessage.style.display = 'none';
                }
            }
            function deleteProduct() {
                if (confirm('ì •ë§ë¡œ ì´ ìƒí’ˆì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    const form = document.createElement('form');
                    form.method = 'POST';
                    form.action = '/api/admin/products/' + [[${product.productId}]] + '/delete';
                    document.body.appendChild(form);
                    form.submit();
                }
            }

            function updateImagePreview() {
                const imageUrl = document.getElementById('productImage').value;
                const previewImage = document.getElementById('previewImage');
                const noImagePreview = document.getElementById('noImagePreview');

                if (imageUrl && imageUrl.trim() !== '') {
                    if (previewImage) {
                        previewImage.src = imageUrl;
                        previewImage.style.display = 'block';
                    } else {
                        // ìƒˆ ì´ë¯¸ì§€ ì—˜ë¦¬ë¨¼íŠ¸ ìƒì„±
                        const newImg = document.createElement('img');
                        newImg.id = 'previewImage';
                        newImg.src = imageUrl;
                        newImg.className = 'edit-preview-image';
                        newImg.style.display = 'block';

                        const currentImageDiv = document.querySelector('.current-image');
                        currentImageDiv.innerHTML = '';
                        currentImageDiv.appendChild(newImg);
                    }
                    if (noImagePreview) {
                        noImagePreview.style.display = 'none';
                    }
                } else {
                    if (previewImage) {
                        previewImage.style.display = 'none';
                    }
                    if (noImagePreview) {
                        noImagePreview.style.display = 'flex';
                    } else {
                        // no-image div ìƒì„±
                        const noImageDiv = document.createElement('div');
                        noImageDiv.id = 'noImagePreview';
                        noImageDiv.className = 'no-image-preview';
                        noImageDiv.textContent = 'ğŸ“·';
                        noImageDiv.style.display = 'flex';

                        const currentImageDiv = document.querySelector('.current-image');
                        currentImageDiv.innerHTML = '';
                        currentImageDiv.appendChild(noImageDiv);
                    }
                }
            }
        </script>
    </th:block>
</body>
</html>