<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/admin-layout}"
      lang="ko">
<head>
    <title>상품 등록</title>
    <meta charset="UTF-8">
    <link rel="stylesheet" th:href="@{/css/admin/admin-common.css}">
    <link rel="stylesheet" th:href="@{/css/admin/product.css}">
</head>
<body>
    <!-- Content Header -->
    <div layout:fragment="content-header" class="content-header">
        <div>
            <div class="breadcrumb">
                <a href="/api/admin/products">상품 관리</a> > 상품 등록
            </div>
            <h2 class="page-title-large">상품 등록</h2>
        </div>
        <div>
            <a href="/api/admin/products" class="btn btn-secondary">목록으로</a>
        </div>
    </div>

    <!-- Main Content -->
    <div layout:fragment="content">
        <!-- 알림 메시지 -->
        <div th:if="${param.success}" class="alert alert-success">
            상품이 성공적으로 등록되었습니다.
        </div>
        <div th:if="${param.error}" class="alert alert-danger">
            <span th:text="${param.error}">오류가 발생했습니다.</span>
        </div>

        <div class="product-form-card">
            <div class="product-form-card-header">
                <h3>📦 상품 정보 입력</h3>
            </div>
            <div class="product-form-card-body">
                <form th:action="@{/api/admin/products}" method="post" class="product-form">

                    <!-- 기본 정보 -->
                    <div class="product-form-section">
                        <h4 class="section-title">기본 정보</h4>

                        <div class="product-form-row">
                            <div class="product-form-group">
                                <label for="productTitle" class="required">상품명 *</label>
                                <input type="text" id="productTitle" name="productTitle"
                                       class="product-form-control" required maxlength="200"
                                       placeholder="상품명을 입력하세요">
                            </div>

                            <div class="product-form-group">
                                <label for="brandId" class="required">브랜드 *</label>
                                <select id="brandId" name="brandId" class="product-form-control" required>
                                    <option value="">브랜드를 선택하세요</option>
                                    <option th:each="brand : ${brandList}"
                                            th:value="${brand.brandId}"
                                            th:text="${brand.brandName}">브랜드명</option>
                                </select>
                            </div>
                        </div>

                        <div class="product-form-row">
                            <div class="product-form-group">
                                <label for="categoryId1" class="required">1차 카테고리 *</label>
                                <select id="categoryId1" name="categoryId1" class="product-form-control" required>
                                    <option value="">1차 카테고리를 선택하세요</option>
                                    <option th:each="category : ${category_level1}"
                                            th:value="${category.productCategoryId}"
                                            th:text="${category.productCategoryName}">카테고리명</option>
                                </select>
                            </div>

                            <div class="product-form-group">
                                <label for="productCategoryId">2차 카테고리</label>
                                <select id="productCategoryId" name="productCategoryId" class="product-form-control hidden">
                                    <option value="">2차 카테고리를 선택하세요</option>
                                </select>
                            </div>
                        </div>

                        <div class="product-form-row">
                            <div class="product-form-group full-width">
                                <label for="description">상품 설명</label>
                                <textarea id="description" name="description"
                                          class="product-form-control" rows="4" maxlength="1000"
                                          placeholder="상품에 대한 자세한 설명을 입력하세요"></textarea>
                            </div>
                        </div>

                        <div class="product-form-row">
                            <div class="product-form-group">
                                <label for="mainImageUrl">대표 이미지 URL</label>
                                <input type="url" id="mainImageUrl" name="mainImageUrl"
                                       class="product-form-control" maxlength="500"
                                       placeholder="https://example.com/image.jpg">
                            </div>
                        </div>
                    </div>

                    <!-- 가격 정보 -->
                    <div class="product-form-section">
                        <h4 class="section-title">가격 정보</h4>

                        <div class="product-form-row">
                            <div class="product-form-group">
                                <label for="originalPrice" class="required">정가 *</label>
                                <input type="number" id="originalPrice" name="originalPrice"
                                       class="product-form-control" required min="0" step="0.01"
                                       placeholder="0.00">
                            </div>

                            <div class="product-form-group">
                                <label for="salePrice" class="required">판매가 *</label>
                                <input type="number" id="salePrice" name="salePrice"
                                       class="product-form-control" required min="0" step="0.01"
                                       placeholder="0.00">
                            </div>
                        </div>

                        <div class="product-form-row">
                            <div class="product-form-group">
                                <label for="couponPrice">쿠폰 할인가</label>
                                <input type="number" id="couponPrice" name="couponPrice"
                                       class="product-form-control" min="0" step="0.01"
                                       placeholder="0.00">
                            </div>

                            <div class="product-form-group">
                                <label for="discountRate">할인율 (%)</label>
                                <input type="number" id="discountRate" name="discountRate"
                                       class="product-form-control" min="0" max="100" step="0.01"
                                       placeholder="0.00">
                            </div>
                        </div>
                    </div>

                    <!-- 상품 옵션 -->
                    <div class="product-form-section">
                        <h4 class="section-title">상품 옵션</h4>

                        <div class="product-form-row">
                            <div class="product-form-group">
                                <label for="productColor">색상</label>
                                <input type="text" id="productColor" name="productColor"
                                       class="product-form-control" maxlength="50"
                                       placeholder="예: 화이트, 블랙">
                            </div>

                            <div class="product-form-group">
                                <label for="material">소재</label>
                                <input type="text" id="material" name="material"
                                       class="product-form-control" maxlength="100"
                                       placeholder="예: 면 100%">
                            </div>
                        </div>

                        <div class="product-form-row">
                            <div class="product-form-group">
                                <label for="capacity">용량/크기</label>
                                <input type="text" id="capacity" name="capacity"
                                       class="product-form-control" maxlength="50"
                                       placeholder="예: 250ml, L사이즈">
                            </div>

                            <div class="product-form-group">
                                <label for="stockQuantity" class="required">재고 수량 *</label>
                                <input type="number" id="stockQuantity" name="stockQuantity"
                                       class="product-form-control" required min="0"
                                       placeholder="0">
                            </div>
                        </div>
                    </div>

                    <!-- 판매 설정 -->
                    <div class="product-form-section">
                        <h4 class="section-title">판매 설정</h4>

                        <div class="product-form-row">
                            <div class="product-form-group product-checkbox-group">
                                <label>
                                    <input type="checkbox" name="isFreeShipping" value="true">
                                    <span class="checkbox-text">무료배송</span>
                                </label>
                            </div>

                            <div class="product-form-group product-checkbox-group">
                                <label>
                                    <input type="checkbox" name="isTodayDeal" value="true">
                                    <span class="checkbox-text">오늘의 딜</span>
                                </label>
                            </div>
                        </div>

                        <div class="product-form-row">
                            <div class="product-form-group product-checkbox-group">
                                <label>
                                    <input type="checkbox" name="isCohouseOnly" value="true">
                                    <span class="checkbox-text">코딩의집 전용</span>
                                </label>
                            </div>

                            <div class="product-form-group">
                                <label for="productStatusCodeId" class="required">상품 상태 *</label>
                                <select id="productStatusCodeId" name="productStatusCodeId" class="product-form-control" required>
                                    <option value="">상품 상태를 선택하세요</option>
                                    <option value="PRODUCT_001">판매중</option>
                                    <option value="PRODUCT_003">품절</option>
                                    <option value="PRODUCT_002">판매중지</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- 버튼 영역 -->
                    <div class="product-form-actions">
                        <button type="submit" class="btn btn-primary">
                            <i class="icon">💾</i> 상품 등록
                        </button>
                        <a href="/api/admin/products" class="btn btn-secondary">
                            <i class="icon">❌</i> 취소
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>


    <th:block layout:fragment="extra-scripts">
        <script>
            // 1차 카테고리 변경 시 2차 카테고리 로드
            document.getElementById('categoryId1').addEventListener('change', function() {
                const parentId = this.value;
                const category2Select = document.getElementById('productCategoryId');
                const existingHidden = this.parentNode.querySelector('input[name="productCategoryId"]');

                // 기존 hidden input 제거
                if (existingHidden) {
                    existingHidden.remove();
                }

                if (parentId) {
                    // Ajax로 자식 카테고리 조회
                    console.log('Fetching child categories for parentId:', parentId);
                    fetch(`/api/admin/products/categories/${parentId}/children`)
                        .then(response => {
                            console.log('Response status:', response.status);
                            if (!response.ok) {
                                throw new Error(`HTTP error! status: ${response.status}`);
                            }
                            return response.json();
                        })
                        .then(data => {
                            console.log('Received data:', data);
                            // 2차 카테고리 셀렉트박스 초기화
                            category2Select.innerHTML = '<option value="">2차 카테고리를 선택하세요</option>';

                            if (data && data.length > 0) {
                                // 자식 카테고리가 있으면 셀렉트박스 표시
                                console.log('Found', data.length, 'child categories');
                                data.forEach(category => {
                                    const option = document.createElement('option');
                                    option.value = category.productCategoryId;
                                    option.textContent = category.productCategoryName;
                                    category2Select.appendChild(option);
                                });
                                category2Select.classList.remove('hidden');
                                category2Select.required = true;
                            } else {
                                // 자식 카테고리가 없으면 1차 카테고리 ID를 사용
                                console.log('No child categories found, using parent ID');
                                category2Select.classList.add('hidden');
                                category2Select.required = false;
                                // Hidden input으로 1차 카테고리 ID 설정
                                const hiddenInput = document.createElement('input');
                                hiddenInput.type = 'hidden';
                                hiddenInput.name = 'productCategoryId';
                                hiddenInput.value = parentId;
                                this.parentNode.appendChild(hiddenInput);
                            }
                        })
                        .catch(error => {
                            console.error('카테고리 로드 상세 오류:', error);
                            alert('카테고리 로드 중 오류가 발생했습니다: ' + error.message);
                            category2Select.classList.add('hidden');
                        });
                } else {
                    // 1차 카테고리가 선택되지 않으면 2차 카테고리 숨김
                    category2Select.classList.add('hidden');
                    category2Select.required = false;
                }
            });

            // 가격 계산 (할인율 자동 계산)
            const originalPriceInput = document.getElementById('originalPrice');
            const salePriceInput = document.getElementById('salePrice');
            const discountRateInput = document.getElementById('discountRate');

            function calculateDiscountRate() {
                const originalPrice = parseFloat(originalPriceInput.value) || 0;
                const salePrice = parseFloat(salePriceInput.value) || 0;

                if (originalPrice > 0 && salePrice > 0 && salePrice < originalPrice) {
                    const discountRate = ((originalPrice - salePrice) / originalPrice * 100).toFixed(2);
                    discountRateInput.value = discountRate;
                }
            }

            originalPriceInput.addEventListener('input', calculateDiscountRate);
            salePriceInput.addEventListener('input', calculateDiscountRate);
        </script>
    </th:block>
</body>
</html>