<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ÏÉÅÌíà ÏÉÅÏÑ∏</title>

    <link rel="stylesheet" th:href="@{/css/app.css}">
    <link rel="stylesheet" th:href="@{/css/main/header.css}">
    <link rel="stylesheet" th:href="@{/css/product/productdetail.css}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>

<body class="page font-body">

    <div th:replace="~{fragments/layout :: header}"></div>

    <!-- Î©îÏù∏ Ïª®ÌÖêÏ∏† -->
    <main class="main-content">
        <div class="container">
            <div class="product-detail">
                <!-- ÏÉÅÌíà Ìó§Îçî -->
                <div class="product-header">
                <!-- ÏÉÅÌíà Ïù¥ÎØ∏ÏßÄ -->
                <div class="product-image">
                    <img th:src="${product.mainImageUrl}" alt="ÏÉÅÌíà ÎåÄÌëú Ïù¥ÎØ∏ÏßÄ" style="width:100%;">
                </div>

                <!-- ÏÉÅÌíà Ï†ïÎ≥¥ -->
                <div class="product-info"
                     th:data-product-id="${product.productId}"
                     th:data-title="${product.productTitle}"
                     th:data-image-url="${product.mainImageUrl}"
                     th:data-brand-id="${brandId}"
                     th:data-brand-name="${brand != null ? brand.brandName : ''}"
                     th:data-unit-price="${product.originalPrice}"
                     th:data-sale-price="${product.salePrice}"
                     th:data-coupon-price="${product.couponPrice}"
                     th:data-discount-rate="${product.discountRate}"
                     th:data-base-price="${basePrice}">
                    <!-- Î∏åÎûúÎìúÎ™Ö -->
                    <div class="brand-name" th:data-brand-id="${brandId}" onclick="goToBrandPage(this)">
                        <span th:text="${brand != null ? brand.brandName : 'Î∏åÎûúÎìúÎ™Ö'}">Î∏åÎûúÎìúÎ™Ö</span>
                    </div>

                    <h1 class="product-title" th:text="${product.productTitle}">ÏÉÅÌíàÎ™Ö</h1>

                    <div class="rating-section">
                        <div class="stars-outer">
                            ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ
                            <div class="stars-inner" th:style="${'width: ' + (overallAverageRating / 5.0 * 100) + '%'}">
                                ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ
                            </div>
                        </div>
                        <span class="review-count" th:text="${#numbers.formatInteger(totalReviewCount, 0, 'COMMA')} + 'Í∞ú Î¶¨Î∑∞'">99,386Í∞ú Î¶¨Î∑∞</span>
                    </div>

                    <!-- Í∞ÄÍ≤© -->
                    <div class="price-section">
                        <span th:if="${product.discountRate != null and product.discountRate > 0}"
                              class="discount-rate"
                              th:text="${product.discountRate} + '%'"></span>
                        <span class="current-price"
                              th:text="${#numbers.formatInteger(product.salePrice != null ? product.salePrice : product.originalPrice, 0, 'COMMA')}">39,900</span>
                        <span th:if="${product.salePrice != null and product.salePrice < product.originalPrice}"
                              class="original-price"
                              th:text="${#numbers.formatInteger(product.originalPrice, 0, 'COMMA')} + 'Ïõê'"></span>
                    </div>


                    <!-- ÏÉÅÌíà ÏÉÅÏÑ∏ Ï†ïÎ≥¥ -->
                    <div class="product-details">
                        <div class="detail-item">
                            <span class="detail-label">ÏÉâÏÉÅ</span>
                            <span class="detail-value" th:text="${product.productColor != null ? product.productColor : '-'}">-</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">ÏÜåÏû¨</span>
                            <span class="detail-value" th:text="${product.material != null ? product.material : '-'}">-</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Ïö©Îüâ</span>
                            <span class="detail-value" th:text="${product.capacity != null ? product.capacity : '-'}">-</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Ïû¨Í≥†</span>
                            <span class="detail-value" th:text="${product.stockQuantity} + 'Í∞ú'">0Í∞ú</span>
                        </div>
                    </div>

                    <!-- ÏÉÅÌíà ÏòµÏÖò -->
                    <div class="option-section">
                        <select id="product-options" name="optionId">
                            <option value="" disabled selected>ÏòµÏÖò ÏÑ†ÌÉù</option>

                            <!-- Í∏∞Î≥∏ ÏòµÏÖò (ÏòµÏÖòÏù¥ ÏóÜÍ±∞ÎÇò Îã®Ïùº ÏÉÅÌíàÏù∏ Í≤ΩÏö∞) -->
                            <option th:if="${#lists.isEmpty(options)}"
                                    value=""
                                    data-additional-price="0"
                                    data-option-name="Í∏∞Î≥∏"
                                    th:data-option-value="${product.productTitle}"
                                    th:text="'Í∏∞Î≥∏ : ' + ${product.productTitle}">
                            </option>

                            <!-- Ïã§Ï†ú ÏòµÏÖòÎì§ -->
                            <th:block th:each="option : ${options}">
                                <option th:value="${option.optionId}"
                                        th:data-additional-price="${option.additionalPrice}"
                                        th:data-option-name="${option.optionName}"
                                        th:data-option-value="${option.optionValue}"
                                        th:text="${option.optionName + ' : ' + option.optionValue +
                         (option.additionalPrice.compareTo(T(java.math.BigDecimal).ZERO) != 0 ?
                         ' (+' + #numbers.formatInteger(option.additionalPrice, 0, 'COMMA') + 'Ïõê)' : '')}">
                                </option>
                            </th:block>
                        </select>
                    </div>

                    <!-- ÏÑ†ÌÉùÎêú ÏòµÏÖò Î™©Î°ù -->
                    <div id="selected-options-container" class="selected-options" style="display: none;">
                        <div class="selected-options-header">
                            <span class="options-label">ÏÑ†ÌÉùÎêú ÏòµÏÖò</span>
                        </div>
                        <div id="selected-options-list" class="options-list">
                            <!-- ÏÑ†ÌÉùÎêú ÏòµÏÖòÎì§Ïù¥ Ïó¨Í∏∞Ïóê ÎèôÏ†ÅÏúºÎ°ú Ï∂îÍ∞ÄÎê©ÎãàÎã§ -->
                        </div>
                    </div>

                    <!-- Ï¥ù Í∞ÄÍ≤© -->
                    <div class="total-price-section">
                        <span class="total-price-label">Ï£ºÎ¨∏ Í∏àÏï°</span>
                        <span id="total-price" class="total-price-value" th:text="${#numbers.formatInteger(basePrice, 0, 'COMMA') + 'Ïõê'}">0Ïõê</span>
                    </div>

                    <!-- Ïï°ÏÖò Î≤ÑÌäº -->
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="addToCart(false)">Ïû•Î∞îÍµ¨Îãà Îã¥Í∏∞</button>
                        <button class="btn btn-primary" onclick="directPurchase()">Íµ¨Îß§ÌïòÍ∏∞</button>
                    </div>
                </div>
            </div>

            <!-- ÏÉÅÌíà ÏÑ§Î™Ö ÏïÑÎûò ÌÉ≠ -->
            <div class="product-tabs">
                <div class="tab-link" onclick="openTab(event, 'reviews')">
                    Î¶¨Î∑∞ <span th:text="${totalReviewCount}"></span>
                </div>
                <div class="tab-link" onclick="openTab(event, 'inquiry')">Î¨∏Ïùò</div>
            </div>

            <div id="reviews" class="tab-content">
                <div class="reviews-header">
                    <!-- Î¶¨Î∑∞ ÏöîÏïΩ ÏÑπÏÖò -->
                    <div class="review-summary">
                        <div class="rating-overview">
                            <div class="average-rating" th:text="${#numbers.formatDecimal(overallAverageRating, 1, 1)}">4.4</div>
                            <div class="stars" id="overallStars">‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ</div>
                            <!-- totalReviewCountÎ•º Í≥†Ï†ïÍ∞íÏúºÎ°ú ÌëúÏãú -->
                            <div class="review-count" th:text="|Ï¥ù ${totalReviewCount}Í∞úÏùò Î¶¨Î∑∞|">Ï¥ù 0Í∞úÏùò Î¶¨Î∑∞</div>
                        </div>
                        <a th:href="@{/product/{productId}/reviews/new(productId=${productId})}" class="write-review-btn">
                            Î¶¨Î∑∞ ÏûëÏÑ±ÌïòÍ∏∞
                        </a>
                    </div>

                    <div class="filter-container">
                        <!-- ÎìúÎ°≠Îã§Ïö¥ ÌïÑÌÑ∞ -->
                        <div class="dropdown-filters">
                            <!-- ÏÉÅÌíà ÏòµÏÖò ÏÑ†ÌÉù -->
                            <div class="filter-dropdown" th:if="${productOptions != null and !#lists.isEmpty(productOptions)}">
                                <div class="filter-label">ÏÉÅÌíà ÏòµÏÖò</div>
                                <select class="dropdown-select" id="optionFilter" name="optionId">
                                    <option value="">Ï†ÑÏ≤¥ ÏòµÏÖò</option>
                                    <option th:each="option : ${productOptions}"
                                            th:value="${option.optionId}"
                                            th:text="${option.optionName + ' - ' + option.optionValue}"
                                            th:selected="${currentOptionId != null and currentOptionId == option.optionId}">
                                    </option>
                                </select>
                            </div>

                            <!-- Î≥ÑÏ†ê Íµ¨Í∞Ñ ÏÑ†ÌÉù -->
                            <div class="filter-dropdown rating-dropdown">
                                <div class="filter-label">Î≥ÑÏ†ê</div>
                                <div class="custom-dropdown" id="ratingDropdown">
                                    <div class="dropdown-header" onclick="toggleRatingDropdown()">
                                        <span id="selectedRating">Ï†ÑÏ≤¥ Î≥ÑÏ†ê</span>
                                        <span class="dropdown-arrow">‚ñº</span>
                                    </div>
                                    <div class="dropdown-content" id="ratingDropdownContent">
                                        <div class="rating-option" data-value="" onclick="selectRating('', 'Ï†ÑÏ≤¥ Î≥ÑÏ†ê')">
                                            <span class="rating-text">Ï†ÑÏ≤¥ Î≥ÑÏ†ê</span>
                                        </div>
                                        <div class="rating-option" data-value="5" onclick="selectRating('5', '5Ï†ê')">
                                            <div class="rating-item">
                                                <span class="stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</span>
                                                <span class="rating-count" th:text="${ratingCounts != null ? ratingCounts['5'] : 0}">5,133</span>
                                            </div>
                                            <div class="rating-bar">
                                                <div class="rating-fill" th:style="'width: ' + ${ratingCounts != null and totalReviewCount > 0 ? (ratingCounts['5'] * 100.0 / totalReviewCount) : 0} + '%'"></div>
                                            </div>
                                        </div>
                                        <div class="rating-option" data-value="4" onclick="selectRating('4', '4Ï†ê')">
                                            <div class="rating-item">
                                                <span class="stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ</span>
                                                <span class="rating-count" th:text="${ratingCounts != null ? ratingCounts['4'] : 0}">511</span>
                                            </div>
                                            <div class="rating-bar">
                                                <div class="rating-fill" th:style="'width: ' + ${ratingCounts != null and totalReviewCount > 0 ? (ratingCounts['4'] * 100.0 / totalReviewCount) : 0} + '%'"></div>
                                            </div>
                                        </div>
                                        <div class="rating-option" data-value="3" onclick="selectRating('3', '3Ï†ê')">
                                            <div class="rating-item">
                                                <span class="stars">‚òÖ‚òÖ‚òÖ‚òÜ‚òÜ</span>
                                                <span class="rating-count" th:text="${ratingCounts != null ? ratingCounts['3'] : 0}">108</span>
                                            </div>
                                            <div class="rating-bar">
                                                <div class="rating-fill" th:style="'width: ' + ${ratingCounts != null and totalReviewCount > 0 ? (ratingCounts['3'] * 100.0 / totalReviewCount) : 0} + '%'"></div>
                                            </div>
                                        </div>
                                        <div class="rating-option" data-value="2" onclick="selectRating('2', '2Ï†ê')">
                                            <div class="rating-item">
                                                <span class="stars">‚òÖ‚òÖ‚òÜ‚òÜ‚òÜ</span>
                                                <span class="rating-count" th:text="${ratingCounts != null ? ratingCounts['2'] : 0}">17</span>
                                            </div>
                                            <div class="rating-bar">
                                                <div class="rating-fill" th:style="'width: ' + ${ratingCounts != null and totalReviewCount > 0 ? (ratingCounts['2'] * 100.0 / totalReviewCount) : 0} + '%'"></div>
                                            </div>
                                        </div>
                                        <div class="rating-option" data-value="1" onclick="selectRating('1', '1Ï†ê')">
                                            <div class="rating-item">
                                                <span class="stars">‚òÖ‚òÜ‚òÜ‚òÜ‚òÜ</span>
                                                <span class="rating-count" th:text="${ratingCounts != null ? ratingCounts['1'] : 0}">20</span>
                                            </div>
                                            <div class="rating-bar">
                                                <div class="rating-fill" th:style="'width: ' + ${ratingCounts != null and totalReviewCount > 0 ? (ratingCounts['1'] * 100.0 / totalReviewCount) : 0} + '%'"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Í∏∞Ï°¥ ÌÉ≠ ÌïÑÌÑ∞ -->
                        <div class="filter-tabs">
                            <a href="#" onclick="applySort('latest')" data-filter-type="sort" data-value="latest"
                               th:class="'filter-tab' + (${currentSort == 'latest' && currentFilter == 'all'} ? ' active' : '')">
                                ÏµúÏã†Ïàú
                            </a>
                            <a href="#" onclick="applySort('rating-high')" data-filter-type="sort" data-value="rating-high"
                               th:class="'filter-tab' + (${currentSort == 'rating-high' && currentFilter == 'all'} ? ' active' : '')">
                                ÌèâÏ†ê ÎÜíÏùÄÏàú
                            </a>
                            <a href="#" onclick="applyFilter('photo')" data-filter-type="filter" data-value="photo"
                               th:class="'filter-tab' + (${currentFilter == 'photo'} ? ' active' : '')">
                                ÏÇ¨ÏßÑÎ¶¨Î∑∞
                            </a>
                        </div>
                    </div>
                </div>

                <div class="review-list">
                    <!-- Î¶¨Î∑∞Í∞Ä ÏóÜÎäî Í≤ΩÏö∞ -->
                    <div th:if="${#lists.isEmpty(reviews)}" class="empty-state">
                        <div class="empty-icon">üìù</div>
                        <h3>Ï°∞Í±¥Ïóê ÎßûÎäî Î¶¨Î∑∞Í∞Ä ÏóÜÏäµÎãàÎã§</h3>
                        <p>Îã§Î•∏ ÌïÑÌÑ∞Î•º ÏÑ†ÌÉùÌï¥Î≥¥ÏÑ∏Ïöî!</p>
                    </div>

                    <!-- Î¶¨Î∑∞ Î™©Î°ù -->
                    <div th:each="review : ${reviews}"
                         th:if="${currentOptionId == null || review.optionId == currentOptionId}"
                         class="review-item">
                        <div class="review-header">
                            <div class="reviewer-info">
                                <div class="reviewer-avatar"
                                     th:text="${#strings.substring(review.userNickname,0,1)}">U</div>
                                <div>
                                    <div class="reviewer-name" th:text="${review.userNickname}">ÏÇ¨Ïö©ÏûêÎ™Ö</div>
                                    <div class="review-badges">
                                        <span th:if="${review.isVerifiedPurchase}"
                                              class="badge verified-badge">Íµ¨Îß§Ïûê</span>
                                        <span th:if="${review.isPhotoReview}"
                                              class="badge photo-badge">Ìè¨ÌÜ†Î¶¨Î∑∞</span>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <div class="review-rating">
                                    <span class="rating-stars" th:text="${review.starRating}">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</span>
                                    <span class="rating-number" th:text="${#numbers.formatInteger(review.rating, 0)}">5</span>
                                </div>
                                <div class="review-date" th:text="${review.formattedCreatedAt}">2024.01.15</div>
                            </div>
                        </div>

                        <div class="review-content" th:text="${review.content}">
                        </div>

                        <!-- ÏàòÏ†ï, ÏÇ≠Ï†ú -->
                        <div class="review-actions" th:if="${currentUserNickname == review.userNickname}">
                            <a th:href="@{/reviews/{reviewId}/edit(reviewId=${review.reviewId})}" class="btn-edit">ÏàòÏ†ï</a>
                            <form th:action="@{/reviews/{reviewId}/delete(reviewId=${review.reviewId})}" method="post">
                                <input type="hidden" name="productId" th:value="${review.productId}">
                                <button type="submit" class="btn-delete" onclick="return confirm('Ï†ïÎßêÎ°ú ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')">ÏÇ≠Ï†ú</button>
                            </form>
                        </div>

                        <!-- Î¶¨Î∑∞ Ïù¥ÎØ∏ÏßÄ (Ìè¨ÌÜ†Î¶¨Î∑∞Ïù∏ Í≤ΩÏö∞) -->
                        <div th:if="${review.isPhotoReview}" class="review-images">
                            <div th:if="${review.imageUrls != null and !#lists.isEmpty(review.imageUrls)}">
                                <img th:each="imageUrl : ${review.imageUrls}"
                                     th:src="${imageUrl}"
                                     alt="Î¶¨Î∑∞ Ïù¥ÎØ∏ÏßÄ"
                                     class="review-image">
                            </div>
                            <div th:unless="${review.imageUrls != null and !#lists.isEmpty(review.imageUrls)}">
                                <!-- ÌîåÎ†àÏù¥Ïä§ÌôÄÎçî Ïù¥ÎØ∏ÏßÄ -->
                                <img src="https://via.placeholder.com/80x80/35c5f0/white?text=üì∑"
                                     alt="Î¶¨Î∑∞ Ïù¥ÎØ∏ÏßÄ"
                                     class="review-image">
                                <img src="https://via.placeholder.com/80x80/35c5f0/white?text=üì∑"
                                     alt="Î¶¨Î∑∞ Ïù¥ÎØ∏ÏßÄ"
                                     class="review-image">
                            </div>
                        </div>
                    </div>

                    <div class="pagination" th:if="${totalPages > 1}">
                        <button th:disabled="${currentPage == 1}" onclick="goToPage(${currentPage - 1})">Ïù¥Ï†Ñ</button>
                        <span th:each="i : ${#numbers.sequence(1, totalPages)}">
                            <a th:if="${i != currentPage}" href="javascript:void(0)" th:onclick="'goToPage(' + ${i} + ')'" th:text="${i}"></a>
                            <span th:if="${i == currentPage}" th:text="${i}" style="font-weight:bold;"></span>
                        </span>
                        <button th:disabled="${currentPage == totalPages}" onclick="goToPage(${currentPage + 1})">Îã§Ïùå</button>
                    </div>

                    <!-- ÏóêÎü¨ Î©îÏãúÏßÄ -->
                    <div th:if="${error}" class="alert alert-danger" style="margin: 20px 0; padding: 15px; background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 4px; color: #721c24;">
                        <strong>Ïò§Î•ò:</strong> <span th:text="${error}"></span>
                    </div>
                </div>
            </div>

            <div id="inquiry" class="tab-content">
                <div class="qna-header-container">
                    <h3>ÏÉÅÌíà Q&A (<span th:text="${totalQuestionCount != null ? totalQuestionCount : 0}">0</span>)</h3>
                    <a th:href="@{/question/new(productId=${product.productId})}" class="btn-qna-write">ÏÉÅÌíà Î¨∏ÏùòÌïòÍ∏∞</a>
                </div>

                <div class="qna-list" th:if="${questions != null and !questions.isEmpty()}">
                    <div th:each="question : ${questions}" class="qna-item">
                        <div class="qna-title" onclick="toggleQnaContent(this)">
                            <div class="qna-title-left">
                    <span class="qna-status"
                          th:classappend="${question.questionStatus == 'ÎãµÎ≥ÄÏôÑÎ£å' ? 'answered' : 'waiting'}"
                          th:text="${question.questionStatus}"></span>
                                <span th:if="${question.isSecret}" class="secret-badge">üîí</span>
                                <span class="qna-main-title" th:text="${question.questionTitle}"></span>
                            </div>
                            <div class="qna-title-right">
                                <span class="qna-author" th:text="${#strings.substring(question.userName, 0, 1) + '**'}"></span>
                                <span class="qna-date" th:text="${#temporals.format(question.questionCreatedAt, 'yyyy.MM.dd')}"></span>
                            </div>
                        </div>

                        <div class="qna-content">
                            <div class="qna-question-content">
                                <span class="qna-label q-label">Q.</span>
                                <p th:text="${question.questionContent}"></p>
                            </div>
                        </div>
                    </div>
                </div>


                <div class="empty-state" th:unless="${questions != null and !questions.isEmpty()}">
                    <p>Îì±Î°ùÎêú Î¨∏ÏùòÍ∞Ä ÏóÜÏäµÎãàÎã§. Ï≤´ Î≤àÏß∏ Î¨∏ÏùòÎ•º ÎÇ®Í≤®Î≥¥ÏÑ∏Ïöî!</p>
                </div>

                <div class="pagination" th:if="${questionTotalPages != null and questionTotalPages > 1}">
                    <button th:disabled="${currentQuestionPage == 1}"
                            th:onclick="'goToQuestionPage(' + (${currentQuestionPage} - 1) + ')'">Ïù¥Ï†Ñ</button>

                    <th:block th:each="i : ${#numbers.sequence(1, questionTotalPages)}">
                        <a th:if="${i != currentQuestionPage}" href="javascript:void(0)"
                           th:onclick="'goToQuestionPage(' + ${i} + ')'" th:text="${i}"></a>
                        <span th:if="${i == currentQuestionPage}" th:text="${i}" style="font-weight:bold;"></span>
                    </th:block>

                    <button th:disabled="${currentQuestionPage == questionTotalPages}"
                            th:onclick="'goToQuestionPage(' + (${currentQuestionPage} + 1) + ')'">Îã§Ïùå</button>
                </div>
            </div>

            </main> <div th:replace="~{fragments/layout :: footer}"></div>

            <script th:inline="javascript">
                const GUEST_CART_KEY = 'cohouse_guest_cart_v1';
                async function addToCart(redirectToCart = false) {
                    if (selectedOptions.length === 0) {
                        alert('ÏÉÅÌíà ÏòµÏÖòÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
                        return;
                    }

                    const productInfo = document.querySelector('.product-info');
                    if (!productInfo) {
                        alert('ÏÉÅÌíà Ï†ïÎ≥¥Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
                        return;
                    }
                    const productId = parseNumber(productInfo.dataset.productId);

                    const requests = selectedOptions.map(option => {
                        const basePrice = computeBasePrice(productInfo);
                        const finalUnitPrice = Math.max(0, basePrice + option.additionalPrice);

                        const payload = buildCartPayload(productId, option.id, option.quantity);

                        return sendAddToCartRequest(payload)
                            .then(() => {
                                removeGuestCartItem(productId, option.id);
                                return { status: 'fulfilled', optionId: option.id };
                            })
                            .catch(error => {
                                if (error === 'unauthorized') {
                                    saveGuestCartItem({
                                        productId,
                                        quantity: payload.quantity,
                                        optionId: option.id,
                                        optionLabel: `${option.name}: ${option.value}`,
                                        title: productInfo.dataset.title || '',
                                        imageUrl: productInfo.dataset.imageUrl || '',
                                        finalUnitPrice,
                                        unitPrice: computeUnitPrice(productInfo),
                                        brandId: parseNumber(productInfo.dataset.brandId),
                                        brandName: productInfo.dataset.brandName || ''
                                    });
                                    return { status: 'fulfilled', optionId: option.id, guest: true };
                                }
                                return { status: 'rejected', optionId: option.id, reason: error };
                            });
                    });


                    try {
                        const results = await Promise.all(requests);
                        const failed = results.filter(r => r.status === 'rejected');

                        if (failed.length > 0) {
                            console.error('ÏùºÎ∂Ä ÏÉÅÌíàÏùÑ Ïû•Î∞îÍµ¨ÎãàÏóê Îã¥ÏßÄ Î™ªÌñàÏäµÎãàÎã§:', failed);
                            alert('ÏùºÎ∂Ä ÏÉÅÌíàÏùÑ Ïû•Î∞îÍµ¨ÎãàÏóê Îã¥Îäî Îç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§. ÌéòÏù¥ÏßÄÎ•º ÏÉàÎ°úÍ≥†Ïπ® ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.');
                            return;
                        }

                        const isGuest = results.some(r => r.guest);
                        if (isGuest) {
                            alert('Î°úÍ∑∏Ïù∏ ÌõÑ Ï£ºÎ¨∏ÌïòÎ©¥ Î≥¥Ïú† Ïø†Ìè∞Ïù¥ Ï†ÅÏö©ÎèºÏöî. Ïû•Î∞îÍµ¨ÎãàÏóê Îã¥ÏïòÏäµÎãàÎã§!');
                        } else {
                            alert('Ïû•Î∞îÍµ¨ÎãàÏóê Îã¥ÏïòÏäµÎãàÎã§!');
                        }

                        if (redirectToCart) {
                            window.location.href = '/cart';
                        }
                    } catch (error) {
                        console.error('Ïû•Î∞îÍµ¨Îãà Îã¥Í∏∞ Ï§ë ÏòàÏÉÅÏπò Î™ªÌïú Ïò§Î•ò Î∞úÏÉù:', error);
                        alert('Ïû•Î∞îÍµ¨Îãà Îã¥Í∏∞Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. Ïû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.');
                    }
                }

                function createHiddenInput(name, value) {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = name;
                    input.value = value;
                    return input;
                }


                function buildCartPayload(productId, optionId, quantity) {
                    const payload = { productId, quantity };
                    if (optionId) {
                        payload.selectedOptions = String(optionId);
                    }
                    return payload;
                }

                async function sendAddToCartRequest(body) {
                    const response = await fetch('/api/cart', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify(body)
                    });
                    if (response.ok) {
                        return;
                    }
                    if (response.status === 401 || response.status === 403) {
                        throw 'unauthorized';
                    }
                    const message = await response.text().catch(() => '');
                    throw new Error(message || 'Failed to add to cart');
                }

                function loadGuestCartItems() {
                    try {
                        const raw = localStorage.getItem(GUEST_CART_KEY);
                        if (!raw) return [];
                        const parsed = JSON.parse(raw);
                        return Array.isArray(parsed) ? parsed : [];
                    } catch (error) {
                        console.warn('Failed to parse guest cart', error);
                        return [];
                    }
                }

                function saveGuestCartItems(items) {
                    localStorage.setItem(GUEST_CART_KEY, JSON.stringify(items));
                }

                function saveGuestCartItem(item) {
                    const items = loadGuestCartItems();
                    const optionKey = item.optionId != null ? item.optionId : null;
                    const index = items.findIndex(existing => existing.productId === item.productId && normalizeOption(existing.optionId) === optionKey);

                    if (index >= 0) {
                        items[index].quantity = (items[index].quantity || 0) + item.quantity;
                        items[index].finalUnitPrice = item.finalUnitPrice;
                        items[index].updatedAt = new Date().toISOString();
                    } else {
                        items.push({ ...item, updatedAt: new Date().toISOString() });
                    }
                    saveGuestCartItems(items);
                }


                function removeGuestCartItem(productId, optionId) {
                    const optionKey = optionId != null ? optionId : null;
                    let items = loadGuestCartItems();
                    items = items.filter(item => {
                        return !(item.productId === productId && normalizeOption(item.optionId) === optionKey);
                    });
                    saveGuestCartItems(items);
                }

                function normalizeOption(value) {
                    return value == null ? null : Number(value);
                }


                // ÌÉ≠ Í∏∞Îä• ÌôúÏÑ±Ìôî Ìï®Ïàò
                function openTab(evt, tabName) {
                    var i, tabcontent, tablinks;
                    tabcontent = document.getElementsByClassName("tab-content");
                    for (i = 0; i < tabcontent.length; i++) {
                        tabcontent[i].style.display = "none";
                    }
                    tablinks = document.getElementsByClassName("tab-link");
                    for (i = 0; i < tablinks.length; i++) {
                        tablinks[i].className = tablinks[i].className.replace(" active", "");
                    }
                    document.getElementById(tabName).style.display = "block";
                    evt.currentTarget.className += " active";
                }

                // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Ï≤´ Î≤àÏß∏ ÌÉ≠ÏùÑ Í∏∞Î≥∏ÏúºÎ°ú Ïó¥Í∏∞
                document.addEventListener('DOMContentLoaded', function() {
                    const hash = window.location.hash;
                    if (window.location.hash === '#inquiry') {
                        document.querySelector('.tab-link[onclick*="inquiry"]').click();
                    } else {
                        document.querySelector('.tab-link').click();
                    }
                });

                const productId = /*[[${productId}]]*/ null;
                const currentFilter = /*[[${currentFilter}]]*/ 'all';
                const currentSort = /*[[${currentSort}]]*/ 'latest';
                const currentRatingRange = /*[[${currentRatingRange}]]*/ null;
                const currentOptionId = /*[[${currentOptionId}]]*/ null;
                const totalReviewCount = /*[[${totalReviewCount}]]*/ 0;
                const overallAverageRating = /*[[${overallAverageRating}]]*/ 0.0;

                // Î¶¨Î∑∞ Ïù¥ÎØ∏ÏßÄ ÌÅ¥Î¶≠ Ïãú ÌôïÎåÄ Î≥¥Í∏∞
                document.querySelectorAll('.review-image').forEach(img => {
                    img.addEventListener('click', () => {
                        window.open(img.src, '_blank');
                    });
                });

                // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Ï¥àÍ∏∞Ìôî
                document.addEventListener('DOMContentLoaded', () => {
                    updateOverallStars();
                    updateAverageStars();
                    initMultiOptionSystem();
                    initOptionPriceUpdater();

                    // ÎìúÎ°≠Îã§Ïö¥ Î≥ÄÍ≤Ω Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà
                    const optionFilter = document.getElementById('optionFilter');
                    if (optionFilter) {
                        optionFilter.addEventListener('change', handleFilterChange);
                    }

                    // ÎìúÎ°≠Îã§Ïö¥ Ïô∏Î∂Ä ÌÅ¥Î¶≠ Ïãú Îã´Í∏∞
                    document.addEventListener('click', function(e) {
                        if (!document.getElementById('ratingDropdown').contains(e.target)) {
                            closeRatingDropdown();
                        }
                    });

                    // ÌòÑÏû¨ ÏÑ†ÌÉùÎêú Î≥ÑÏ†ê ÌëúÏãú
                    updateSelectedRating();
                });


                // ÏÑ†ÌÉùÎêú ÏòµÏÖòÎì§ÏùÑ Ï†ÄÏû•Ìï† Î∞∞Ïó¥
                let selectedOptions = [];

                // Îã§Ï§ë ÏòµÏÖò ÏãúÏä§ÌÖú Ï¥àÍ∏∞Ìôî
                function initMultiOptionSystem() {
                    const optionsSelect = document.getElementById('product-options');

                    if (optionsSelect) {
                        optionsSelect.addEventListener('change', handleOptionSelect);
                    }

                    // Ï¥àÍ∏∞ Ï¥ù Í∞ÄÍ≤© ÏÑ§Ï†ï
                    updateTotalPrice();
                }

                // ÏòµÏÖò ÏÑ†ÌÉù Ï≤òÎ¶¨
                function handleOptionSelect() {
                    const optionsSelect = document.getElementById('product-options');
                    const selectedOption = optionsSelect.selectedOptions[0];

                    if (!selectedOption || !selectedOption.value) return;

                    const optionData = {
                        id: selectedOption.value,
                        name: selectedOption.dataset.optionName || 'ÏòµÏÖò',
                        value: selectedOption.dataset.optionValue || selectedOption.textContent,
                        additionalPrice: parseFloat(selectedOption.dataset.additionalPrice) || 0,
                        quantity: 1
                    };

                    // Ïù¥ÎØ∏ ÏÑ†ÌÉùÎêú ÏòµÏÖòÏù∏ÏßÄ ÌôïÏù∏
                    const existingIndex = selectedOptions.findIndex(opt => opt.id === optionData.id);

                    if (existingIndex >= 0) {
                        // Ïù¥ÎØ∏ ÏûàÏúºÎ©¥ ÏàòÎüâ Ï¶ùÍ∞Ä
                        selectedOptions[existingIndex].quantity += 1;
                    } else {
                        // ÏÉàÎ°úÏö¥ ÏòµÏÖò Ï∂îÍ∞Ä
                        selectedOptions.push(optionData);
                    }

                    // ÏòµÏÖò ÏÑ†ÌÉù Ï¥àÍ∏∞Ìôî
                    optionsSelect.selectedIndex = 0;

                    // UI ÏóÖÎç∞Ïù¥Ìä∏
                    renderSelectedOptions();
                    updateTotalPrice();
                }

                // ÏÑ†ÌÉùÎêú ÏòµÏÖò Î™©Î°ù Î†åÎçîÎßÅ
                function renderSelectedOptions() {
                    const container = document.getElementById('selected-options-container');
                    const optionsList = document.getElementById('selected-options-list');

                    if (selectedOptions.length === 0) {
                        container.style.display = 'none';
                        return;
                    }

                    container.style.display = 'block';
                    optionsList.innerHTML = selectedOptions.map((option, index) => {
                        // Í∞úÎ≥Ñ ÏòµÏÖòÏùò Ï¥ù Í∞ÄÍ≤©ÏùÑ Í≥ÑÏÇ∞Ìï©ÎãàÎã§.
                        const optionTotalPrice = getOptionTotalPrice(option);

                        return `
            <div class="option-item" data-option-index="${index}">
                <div class="option-name">${option.name}: ${option.value}</div>
                <div class="option-controls">
                    <div class="option-qty-price-group">
                        <div class="option-qty-container">
                            <button class="option-qty-btn" onclick="changeOptionQuantity(${index}, -1)">-</button>
                            <input class="option-qty-input" type="text" value="${option.quantity}" readonly>
                            <button class="option-qty-btn" onclick="changeOptionQuantity(${index}, 1)">+</button>
                        </div>
                        <div class="option-price">${formatCurrency(optionTotalPrice)}Ïõê</div>
                    </div>
                   <button class="remove-option-btn" onclick="removeOption(${index})" title="ÏòµÏÖò Ï†úÍ±∞">&times;</button>
            </div>
        `;
                    }).join('');
                }

                // ÏòµÏÖò ÏàòÎüâ Î≥ÄÍ≤Ω
                function changeOptionQuantity(index, delta) {
                    if (index < 0 || index >= selectedOptions.length) return;

                    const newQuantity = selectedOptions[index].quantity + delta;
                    if (newQuantity < 1) {
                        removeOption(index);
                        return;
                    }

                    selectedOptions[index].quantity = newQuantity;
                    renderSelectedOptions();
                    updateTotalPrice();
                }

                // ÏòµÏÖò ÏàòÎüâ ÏßÅÏ†ë ÏÑ§Ï†ï
                function setOptionQuantity(index, quantity) {
                    if (index < 0 || index >= selectedOptions.length) return;

                    const qty = parseInt(quantity) || 1;
                    if (qty < 1) {
                        removeOption(index);
                        return;
                    }

                    selectedOptions[index].quantity = qty;
                    renderSelectedOptions();
                    updateTotalPrice();
                }

                // ÏòµÏÖò Ï†úÍ±∞
                function removeOption(index) {
                    if (index < 0 || index >= selectedOptions.length) return;

                    selectedOptions.splice(index, 1);
                    renderSelectedOptions();
                    updateTotalPrice();
                }

                // Í∞úÎ≥Ñ ÏòµÏÖòÏùò Ï¥ù Í∞ÄÍ≤© Í≥ÑÏÇ∞
                function getOptionTotalPrice(option) {
                    const productInfo = document.querySelector('.product-info');
                    const basePrice = computeBasePrice(productInfo);
                    return (basePrice + option.additionalPrice) * option.quantity;
                }

                // Ï†ÑÏ≤¥ Ï¥ù Í∞ÄÍ≤© ÏóÖÎç∞Ïù¥Ìä∏
                function updateTotalPrice() {
                    const totalPriceElement = document.getElementById('total-price');
                    if (!totalPriceElement) return;

                    let totalPrice = 0;

                    if (selectedOptions.length === 0) {
                        // ÏòµÏÖòÏù¥ ÏÑ†ÌÉùÎêòÏßÄ ÏïäÏùÄ Í≤ΩÏö∞ Í∏∞Î≥∏ Í∞ÄÍ≤©
                        const productInfo = document.querySelector('.product-info');
                        totalPrice = computeBasePrice(productInfo);
                    } else {
                        // ÏÑ†ÌÉùÎêú Î™®Îì† ÏòµÏÖòÏùò Ï¥ùÌï©
                        totalPrice = selectedOptions.reduce((sum, option) => {
                            return sum + getOptionTotalPrice(option);
                        }, 0);
                    }

                    // null Ï≤¥ÌÅ¨ Ï∂îÍ∞Ä
                    if (totalPrice === null || totalPrice === undefined || isNaN(totalPrice)) {
                        totalPrice = 0;
                    }

                    const formatted = formatCurrency(totalPrice);
                    totalPriceElement.textContent = formatted + 'Ïõê';
                }


                // Ï†ÑÏ≤¥ Î≥ÑÏ†ê ÏóÖÎç∞Ïù¥Ìä∏ (Î≥ÄÍ≤ΩÎêòÏßÄ ÏïäÏùå)
                function updateOverallStars() {
                    const overallStarsElement = document.querySelector('#overallStars');
                    if (overallStarsElement) {
                        overallStarsElement.innerHTML = generateStars(overallAverageRating);
                    }
                }

                // Î≥ÑÏ†ê ÎìúÎ°≠Îã§Ïö¥ ÌÜ†Í∏Ä
                function toggleRatingDropdown() {
                    const header = document.querySelector('.dropdown-header');
                    const content = document.getElementById('ratingDropdownContent');

                    header.classList.toggle('open');
                    content.classList.toggle('show');
                }

                // Î≥ÑÏ†ê ÎìúÎ°≠Îã§Ïö¥ Îã´Í∏∞
                function closeRatingDropdown() {
                    const header = document.querySelector('.dropdown-header');
                    const content = document.getElementById('ratingDropdownContent');

                    header.classList.remove('open');
                    content.classList.remove('show');
                }

                // Î≥ÑÏ†ê ÏÑ†ÌÉù
                function selectRating(value, text) {
                    document.getElementById('selectedRating').textContent = text;
                    closeRatingDropdown();

                    const optionId = document.getElementById('optionFilter') ?
                        document.getElementById('optionFilter').value || null : null;

                    updateURL({
                        filter: currentFilter,
                        sort: currentSort,
                        ratingRange: value || null,
                        optionId: optionId
                    });
                }

                // ÌòÑÏû¨ ÏÑ†ÌÉùÎêú Î≥ÑÏ†ê ÌëúÏãú ÏóÖÎç∞Ïù¥Ìä∏
                function updateSelectedRating() {
                    const selectedElement = document.getElementById('selectedRating');
                    if (currentRatingRange) {
                        switch(currentRatingRange) {
                            case '5': selectedElement.textContent = '5Ï†ê'; break;
                            case '4': selectedElement.textContent = '4Ï†ê'; break;
                            case '3': selectedElement.textContent = '3Ï†ê'; break;
                            case '2': selectedElement.textContent = '2Ï†ê'; break;
                            case '1': selectedElement.textContent = '1Ï†ê'; break;
                            default: selectedElement.textContent = 'Ï†ÑÏ≤¥ Î≥ÑÏ†ê';
                        }
                    } else {
                        selectedElement.textContent = 'Ï†ÑÏ≤¥ Î≥ÑÏ†ê';
                    }
                }

                // ÌïÑÌÑ∞ Î≥ÄÍ≤Ω Ï≤òÎ¶¨
                function handleFilterChange() {
                    const optionFilter = document.getElementById('optionFilter');
                    const optionId = optionFilter ? optionFilter.value || null : null;
                    const ratingRange = currentRatingRange; // Î≥ÑÏ†êÏùÄ Ïª§Ïä§ÌÖÄ ÎìúÎ°≠Îã§Ïö¥ÏóêÏÑú Ï≤òÎ¶¨

                    updateURL({
                        filter: currentFilter,
                        sort: currentSort,
                        ratingRange: ratingRange,
                        optionId: optionId
                    });
                }

                // ÌïÑÌÑ∞ ÌÉ≠ ÌÅ¥Î¶≠
                function applyFilter(filter) {
                    const optionFilter = document.getElementById('optionFilter');
                    const optionId = optionFilter ? optionFilter.value || null : null;
                    const ratingRange = currentRatingRange;

                    document.querySelectorAll('.filter-tab').forEach(tab => {
                        tab.classList.remove('active');
                    });

                    event.currentTarget.classList.add('active');

                    updateURL({
                        filter: filter,
                        sort: 'latest',
                        ratingRange: ratingRange,
                        optionId: optionId
                    });
                }
                // Ï†ïÎ†¨ ÌÉ≠ ÌÅ¥Î¶≠
                function applySort(sort) {
                    const optionFilter = document.getElementById('optionFilter');
                    const optionId = optionFilter ? optionFilter.value || null : null;
                    const ratingRange = currentRatingRange;

                    document.querySelectorAll('.filter-tab').forEach(tab => {
                        tab.classList.remove('active');
                    });

                    event.currentTarget.classList.add('active');

                    updateURL({
                        filter: 'all',
                        sort: sort,
                        ratingRange: ratingRange,
                        optionId: optionId
                    });
                }

                // URL ÏóÖÎç∞Ïù¥Ìä∏ Î∞è ÌéòÏù¥ÏßÄ Ïù¥Îèô
                function updateURL(params) {
                    const url = new URL(window.location.href);
                    const searchParams = new URLSearchParams();

                    if (params.filter && params.filter !== 'all') {
                        searchParams.append('filter', params.filter);
                    }
                    if (params.sort && params.sort !== 'latest') {
                        searchParams.append('sort', params.sort);
                    }
                    if (params.ratingRange) {
                        searchParams.append('ratingRange', params.ratingRange);
                    }
                    if (params.optionId) {
                        searchParams.append('optionId', params.optionId);
                    }
                    if (params.page && params.page > 1) {
                        searchParams.append('page', params.page);
                    }

                    url.search = searchParams.toString();
                    url.hash = 'reviews'
                    window.location.href = url.toString();
                }

                // ÌéòÏù¥ÏßÄ Î≤ÑÌäº Ìò∏Ï∂ú Ìï®Ïàò
                function goToPage(page) {
                    const optionId = document.getElementById('optionFilter') ?
                        document.getElementById('optionFilter').value || null : null;

                    updateURL({
                        filter: currentFilter,
                        sort: currentSort,
                        ratingRange: currentRatingRange,
                        optionId: optionId,
                        page: page
                    });
                }

                // ÌïÑÌÑ∞Îêú Í≤∞Í≥ºÏùò ÌèâÍ∑† Î≥ÑÏ†ê ÏóÖÎç∞Ïù¥Ìä∏
                function updateAverageStars() {
                    const averageRatingElement = document.querySelector('.current-filter-rating'); // ÏÉàÎ°úÏö¥ ÌÅ¥ÎûòÏä§
                    const starsElement = document.querySelector('#currentFilterStars'); // ÏÉàÎ°úÏö¥ ID

                    if (averageRatingElement && starsElement) {
                        const averageRating = parseFloat(averageRatingElement.textContent);
                        if (!isNaN(averageRating)) {
                            starsElement.innerHTML = generateStars(averageRating);
                        }
                    }
                }

                // Î≥ÑÏ†ê ÏÉùÏÑ± Ìï®Ïàò
                function generateStars(rating) {
                    let stars = '';
                    for (let i = 1; i <= 5; i++) {
                        if (i <= rating) {
                            stars += '‚òÖ';
                        } else if (i - 0.5 <= rating) {
                            stars += '‚òÖ';
                        } else {
                            stars += '‚òÜ';
                        }
                    }
                    return stars;
                }

                // Î∏åÎûúÎìú ÌéòÏù¥ÏßÄ Ïù¥Îèô
                function goToBrandPage(element) {
                    const brandId = element.getAttribute('data-brand-id');
                    if (brandId && brandId !== 'null' && brandId.trim() !== '') {
                        window.location.href = '/brands/' + brandId;
                    }
                }

                // ÏòµÏÖò Í∞í Ï†ïÍ∑úÌôî
                function normalizeOption(value) {
                    return value == null ? null : Number(value);
                }

                // ÏòµÏÖò Í∞ÄÍ≤© ÏóÖÎç∞Ïù¥Ìä∏ Ï¥àÍ∏∞Ìôî
                function initOptionPriceUpdater() {
                    const productInfo = document.querySelector('.product-info');
                    const optionsSelect = document.getElementById('product-options');
                    const totalPriceElement = document.getElementById('total-price');

                    if (!productInfo || !optionsSelect || !totalPriceElement) {
                        return;
                    }

                    const basePrice = computeBasePrice(productInfo);
                    updateTotalPrice(totalPriceElement, basePrice);

                    optionsSelect.addEventListener('change', () => {
                        updateTotalPriceFromQuantity();
                    });
                }

                // ÏÑ†ÌÉùÎêú ÏòµÏÖò Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
                function resolveSelectedOption(selectEl) {
                    if (!selectEl || selectEl.selectedIndex < 0) {
                        return { optionId: null, optionLabel: '', additionalPrice: 0 };
                    }
                    const option = selectEl.selectedOptions[0];
                    if (!option || !option.value) {
                        return { optionId: null, optionLabel: '', additionalPrice: 0 };
                    }
                    return {
                        optionId: parseNumber(option.value),
                        optionLabel: (option.textContent || '').trim(),
                        additionalPrice: parseMoney(option.dataset.additionalPrice)
                    };
                }


                // Í∏∞Î≥∏ Í∞ÄÍ≤© Í≥ÑÏÇ∞
                function computeBasePrice(productInfo) {
                    if (!productInfo) return 0;

                    const values = [
                        productInfo.dataset.basePrice,
                        productInfo.dataset.salePrice,
                        productInfo.dataset.couponPrice,
                        productInfo.dataset.unitPrice
                    ];

                    for (const value of values) {
                        const amount = parseMoney(value);
                        if (amount > 0) {
                            return amount;
                        }
                    }
                    return 0;
                }

                // Îã®ÏúÑ Í∞ÄÍ≤© Í≥ÑÏÇ∞
                function computeUnitPrice(productInfo) {
                    const amount = parseMoney(productInfo.dataset.unitPrice);
                    return amount > 0 ? amount : computeBasePrice(productInfo);
                }

                // Ï¥ù Í∞ÄÍ≤© ÏóÖÎç∞Ïù¥Ìä∏
                function updatePriceDisplay(targetEl, amount) {
                    if (!targetEl) {
                        return;
                    }
                    const formatted = formatCurrency(amount);
                    targetEl.textContent = formatted + 'Ïõê';
                }

                // Í∏àÏï° ÌååÏã±
                function parseMoney(value) {
                    if (value === null || value === undefined || value === '') {
                        return 0;
                    }
                    const num = parseFloat(String(value).replace(/[^\d.-]/g, ''));
                    return Number.isFinite(num) ? num : 0;
                }

                // Ïà´Ïûê ÌååÏã±
                function parseNumber(value) {
                    const num = Number(value);
                    return Number.isFinite(num) ? num : null;
                }

                // ÌÜµÌôî Ìè¨Îß∑ÌåÖ
                function formatCurrency(value) {
                    const num = parseMoney(value);
                    if (!Number.isFinite(num)) return '0';
                    return Math.floor(num).toLocaleString('ko-KR');
                }

                window.directPurchase = function () {
                    // ÏÑ†ÌÉùÎêú ÏòµÏÖòÏù¥ ÏûàÎäîÏßÄ ÌôïÏù∏
                    if (selectedOptions.length === 0) {
                        alert('ÏÉÅÌíà ÏòµÏÖòÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
                        return;
                    }

                    const productInfo = document.querySelector('.product-info');
                    if (!productInfo) {
                        alert('ÏÉÅÌíà Ï†ïÎ≥¥Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
                        return;
                    }

                    const productId = parseInt(productInfo.dataset.productId, 10);
                    if (!productId) {
                        alert('ÏÉÅÌíà Ï†ïÎ≥¥Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
                        return;
                    }

                    // Ï£ºÎ¨∏ Ï†ïÎ≥¥Î•º formÏúºÎ°ú Ï†ÑÏÜ°
                    const form = document.createElement('form');
                    form.method = 'POST';
                    form.action = '/order/preview';

                    const basePrice = computeBasePrice(productInfo);

                    selectedOptions.forEach((option, index) => {
                        const finalUnitPrice = Math.max(0, basePrice + option.additionalPrice);

                        // orderItems[0].productId, orderItems[1].productId ...
                        form.appendChild(createHiddenInput(`orderItems[${index}].productId`, productId));
                        form.appendChild(createHiddenInput(`orderItems[${index}].productOptionId`, option.id));
                        form.appendChild(createHiddenInput(`orderItems[${index}].quantity`, option.quantity));
                        form.appendChild(createHiddenInput(`orderItems[${index}].price`, finalUnitPrice));
                    });

                    document.body.appendChild(form);
                    form.submit();
                };

                function toggleQnaContent(element) {
                    const content = element.nextElementSibling;
                    if (content.style.display === 'block') {
                        content.style.display = 'none';
                    } else {
                        content.style.display = 'block';
                    }
                }

                function goToReviewPage(page) {
                    const url = new URL(window.location.href);
                    const params = new URLSearchParams(url.search);

                    params.set('page', page);

                    params.delete('q_page');

                    url.search = params.toString();

                    url.hash = 'reviews';

                    window.location.href = url.toString();
                }

                /**
                 * Î¨∏Ïùò Î™©Î°ù ÌéòÏù¥ÏßÄ Ïù¥Îèô Ìï®Ïàò
                 */
                function goToQuestionPage(q_page) {
                    const url = new URL(window.location.href);
                    const params = new URLSearchParams(url.search);
                    params.set('q_page', q_page);
                    params.delete('page');
                    url.search = params.toString();

                    url.hash = 'inquiry';
                    window.location.href = url.toString();
                }

            </script>
</body>
</html>

